*----------------------------------------------------------------------*
*                                                                      *
*  FAGL_ACCOUNT_ITEMS_GL  Lineitems General Ledger Accounts NewGL      *
*                     ----  -       -                                  *
*                                                                      *
*                This report selects data to be displayed by ALV       *
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
* Customer              : HCL                                          *
* Project               : HCLT PASSION - SAP Implementation            *
* Copyright             : HCL                                          *
* Program Name          : ZFAGL_ACCOUNT_ITEMS_GL                       *
* Development Class     : ZFI                                          *
* Transport Request No  : HRDK973413                                   *
* Initiated by          :                                              *
* Developed by          : Sushil Sharma                                *
* Requested by          : Amit Garg                                    *
* Version No            : 1                                            *
* Program Description   : Copy of FAGL03 report having some extra      *
*                          fields in the output and sel screen         *
* Charm no              : 1100007920      tag <ss_01>                  *
************************************************************************

************************************************************************
*12.12.2016      Sushil Sharma      Addition of WBS logic as for       *
*                (Tag:SS_002)       overcoming an error                *
*                Charm: 1100007920  TR  HRDK976016                     *
************************************************************************

************************************************************************
* 07.12.2018     Yatindra/Jyotika      Addition of BU code and         *
*                                      BU description as per business  *
*                                      requirement.                    *
*                Charm: 3000000869  TR  HRDK997161                     *
************************************************************************
*----------------------------------------------------------------------*
* Change Log           : Charm no - 3000001998                         *
* Date                 : 09/09/2019                                    *
* Requester            : Suneet  Kumar                                 *
* Change by            : Seshu Nookala                                 *
* Description          : Addition of logic in document                 *
*                        type ZC,RV and YS                             *
* Change Tag           : Seshu_001                                     *
* TR Number            : HRDK9A02P0                                    *
*----------------------------------------------------------------------*
* Change Log           : Charm no - 3000002284                         *
* Date                 : 21/10/2019                                    *
* Requester            : Suneet  Kumar                                 *
* Change by            : Seshu Nookala                                 *
* Description          : Correction in WBS element Extension           *
* Change Tag           : Seshu_002                                     *
* TR Number            : HRDK9A02P0                                    *
*----------------------------------------------------------------------*
* Change Log           : Charm no - 3000002337                         *
* Date                 : 1/11/2019                                     *
* Requester            : Suneet  Kumar                                 *
* Change by            : Seshu Nookala                                 *
* Description          : Correction customer name and customer no      *
* Change Tag           : Seshu_003                                     *
* TR Number            : HRDK9A03QU                                    *
*----------------------------------------------------------------------*
* Change Log           : Charm no - 3000002365                         *
* Date                 : 07/11/2019                                    *
* Requester            : Rahul Chowdhury                               *
* Change by            : Vaishali Gaur                                 *
* Description          : Update table ZFI_FAGLL03_BI to store the P&P data*
* Change Tag           : <VAISHALI GAUR>--CH<3000002365>--TR<HRDK9A03TW>--Date<07.11.2019>*
* TR Number            : HRDK9A03TW                                    *
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
* Change Log           : Charm no - 3000003050                         *
* Date                 : 02/04/2020                                    *
* Requester            : Ramnik Ruprai                                 *
* Change by            : Seshu Nookala                                 *
* Description          : Addition of Local Currency 2 and              *
*                        Local Currency 3                              *
* Change Tag           : Seshu_004                                     *
* TR Number            : HRDK9A067E                                    *
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
* Change Log           : Charm no - 3000003298                         *
* Date                 : 28/05/2020                                    *
* Requester            : Sameer Garg                                   *
* Change by            : Shiv Manish Bajpai                            *
* Description          : Addition import& Export parameter in FM for   *
*                        Negative Sign Issue                           *
* TR Number            : HRDK9A072E                                    *
*----------------------------------------------------------------------------*
* Change Log           : Charm no - 3000003843                               *
* Date                 : 30/09/2020                                          *
* Change by            : Namita Chandra                                      *
* Description          : Added the logic for Customer not getting for few    *
*                        line items for Doc Type ZC in ZFAGLL03              *
* Changing Tag         : <Namita Chandra>--CH<S 3000003843>--TR<HRDK9A08WK>  *
*----------------------------------------------------------------------------*

REPORT fagl_account_items_gl MESSAGE-ID msitem NO STANDARD PAGE HEADING
LINE-SIZE 1023.

*... general data definitions:
*include rfitem_def.
INCLUDE zfagl_account_items_def.
INCLUDE zfin_ui_deco_include.

*... icons and symbols:
INCLUDE <list>.

TABLES: skat, skb1, bsis, admi_files.
TABLES: t001.

DATA: it_h_t001 TYPE tpit_t_vt001 WITH HEADER LINE,
      it_h_skat TYPE tpit_t_vskat WITH HEADER LINE,
      it_h_skb1 TYPE tpit_t_vskb1 WITH HEADER LINE.

" Enforce outer joins between ACDOCA and BKPF                 2857175
DATA: gd_enforce_outer_join TYPE abap_bool.
DATA: gd_au_blart          TYPE C,                             "2983368
      gd_au_gsber          TYPE C.

DATA: wa_pos_2 LIKE faglposx,    "Added by <Namita Chandra>--CH<S 3000003843>--TR<HRDK9A08WK>
      it_pos_2 LIKE faglposx OCCURS 1 WITH HEADER LINE.

* if report is called from balcance display.
DATA: gt_saknr TYPE RANGE OF ska1-saknr,
      gd_saknr LIKE LINE OF gt_saknr.
DATA:  gt_bukrs TYPE RANGE OF skb1-bukrs.                   "1530241
DATA: gt_gjahr TYPE RANGE OF bsis-gjahr,
      gd_gjahr LIKE LINE OF gt_gjahr.
DATA: gt_monat TYPE RANGE OF bsis-monat,
      gd_monat LIKE LINE OF gt_monat.
DATA: gt_yrper TYPE RANGE OF rfposx-jamon,
      gd_yrper LIKE LINE OF gt_yrper.
DATA:  gt_yrper_old TYPE RANGE OF rfposx-jamon.             "1530241
TYPES: BEGIN OF gty_acccoco,
         saknr LIKE ska1-saknr,
         bukrs LIKE skb1-bukrs,
         gvtyp LIKE ska1-gvtyp,
       END OF gty_acccoco.
DATA: gt_accoco      TYPE STANDARD TABLE OF gty_acccoco,  "PL Accounts
*      gt_accoco_bs type standard table of gty_acccoco,   "not needed
      gt_account_slt TYPE STANDARD TABLE OF gty_acccoco, "Selltlem. Acc
      gt_accoco_slt  TYPE STANDARD TABLE OF gty_acccoco,  "Sellt. PL Acc
      gd_accoco      TYPE gty_acccoco.

* new data declaration
DATA: fs_f1_icon           LIKE smp_dyntxt.
DATA: fs_f3_icon           LIKE smp_dyntxt.
DATA: fs_f4_icon           LIKE smp_dyntxt.
DATA: gv_relevant_ledger   TYPE rldnr_flex.
DATA: gv_leading_ledger    TYPE rldnr_flex.
DATA: gv_si_table          LIKE fagl_tabnames-si_table.
DATA: gv_save_si_table     LIKE fagl_tabnames-si_table.
DATA: gv_xumsav            TYPE xfeld.
DATA: gv_xerfs             TYPE xfeld.
DATA: gv_xrric             TYPE xfeld.
DATA: gv_ucomm             LIKE sy-ucomm.
DATA: gv_special_account   TYPE boolean.                    "1004374
CONSTANTS: gc_owner        TYPE gl_owner VALUE 'FAGL_BALANCE_DISPLAY',
           gc_parameter_id TYPE memoryid VALUE 'GLN_FLEX'.
DATA: gb_flex              TYPE boolean.
DATA: gb_xplacc            TYPE boolean.
DATA: gd_max_lines         TYPE nmax_it.
DATA: gd_max_pack_lines    TYPE nmax_it VALUE '50000'.      "987950
DATA: gd_cursor_open       TYPE xfeld.                      "987950
DATA: gd_xdels             TYPE xfeld.
*data: c_repid_FAGl_GL      like sy-repid  "is in DEF Include
*                                value 'FAGL_ACCOUNT_ITEMS_GL'.
DATA gt_reporting_fields   TYPE ttfieldname.
DATA gs_reporting_fields   TYPE fieldname.
DATA gt_dfies_reporting_fields TYPE dfies_table.
DATA gt_selection_part     TYPE  gusl_t_selection.
DATA gt_selection_full     TYPE  gusl_t_selection.
* migration
DATA: gb_xmig              TYPE boolean.
DATA: gb_xmig_tpara        TYPE boolean.
DATA: gb_xerfs             TYPE boolean.
DATA: gb_xuncpl            TYPE boolean.
DATA  gt_fagl_mig_001      TYPE  fagl_t_mig_001.
DATA  gs_fagl_mig_001      TYPE  fagl_s_mig_001.
DATA  gs_mig_date_2 TYPE  fagl_migdt.                       "1280800
* expiring currencies:
DATA: gd_alw_waers TYPE waers,
*     GD_ALW_FLAG          type C,
      gd_alw_date  TYPE sydatum.
*     gd_ALW_report        type sy-repid value 'SAPDBSDF'.
DATA: gt_alw_fieldlist     LIKE ddfldnam OCCURS 0 WITH HEADER LINE.
* appliction log
DATA : gt_log_handle TYPE bal_t_logh,
       gs_log_handle TYPE balloghndl,
       gs_log        TYPE bal_s_log,
       gd_xmsg       TYPE xfeld.
DATA:  gd_dummy.
DATA:  gd_xarch      TYPE xfeld.
DATA:  gd_count_arch TYPE i.
DATA:  gd_count_noauth TYPE i.                              "1511192
DATA:  l_auth                LIKE pca_i_auth.               "1649564
****************BOC By <VAISHALI GAUR>--CH<3000002365>--TR<HRDK9A03TW>--Date<07.11.2019>****
*data declaration for set
DATA: it_set TYPE TABLE OF rgsb4,
      wa_set TYPE rgsb4.
****************EOC By <VAISHALI GAUR>--CH<3000002365>--TR<HRDK9A03TW>--Date<07.11.2019>****

*... selection screen layout:
* button worklists on/off:
SELECTION-SCREEN FUNCTION KEY 1.
SELECTION-SCREEN FUNCTION KEY 2.
SELECTION-SCREEN FUNCTION KEY 3.
SELECTION-SCREEN FUNCTION KEY 4.
* selections for processing of worklists:
SELECTION-SCREEN BEGIN OF BLOCK glaccount WITH FRAME TITLE TEXT-w02.
PARAMETERS: pa_wlsak LIKE rf42b-idnts MODIF ID wkl.
SELECT-OPTIONS: so_wlsak FOR skb1-saknr MODIF ID wkl NO DATABASE
SELECTION.
SELECTION-SCREEN END OF BLOCK glaccount.
SELECTION-SCREEN BEGIN OF BLOCK company WITH FRAME TITLE TEXT-w03.
PARAMETERS: pa_wlbuk LIKE rf42b-idntb MODIF ID wkl.
SELECT-OPTIONS: so_wlbuk FOR skb1-bukrs MODIF ID wkl NO DATABASE
SELECTION.
SELECTION-SCREEN END OF BLOCK company.

* outer frame for item selection:
SELECTION-SCREEN BEGIN OF BLOCK items WITH FRAME TITLE TEXT-007.
* inner frame 1:
SELECTION-SCREEN BEGIN OF BLOCK status WITH FRAME TITLE TEXT-002.
*   open items:
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS x_opsel LIKE itemset-xopsel RADIOBUTTON GROUP rad1
                                                   DEFAULT 'X'.
SELECTION-SCREEN COMMENT 3(20) TEXT-003 FOR FIELD x_opsel.
SELECTION-SCREEN END OF LINE.
PARAMETERS pa_stida LIKE rfpdo-allgstid DEFAULT sy-datlo.
SELECTION-SCREEN SKIP.
*   cleared items:
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS x_clsel LIKE itemset-xclsel RADIOBUTTON GROUP rad1.
SELECTION-SCREEN COMMENT 3(25) TEXT-004 FOR FIELD x_clsel.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS so_augdt FOR bsis-augdt NO DATABASE SELECTION.
PARAMETERS pa_stid2 LIKE rfpdo-allgstid.
SELECTION-SCREEN SKIP.
*   all items:
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS x_aisel LIKE itemset-xaisel RADIOBUTTON GROUP rad1.
SELECTION-SCREEN COMMENT 3(20) TEXT-005 FOR FIELD x_aisel.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS so_budat FOR bsis-budat NO DATABASE SELECTION.
SELECTION-SCREEN END OF BLOCK status.

*begin of addition by sushil ss_001


SELECTION-SCREEN BEGIN OF BLOCK date WITH FRAME TITLE TEXT-010.

PARAMETER : p_budat TYPE budat.

SELECTION-SCREEN END OF BLOCK date.

*end of addition

* inner frame 2:
SELECTION-SCREEN BEGIN OF BLOCK type WITH FRAME TITLE TEXT-006.
*SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: x_norm LIKE itemset-xnorm AS CHECKBOX DEFAULT 'X'
                                                MODIF ID efs.
*SELECTION-SCREEN COMMENT 03(28) TEXT-101 for field x_norm.
*SELECTION-SCREEN POSITION POS_HIGH.
PARAMETERS: x_erfs LIKE rfpdo3-allgerfs NO-DISPLAY..
*SELECTION-SCREEN COMMENT 61(20) TEXT-102 for field x_erfs.
*SELECTION-SCREEN END OF LINE.
PARAMETERS: x_shbv LIKE itemset-xshbv NO-DISPLAY,
            x_merk LIKE itemset-xmerk AS CHECKBOX MODIF ID efs,
            x_park LIKE itemset-xpark AS CHECKBOX MODIF ID efs,
            x_apar LIKE itemset-xarit NO-DISPLAY.
*...parameter for ledger
PARAMETERS
       rldnr TYPE faglflext-rldnr MODIF ID gls.
*...parameter for carry forward postings
PARAMETERS x_glyec TYPE xfeld MODIF ID gly.

SELECTION-SCREEN END OF BLOCK type.
* end of inner frames.
SELECTION-SCREEN END OF BLOCK items.
* end of outer frame.
* list layout frame:
SELECTION-SCREEN BEGIN OF BLOCK list WITH FRAME TITLE TEXT-001.
PARAMETERS: pa_bwber LIKE rfpdo3-allgbwbe NO-DISPLAY.
PARAMETERS: pa_vari TYPE slis_vari,
            pa_nmax LIKE itemset-nmax.
SELECTION-SCREEN END OF BLOCK list.
*... end of selection screen layout.

*... dark parameters:
* branch: read items posted on central office? (not used for GL)
*   Values: (Y)es, (N)o, ( ) prompt user
PARAMETERS: pa_cent TYPE c NO-DISPLAY.
* net due date selection:
SELECT-OPTIONS so_faedt FOR it_pos-faedt NO-DISPLAY.
* combined fiscal year/posting period
DATA:           gp_yrper TYPE rwcoom-fiscper.
SELECT-OPTIONS: so_yrper FOR gp_yrper NO-DISPLAY.
* internet transaction mode?
PARAMETERS: pa_inet TYPE c NO-DISPLAY.
* grid control display?
*   Values: (Y)es, (N)o, ( ) get parameter
PARAMETERS: pa_grid TYPE c NO-DISPLAY.

*... include internal select-options for derived item fields:
INCLUDE zrfitem_sel.

*...parameter for ledger
*PARAMETERS
*      rldnr TYPE faglflext-rldnr NO-DISPLAY.
PARAMETER:

           fs_dyns TYPE rsds_type NO-DISPLAY,
           fs_num LIKE sy-tfill   NO-DISPLAY,
           fs_field TYPE rsdsfields_t NO-DISPLAY.

*begin of addition - dinakaran - performance opt
SELECTION-SCREEN BEGIN OF BLOCK output WITH FRAME TITLE TEXT-011.
PARAMETERS:rb_alv  TYPE char1 RADIOBUTTON GROUP grp1 DEFAULT 'X' USER-COMMAND ucomm,
           rb_upd  TYPE char1 RADIOBUTTON GROUP grp1,
           p_runid TYPE zde_runid,
           rb_app  TYPE char1 RADIOBUTTON GROUP grp1.
PARAMETERS:p_appl TYPE rlgrap-filename DEFAULT '/tmp/ZFAGLL03.txt'.
SELECTION-SCREEN END OF BLOCK output.
*end   of addition - dinakaran - performance opt
DATA g_uname TYPE syst_uname.
SELECT-OPTIONS: r_uname FOR g_uname NO-DISPLAY."added 07.11.2019

INITIALIZATION.

  PERFORM deco_at_initialization.

  IF idtimeacc_cl_switch_check=>filoc_time_acc_sfws_01( ) EQ 'X'.
*   Free Date In Memory
    idtimeacc_cl_utils=>free_date_memory( ).
  ENDIF. " Note 1731392 - 19-JUN-2012

*&---------------------------------------------------------------------*
*&      Form  deco_at_initialization
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_initialization.

*  G_REPID  = SY-REPID.  " commented by sushil 26 04 16
  g_repid  = 'FAGL_ACCOUNT_ITEMS_GL'. " added by sushil 26 04 16
  sd_noaut = 'X'.
  sd_nooap = 'X'.
  gd_save_title = sy-title.
  CLEAR gd_rri_so_set.                                      "1093945

* PROGRAM CAN ONLY BE USED IF NEW G/L IS ACTIVATED
* erstezen durch FB ob mindestens 1 BUKRS FlexGL aktiv hat
* bei AT Selection Screen dann konkret die eingegebenen
* Bukrs prÃ¼fen
  CALL FUNCTION 'FAGL_CHECK_GLFLEX_ACTIVE'
    IMPORTING
      e_glflex_active = gb_flex.

* if not check, if new G/L is active at least in one
* company code
  IF gb_flex NE 'X'.
    CALL FUNCTION 'FAGL_BUKRS_ACTIVE_IN_CLIENT'
      IMPORTING
        e_glflex_active = gb_flex.
  ENDIF.

* Moved here, so also if NewG/L is not active in migration,
* the FAGLL03 can be used (even in NewG/L view)
  GET PARAMETER ID 'FAGL_MIG_FAGLL03' FIELD gb_xmig_tpara.  "1701675
  IF gb_flex IS INITIAL AND gb_xmig_tpara IS INITIAL.       "1701675
    IF cl_fin_ui_deco=>mv_mode = abap_false.
      MESSAGE w866(fr) WITH 'FBL3N'.
      LEAVE TO TRANSACTION 'FBL3N'.
    ELSE.
      deco_message_1 e866(fr) with 'FBL3N'.
    ENDIF.
  ENDIF.
* expiring currencies:
  PERFORM init_expcur.
* deactivate user commands:
* perform change_status.
  PERFORM change_status.
* initialize worklist button:
  PERFORM wl_flag_and_button.
* set account and company code:
  PERFORM set_acct_and_ccode.

* find relevant ledger
* IF sy-slset EQ space                          "796813
*  if rldnr is initial.
  PERFORM find_relevant_ledger
          CHANGING gv_relevant_ledger.
*  else.
*    gv_relevant_ledger = rldnr.
*  endif.
  PERFORM find_si_table
          USING    gv_relevant_ledger
          CHANGING gv_si_table.
  PERFORM get_leading_ledger
          CHANGING gv_leading_ledger.

* rri
  PERFORM init_rri_data.

  rldnr = gv_relevant_ledger.

* get T021S and make field administration tables:
  PERFORM init_admin_tables.
* make field catalog, exclude all unnecessary fields:
* perform make_fieldcatalog.
* prepare KKBER currency lookup table:
* perform init_kkcurr_table.
* get parameters:
  PERFORM get_general_param.
  IF NOT gv_xrric IS INITIAL.
    IF NOT gv_relevant_ledger IS INITIAL.
      CLEAR x_erfs.
      CLEAR x_merk.
      CLEAR x_park.
    ENDIF.
  ENDIF.
** set account and company code:
*  perform set_acct_and_ccode.
* set fields for transfer prices
  PERFORM insert_tp_fields.
* check if BADIs are active
  PERFORM check_badi_active.

* set title
  CLEAR gd_title.
  IF x_erfs IS INITIAL.
    CONCATENATE gd_save_title TEXT-277 INTO gd_title
    SEPARATED BY space.
  ELSE.
    CONCATENATE gd_save_title TEXT-278 INTO gd_title
    SEPARATED BY space.
  ENDIF.
  SET TITLEBAR gc_title WITH gd_title.

ENDFORM.                    "deco_at_initialization

AT SELECTION-SCREEN OUTPUT.

  PERFORM deco_at_sel_screen_output.

*begin of addition - dinakaran - performance opt
  LOOP AT SCREEN.
    CASE screen-name.
      WHEN 'P_APPL'.
        IF rb_app NE 'X'.
          screen-input = 0.
          screen-invisible = 1.
        ELSE.
          screen-input = 1.
          screen-invisible = 0.
        ENDIF.
        MODIFY SCREEN.
      WHEN '%_P_APPL_%_APP_%-TEXT'.
        IF rb_app NE 'X'.
          screen-input = 0.
          screen-invisible = 1.
        ELSE.
          screen-input = 1.
          screen-invisible = 0.
        ENDIF.
        MODIFY SCREEN.
      WHEN 'P_RUNID'.
        IF rb_upd NE 'X'.
          screen-input = 0.
          screen-invisible = 1.
        ELSE.
          screen-input = 1.
          screen-invisible = 0.
        ENDIF.
        MODIFY SCREEN.
      WHEN '%_P_RUNID_%_APP_%-TEXT'.
        IF rb_upd NE 'X'.
          screen-input = 0.
          screen-invisible = 1.
        ELSE.
          screen-input = 1.
          screen-invisible = 0.
        ENDIF.
        MODIFY SCREEN.
    ENDCASE.
  ENDLOOP.
*end   of addition - dinakaran - performance opt
*&---------------------------------------------------------------------*
*&      Form  deco_at_sel_screen_output
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_sel_screen_output.
* check for "suppress dialog":
  gd_dynp_fun = 7.
  gd_dynp_val = 1.
  PERFORM dynp_get_status USING    gd_dynp_fun
                          CHANGING gd_dynp_val.
  LOOP AT SCREEN.
    PERFORM wl_modify_screen.
    MODIFY SCREEN.
  ENDLOOP.

* icon freie selection
  PERFORM fs_set_sscrtexts_dynsel CHANGING fs_f1_icon.
  sscrfields-functxt_01 = fs_f1_icon.

* new GL or Entry view
  IF NOT x_erfs IS INITIAL
  OR NOT x_merk IS INITIAL
  OR NOT x_park IS INITIAL.
    gv_xerfs = 'X'.
  ELSE.
    CLEAR gv_xerfs.
  ENDIF.

*  if gv_xerfs is initial.
*    sscrfields-functxt_04 = text-278.
*  else.
*    sscrfields-functxt_04 = text-277.
*  endif.
  PERFORM fs_set_sscrtexts_dynsel4 CHANGING fs_f4_icon.
  sscrfields-functxt_04 = fs_f4_icon.

  LOOP AT SCREEN.
    PERFORM erfs_modify_screen.
    PERFORM glyec_modify_screen.                            "1779180
    MODIFY SCREEN.
  ENDLOOP.

* set ledger if in Report Variant
  IF  rldnr NE gv_relevant_ledger
  AND gv_xerfs IS INITIAL.
    gv_relevant_ledger = rldnr.
    PERFORM find_si_table
            USING    gv_relevant_ledger
            CHANGING gv_si_table.
  ENDIF.

* deactivate user commands:
  PERFORM change_status.

* set title
  CLEAR gd_title.
  IF gv_xerfs IS INITIAL.
    CONCATENATE gd_save_title TEXT-277 INTO gd_title
    SEPARATED BY space.
  ELSE.
    CONCATENATE gd_save_title TEXT-278 INTO gd_title
    SEPARATED BY space.
  ENDIF.
  SET TITLEBAR gc_title WITH gd_title.

ENDFORM.                    "deco_at_sel_screen_output

AT SELECTION-SCREEN ON BLOCK glaccount.

  PERFORM deco_at_sel_screen_glaccount.

*&---------------------------------------------------------------------*
*&      Form  deco_at_sel_screen_glaccount
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_sel_screen_glaccount.

  IF NOT gd_wl_on IS INITIAL.        " worklists on >
    IF gd_dynp_val EQ 0.             " rebuild sd_bukrs and sd_saknr >
*       GL accounts:
      REFRESH sd_saknr.
      IF NOT pa_wlsak IS INITIAL.    " account worklist given >
        PERFORM resolve_worklist TABLES gt_cosel
                                 USING  pa_wlsak
                                        'SAKNR'.
*         worklist overrides account select-option:
        REFRESH so_wlsak.
        CLEAR so_wlsak.
        LOOP AT gt_cosel.
          MOVE-CORRESPONDING gt_cosel TO sd_saknr.
          APPEND sd_saknr.
        ENDLOOP.
      ELSE.
        APPEND LINES OF so_wlsak TO sd_saknr.
      ENDIF.                         " account worklist given <
    ENDIF.                           " rebuild sd_bukrs and sd_saknr <
  ENDIF.                             " worklists on <

ENDFORM.                    "deco_at_sel_screen_glaccount

AT SELECTION-SCREEN ON BLOCK company.

  PERFORM deco_at_sel_screen_company.

*&---------------------------------------------------------------------*
*&      Form  deco_at_sel_screen_company
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_sel_screen_company.

  IF NOT gd_wl_on IS INITIAL.        " worklists on >
    IF gd_dynp_val EQ 0.             " rebuild sd_bukrs and sd_saknr >
*       company codes:
      REFRESH sd_bukrs.
      IF NOT pa_wlbuk IS INITIAL.    " ccode worklist given >
        PERFORM resolve_worklist TABLES gt_cosel
                                 USING  pa_wlbuk
                                        'BUKRS'.
*         worklist overrides company code select-option:
        REFRESH so_wlbuk.
        CLEAR so_wlbuk.
        LOOP AT gt_cosel.
          MOVE-CORRESPONDING gt_cosel TO sd_bukrs.
          APPEND sd_bukrs.
        ENDLOOP.
      ELSE.
        APPEND LINES OF so_wlbuk TO sd_bukrs.
      ENDIF.                         " ccode worklist given <
    ENDIF.                           " rebuild sd_bukrs and sd_saknr <
  ENDIF.                             " worklists on <

ENDFORM.                    "deco_at_sel_screen_company

AT SELECTION-SCREEN.

  PERFORM deco_at_sel_screen.

*&---------------------------------------------------------------------*
*&      Form  deco_at_sel_screen
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_sel_screen.

* checks for activation per comp code
  DATA lt_t001 TYPE TABLE OF t001.
  DATA ls_t001 TYPE t001.
  DATA l_yrper LIKE gp_yrper.                               "1020575
  DATA l_gjahr LIKE bkpf-gjahr.                             "1020575
  DATA l_poper LIKE t009b-poper.                            "1020575

  IF ( x_merk IS INITIAL
  AND x_park IS INITIAL
  AND x_erfs IS INITIAL ).
    IF sy-ucomm NE 'FC04'.
      SELECT * FROM t001 INTO TABLE lt_t001 WHERE bukrs IN sd_bukrs.
      LOOP AT lt_t001 INTO ls_t001.
* check at PAI, if NewGL is active for the selected company codes.
        CALL FUNCTION 'FAGL_CHECK_GLFLEX_ACTIVE'
          EXPORTING
            id_bukrs        = ls_t001-bukrs
          IMPORTING
            e_glflex_active = gb_flex.
        IF gb_flex NE 'X' AND gb_xmig_tpara IS INITIAL.     "1701675
*         MESSAGE w026(FAGL_ACCOUNT_BALANCE) WITH ls_t001-bukrs.
          x_erfs = 'X'.
          deco_message_1 i100 with ls_t001-bukrs.
          EXIT. "#EC CI_NOORDER for Hana Migration <VIKAS> Charm - 1100008668   TR -HRDK979834
*     LEAVE TO TRANSACTION 'FBL3N'.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDIF.

* set flag for normal items
  IF NOT x_merk IS INITIAL
  OR NOT x_park IS INITIAL.
    IF NOT x_norm IS INITIAL.
      x_erfs = 'X'.
    ENDIF.
  ENDIF.
*  if x_norm is initial.
*    clear x_erfs.
*  endif.

* deactivate user commands:
  PERFORM change_status.

* checks for migration
  CALL FUNCTION 'FAGL_MGPLN_IN_CLIENT'
    IMPORTING
      e_migpln_exist = gb_xmig.

  CLEAR gb_xerfs.
  CLEAR gb_xuncpl.
  IF ( NOT gb_xmig IS INITIAL
  AND x_erfs IS INITIAL
  AND x_merk IS INITIAL
  AND x_park IS INITIAL ).
*    clear gb_xerfs.
*    clear gb_Xuncpl.
    IF  sy-ucomm NE 'FC04'.
      CLEAR gb_xerfs.
      CLEAR gb_xuncpl.
      REFRESH gt_fagl_mig_001.
      LOOP AT lt_t001 INTO ls_t001.
        REFRESH gt_fagl_mig_001.
        CALL FUNCTION 'FAGL_GET_ACTIVE_MGPLN'
          EXPORTING
            i_bukrs             = ls_t001-bukrs
            i_rldnr             = gv_relevant_ledger
          IMPORTING
*           ET_FAGL_MIG_002     =
            et_fagl_mig_001     = gt_fagl_mig_001
*           EF_ACTIVE_MGPLN     =
          EXCEPTIONS
            invalid_input       = 1
            no_data_found       = 2
            invalid_customizing = 3
            OTHERS              = 4.
        DELETE gt_fagl_mig_001 WHERE mg_typ = '04'.         "1294930
        DELETE gt_fagl_mig_001 WHERE mg_typ = '05'.         "1502414
        READ TABLE gt_fagl_mig_001                          "1294930
                      INTO gs_fagl_mig_001 INDEX 1.         "1294930

        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ELSEIF sy-subrc = 0 AND NOT gb_xmig_tpara IS INITIAL.
          deco_message_0 i125.
*         One message is enough                                "1858736
          EXIT. "#EC CI_NOORDER for Hana Migration <VIKAS> Charm - 1100008668   TR -HRDK979834
        ELSE.
          SORT gt_fagl_mig_001 BY mg_end.
          LOOP AT gt_fagl_mig_001 INTO gs_fagl_mig_001
            WHERE mg_end NE space.
            EXIT. "#EC CI_NOORDER for Hana Migration <VIKAS> Charm - 1100008668   TR -HRDK979834
          ENDLOOP.
          IF sy-subrc NE 0.
            gb_xerfs = 'X'.
          ELSE.
            IF NOT x_opsel IS INITIAL.
              IF pa_stida LT gs_fagl_mig_001-migdt.
                gb_xerfs = 'X'.
              ENDIF.
            ENDIF.
            IF NOT x_clsel IS INITIAL.
              IF  NOT pa_stid2 IS INITIAL
              AND pa_stid2 LT gs_fagl_mig_001-migdt.
                gb_xerfs = 'X'.
              ELSE.
                CLEAR gs_mig_date_2.                        "1280800
                gs_mig_date_2 = gs_fagl_mig_001-migdt - 1.  "1280800
                IF gs_mig_date_2 IN so_augdt.               "1280800
                  gb_xuncpl = 'X'.
                ELSE.
                  LOOP AT so_augdt.
                    IF so_augdt-low LT gs_fagl_mig_001-migdt.
                      gb_xuncpl = 'X'.
                    ENDIF.
                  ENDLOOP.
                ENDIF.
              ENDIF.
            ENDIF.
            IF NOT x_aisel IS INITIAL.
              CLEAR gs_mig_date_2.                          "1280800
              gs_mig_date_2 = gs_fagl_mig_001-migdt - 1.    "1280800
              IF gs_mig_date_2 IN so_budat.                 "1280800
                gb_xuncpl = 'X'.
              ELSE.
                LOOP AT so_budat.
                  IF so_budat-low LT gs_fagl_mig_001-migdt.
                    gb_xuncpl = 'X'.
                  ENDIF.
                ENDLOOP.
              ENDIF.
            ENDIF.
* Special case if the FAGLL03 is called over the RRI           "1020575
            IF sy-calld = 'X'.
              DATA ld_xmo16 TYPE boole VALUE 'X'.           "1460960
              IF NOT so_yrper[] IS INITIAL.
                CLEAR gb_xuncpl.
                CLEAR gs_mig_date_2.                        "1303526
                gs_mig_date_2 = gs_fagl_mig_001-migdt - 1.  "1303526
                CALL FUNCTION 'FI_PERIOD_DETERMINE'
                  EXPORTING
                    i_budat = gs_mig_date_2                 "1303526
                    i_bukrs = ls_t001-bukrs
                    i_rldnr = gv_relevant_ledger
                    x_xmo16 = ld_xmo16                      "1460960
                  IMPORTING
                    e_gjahr = l_gjahr
                    e_poper = l_poper.
                CONCATENATE l_gjahr l_poper INTO l_yrper.
                LOOP AT so_yrper.
                  IF so_yrper-low LE l_yrper.
                    gb_xuncpl = 'X'.
                  ENDIF.
                ENDLOOP.
              ENDIF.
            ENDIF.
* Special case if the FAGLL03 is called over the RRI           "1020575
          ENDIF.
        ENDIF.
      ENDLOOP.
      IF NOT gb_xerfs IS INITIAL
      AND ( ( x_erfs IS INITIAL AND sy-ucomm NE 'FC04' )
      OR  ( NOT x_erfs IS INITIAL AND sy-ucomm = 'FC04' ) ).
        x_erfs = 'X'.
        gv_xerfs = 'X'.
        deco_message_0 i105.
      ENDIF.
*    if not gb_xuncpl is initial.
*      message i106.
*    endif.
    ENDIF.
  ENDIF.

  CASE sy-ucomm.
*...freeselection
    WHEN 'FC01'.
      PERFORM free_selections.

*...switch worklist on or off:
    WHEN 'FC02'.
      PERFORM worklist_on_off.
      PERFORM set_acct_and_ccode.

*...Ledger choice
    WHEN 'FC03'.
      IF  x_merk IS INITIAL
      AND x_park IS INITIAL
      AND x_erfs IS INITIAL.
        DATA: BEGIN OF gt_chosen_values OCCURS 0.
                INCLUDE STRUCTURE sval.
              DATA: END OF gt_chosen_values.
        DATA lv_new_ledger TYPE rldnr_flex.
        CLEAR lv_new_ledger.

        PERFORM choose_ledger
                     TABLES gt_chosen_values
                     USING gv_relevant_ledger
                     CHANGING lv_new_ledger.

        IF lv_new_ledger NE gv_relevant_ledger.
*        REFRESH lt_modif_id.

          gv_relevant_ledger = lv_new_ledger.
          rldnr = lv_new_ledger.                            "796813

* Check free selections if still applyable for
* the new ledger. If not delete the NewGL lineitem
* Selections. Change fs_num and button for dyn. sel.
          gv_save_si_table = gv_si_table.
          PERFORM find_si_table
            USING    gv_relevant_ledger
            CHANGING gv_si_table.
          IF gv_save_si_table NE gv_si_table.
            CLEAR gd_xdels.
            PERFORM del_free_selections_si_tab CHANGING gd_xdels.
            IF NOT gd_xdels IS INITIAL.
              deco_message_0 i102.
            ENDIF.
          ELSE.
            PERFORM check_reporting_fields.
          ENDIF.
        ENDIF.
      ENDIF.
*...switch NewGL on or off:
    WHEN 'FC04'.
      PERFORM erfs_on_off.
      IF NOT gv_xerfs IS INITIAL.
        gv_save_si_table = gv_si_table.
        CLEAR gd_xdels.
        PERFORM del_free_selections_si_tab CHANGING gd_xdels.
        IF NOT gd_xdels IS INITIAL.
          deco_message_0 i101.
        ENDIF.
      ELSE.
        CLEAR x_erfs.
        CLEAR x_merk.
        CLEAR x_park.
        x_norm = 'X'.
      ENDIF.
** set title
*  clear gd_title.
*  if gv_xerfs is initial.
*       concatenate gd_save_title text-277 into gd_title
*     separated by space.
*   else.
*     concatenate gd_save_title text-278 into gd_title
*     separated by space.
*  endif.
*  SET TITLEBAR gc_title with gd_title.
*...process worklists and check selections:
    WHEN 'ONLI' OR 'PRIN' OR 'INIT' OR space.
      CALL FUNCTION 'BUKRS_AUTHORITY_CHECK'
        EXPORTING
          xdatabase = 'S'
        TABLES
          xbukreis  = sd_bukrs.
      CALL FUNCTION 'BUKRS_AUTHORITY_CHECK'
        EXPORTING
          xdatabase = 'B'
        TABLES
          xbukreis  = sd_bukrs.
*     check input:
      PERFORM sel_account_check.
*     check date (tpc)
      PERFORM check_date TABLES sd_bukrs
                         USING  sd_tpc.
**     check auth ledger
*      if  x_erfs is initial
*      and x_merk is initial
*      and x_park is initial.
*        perform check_auth_ledger.
*      endif.

*     message because of migration
      IF sy-ucomm = 'ONLI'
      OR sy-ucomm = 'PRIN'.
        IF NOT gb_xuncpl IS INITIAL.
          deco_message_0 i106.
        ENDIF.
      ENDIF.
  ENDCASE.

* check Ledger for newGL
  IF  NOT gv_relevant_ledger IS INITIAL
  AND gv_xerfs IS INITIAL.
    CALL FUNCTION 'FAGL_CHECK_IF_LEDGER_IS_GLFLEX'
      EXPORTING
        i_rldnr          = gv_relevant_ledger
      EXCEPTIONS
*       NOT_FOUND        = 1
        no_glflex_ledger = 2
*       GLFLEX_ROLLUP_LEDGER    = 3
*       WRONG_APPLICATION       = 4
*       GLFLEX_DEPENDENT_LEDGER = 5
*       OTHERS           = 6
      .
    IF sy-subrc <> 0.
      deco_message_1 e108 with gv_relevant_ledger.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

*   check auth ledger
    IF  x_erfs IS INITIAL
    AND x_merk IS INITIAL
    AND x_park IS INITIAL.
      PERFORM check_auth_ledger.
    ENDIF.
  ENDIF.

  gv_ucomm = sscrfields-ucomm.

ENDFORM.                    "deco_at_sel_screen

AT SELECTION-SCREEN ON BLOCK type.

  PERFORM deco_at_sel_screen_type.

*&---------------------------------------------------------------------*
*&      Form  deco_at_sel_screen_type
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_sel_screen_type.

* check item type only when action = execute:
  IF sy-ucomm = 'ONLI'.
    PERFORM sel_type_check.
  ENDIF.

ENDFORM.                    "deco_at_sel_screen_type

AT SELECTION-SCREEN ON VALUE-REQUEST FOR pa_vari.
  PERFORM alv_variant_f4 CHANGING pa_vari.
*begin of addition - dinakaran - performance opt
AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_appl.
  PERFORM f_application_server_file_f4 USING p_appl.

*&---------------------------------------------------------------------*
*&      Form  f_application_server_file_f4
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM f_application_server_file_f4 USING iv_file TYPE localfile.

  CALL FUNCTION '/SAPDMC/LSM_F4_SERVER_FILE'
    IMPORTING
      serverfile       = iv_file
    EXCEPTIONS
      canceled_by_user = 1
      OTHERS           = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    "df_application_server_file_f4
*end   of addition - dinakaran - performance opt
*** start of selection
START-OF-SELECTION.

  PERFORM deco_at_selection_start.

GET skb1.

  PERFORM deco_at_selection_get.

END-OF-SELECTION.
  PERFORM deco_at_end_of_selection.
  PERFORM deco_at_output_alv.


*&---------------------------------------------------------------------*
*&      Form  deco_at_selection_start
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_selection_start.
***
  IF gd_rri_so_set = 'X'.                                   "1093945
    IMPORT so_yrper FROM MEMORY ID 'FAGLL03_SO_YRPER'.      "1093945
  ENDIF.                                                    "1093945

  CLEAR: x_stop.
  gd_max_lines = pa_nmax.
  CLEAR: gd_count_arch, gd_count_noauth.                    "1511192

* check accounts according to the selections
  IF NOT x_merk IS INITIAL
  OR NOT x_park IS INITIAL
  OR NOT x_erfs IS INITIAL.
    CLEAR gv_relevant_ledger.
    CLEAR gv_si_table.
  ENDIF.

* set B0SG fields
  IF NOT x_erfs IS INITIAL.
    CLEAR x_glyec.
    IF x_norm <> space.
      b0sg-xstan = 'X'.
    ELSE.
      b0sg-xstan = ' '.
    ENDIF.

    IF x_merk <> space.
      b0sg-xstas = 'X'.
    ENDIF.

    IF x_park <> space.
      b0sg-xstav = 'X'.
    ENDIF.
  ENDIF.

* set parameters:
  PERFORM set_parameters.

* map selections to LDB logic:
* perform map_sel_to_ldb.

* set dynamic selections of Log. Database according to the dyn.
* selections of this programm for SKA1 and SKB1
  PERFORM set_dyn_sel_ldb.

* map selections to lineitem selection logic:
  PERFORM map_sel_to_items USING gb_xplacc
                           CHANGING gt_selection_part.

  PERFORM check_selections USING gt_selection_part.         "1578577

* make field catalog, exclude all unnecessary fields:
  PERFORM make_fieldcatalog.

* determine company codes which use transfer prices
  SELECT * FROM t001a INTO TABLE it_tp_auth WHERE bukrs IN sd_bukrs.
  LOOP AT it_tp_auth.
    IF it_tp_auth-curtp+1(1) = '1' OR it_tp_auth-curtp+1(1) = '2'
      OR it_tp_auth-curtp2+1(1) = '1' OR it_tp_auth-curtp2+1(1) = '2'.
    ELSE.
      DELETE it_tp_auth.
    ENDIF.
  ENDLOOP.
* check tp authority and set 'tech'-attribute if authority is missing
  PERFORM make_fieldcatalog2.

* check selections against accounttypes
* perform check_sel_for_acctype. -> see get skb1

* determine settllement accounts
  PERFORM setlmnt_accounts.

* if report called from balance display:
* Exclude PL accounts now (will be included later).
  PERFORM exclude_pl_accounts.

* create appl log
  PERFORM create_log.

ENDFORM.                    "deco_at_selection_start

*&---------------------------------------------------------------------*
*&      Form  deco_at_selection_get
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_selection_get.
* check accounts according to the selections
  IF  x_merk IS INITIAL
  AND x_park IS INITIAL
  AND x_erfs IS INITIAL.
*   if not x_opsel is initial
    IF NOT x_clsel IS INITIAL.
      IF NOT skb1-xopvw IS INITIAL
      OR NOT skb1-xlgclr IS INITIAL.
      ELSE.
        IF NOT skb1-xkres IS INITIAL
        AND gv_relevant_ledger = gv_leading_ledger.
        ELSE.
          IF cl_fin_ui_deco=>mv_mode = abap_false.
            REJECT.
          ELSE.
            EXIT.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ELSE.
    IF  skb1-xopvw IS INITIAL
    AND skb1-xkres IS INITIAL
    AND skb1-xlgclr IS INITIAL.
      IF cl_fin_ui_deco=>mv_mode = abap_false.
        REJECT.
      ELSE.
        EXIT.
      ENDIF.
    ENDIF.
  ENDIF.

* company master data:
  PERFORM t001_info_fill USING skb1-bukrs.
* GL account text:
  PERFORM skat_info_fill.
* company account master data:
  PERFORM skb1_info_fill.

* Selection of lineitems

* map selection to lineitem selection ranges
* add masterdata information
  PERFORM map_sel_to_items_mast_dat USING
                                      gb_xplacc
                                      gt_selection_part
                                    CHANGING
                                      gt_selection_full.
* select items and fill them in Output table
  IF NOT skb1-begru IS INITIAL.
    AUTHORITY-CHECK OBJECT 'F_BKPF_BES'
               ID 'BRGRU' FIELD skb1-begru
               ID 'ACTVT' FIELD '03'.
    IF sy-subrc NE 0.
      IF cl_fin_ui_deco=>mv_mode = abap_false.
        REJECT.
      ELSE.
        EXIT.
      ENDIF.
    ENDIF.
  ENDIF.
*  if sy-subrc = 0.
*    if gv_xerfs is initial.
  PERFORM check_slt_account USING skb1-saknr
                                  skb1-bukrs
                                  skb1-xkres
                                  gb_xplacc.
*    endif.
  CLEAR gv_special_account.                                 "1822909
  PERFORM check_trtm_account.                               "1004374
  PERFORM check_glyec_account.                              "1779180
  PERFORM select_items.
  IF NOT x_stop IS INITIAL.
    STOP.
  ENDIF.
*  endif.

ENDFORM.                    "deco_at_selection_get

*&---------------------------------------------------------------------*
*&      Form  deco_at_END_OF_SELECTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_end_of_selection.

* refresh table with selected items, no more needed
  REFRESH it_sel.
* set variant:
  gs_variant-report   = g_repid.
  gs_variant-username = sy-uname.
  gs_variant-variant  = pa_vari.
* if report is called from balance display:
  PERFORM include_pl_accounts.              "Diff. in Date selection
* save all selection criteria for refresh:
  PERFORM save_all_selections.
* determine list display mode:
  PERFORM display_grid_or_classic.
* read special fields if necessary:
* perform special_fields_init using gs_variant.
  PERFORM special_fields_init USING gs_variant.

* BADI check authority additional data customer
  IF  NOT gd_act_imp_auth_c IS INITIAL
  AND NOT gd_ref_to_auth_c  IS INITIAL.
    PERFORM items_check_auth_c.
  ENDIF.

* add message for arch items
  IF NOT gd_count_arch IS INITIAL.
    IF NOT gd_usear IS INITIAL.
      MESSAGE i112 WITH gd_count_arch INTO gd_dummy.
      PERFORM msg_add_to_log.
    ELSE.
      MESSAGE i113 WITH gd_count_arch INTO gd_dummy.
      PERFORM msg_add_to_log.
    ENDIF.
  ENDIF.

* message for items with no authority                        "1511192
  IF NOT gd_count_noauth IS INITIAL.
    deco_message_1 i126 with gd_count_noauth.
  ENDIF.

* number of selected items:
  IF x_stop = 'X'.
    deco_message_1 i023 with pa_nmax.
  ELSE.
    DESCRIBE TABLE it_pos LINES n_lines.
    IF n_lines > 0.
      IF rb_upd <> 'X'.
        deco_message_1 s024 with n_lines.
      ENDIF.
    ELSEIF pa_inet IS INITIAL AND gd_dynp_val IS INITIAL.
      PERFORM check_msg_exist USING gs_log_handle
                          CHANGING gd_xmsg.

      IF gd_xmsg IS INITIAL.
        deco_message_0 s033.
        EXIT.
      ELSE.
        MESSAGE s033 INTO gd_dummy.
        PERFORM msg_add_to_log.
        APPEND gs_log_handle TO gt_log_handle.
        PERFORM print_appl_log.
        EXIT.
      ENDIF.
    ELSE.
      deco_message_0 i033.
      PERFORM deco_leave_program.
    ENDIF.
  ENDIF.
* export general data used in header info:
  PERFORM export_filitexts_data.

* authority display or change
  PERFORM authority_tcode USING 'FB02' subrc.
  IF subrc EQ 0.
    x_change = 'X'.
  ELSE.
    x_change = space.
  ENDIF.

ENDFORM.                    "deco_at_END_OF_SELECTION

*&---------------------------------------------------------------------*
*&      Form  deco_at_output_alv
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deco_at_output_alv.

** BEGIN OF CODE PUSH DOWN
  TYPES: BEGIN OF ty_pspnr,
           pspnr TYPE zde_ps_intnr,
         END OF ty_pspnr.
  DATA: wa_pspnr TYPE ty_pspnr,
        lt_pspnr TYPE STANDARD TABLE OF ty_pspnr.
** END   OF CODE PUSH DOWN

*begin of addition by sushil ss_001



  DATA : lv_pspnr   TYPE c LENGTH 8,
         lv_zzkunag TYPE proj-zzkunag.


  DATA : lwa_exchng_rate TYPE bapi1093_0,
         lv_return       TYPE bapiret1,
         lv_cuky         TYPE hwaer,
         lv_exchng_rate  TYPE ukursm.

  DATA : lv_alpha TYPE c LENGTH 27 VALUE 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.
  DATA : lv_num TYPE c LENGTH 10 VALUE '1234567890'. " added by sushil Tag:SS_002


  LOOP AT it_pos ASSIGNING <fs_pos>.

    CLEAR lv_pspnr.
    IF <fs_pos>-projk IS NOT INITIAL.
      lv_pspnr = <fs_pos>-projk+0(8).
    ELSEIF <fs_pos>-zuonr IS NOT INITIAL.
      lv_pspnr = <fs_pos>-zuonr+0(8).
    ELSEIF <fs_pos>-xref2 IS NOT INITIAL.
      lv_pspnr = <fs_pos>-xref2+0(8).
    ENDIF.

    TRANSLATE lv_pspnr+1(1) TO UPPER CASE.

    IF lv_pspnr+1(1) CA lv_alpha.
      CONTINUE.
    ELSE.
*      start of addition by sushil Tag:SS_002
      IF lv_pspnr+2(1) CA lv_num AND lv_pspnr+3(1) CA lv_num AND lv_pspnr+4(1) CA lv_num
       AND lv_pspnr+5(1) CA lv_num AND lv_pspnr+6(1) CA lv_num  .
*      end of addition
        CALL FUNCTION 'CONVERSION_EXIT_KONPD_INPUT'
          EXPORTING
            input     = lv_pspnr
          IMPORTING
            output    = <fs_pos>-pspnr
*           PROJWA    =
          EXCEPTIONS
            not_found = 1
            OTHERS    = 2.
        .
        IF sy-subrc = 0.
          READ TABLE lt_pspnr INTO wa_pspnr WITH KEY pspnr = <fs_pos>-pspnr.
          IF sy-subrc <> 0.
            APPEND <fs_pos>-pspnr TO lt_pspnr.
          ENDIF.
* Implement suitable error handling here
        ENDIF.
      ENDIF.  " added by sushil Tag:SS_002
    ENDIF.
  ENDLOOP.

  CLEAR : wa_proj , wa_kna1 , wa_lob , wa_zproj_type.
  REFRESH : it_proj , it_proj , it_lob , it_zproj_type , it_proj1.
  UNASSIGN <fs_pos>.

  IF it_pos IS NOT INITIAL.
*    it_pos1[] = it_pos[].
*
*    DELETE ADJACENT DUPLICATES FROM it_pos1 COMPARING pspnr.

    IF lt_pspnr IS NOT INITIAL.
      SORT lt_pspnr BY pspnr.
      SELECT pspnr
             post1
             zzkunag
             zzproj_desc
             zzbu_code
             FROM proj
         INTO TABLE it_proj
         FOR ALL ENTRIES IN lt_pspnr
      WHERE pspnr = lt_pspnr-pspnr.
*           FOR ALL ENTRIES IN it_pos1
*            WHERE pspnr = it_pos1-pspnr.
      CLEAR lt_pspnr[].
    ENDIF.

    IF it_proj IS NOT INITIAL.

*========== logic added by Yatindra/Jyotika on 07.12.2018 ============**
      SELECT  plvar
              otype
              objid
              istat
              begda
              endda
              stext
          FROM hrp1000
          INTO TABLE it_hrp1000
          FOR ALL ENTRIES IN it_proj
          WHERE objid = it_proj-zzbu_code
          AND   plvar = '01'
      AND   otype = 'O'.

      SORT it_hrp1000 BY objid.
*========== logic ended by Yatindra/Jyotika on 07.12.2018 ============**

      SELECT kunnr
             name1
           FROM kna1
           INTO TABLE it_kna1
           FOR ALL ENTRIES IN it_proj
      WHERE kunnr = it_proj-zzkunag.

      it_proj1 = it_proj.
      SORT it_proj1 BY zzproj_desc.
      DELETE ADJACENT DUPLICATES FROM it_proj1 COMPARING zzproj_desc.

      SELECT zzproj_desc
             zzcat_desc
             FROM zproj_type
             INTO TABLE it_zproj_type
             FOR ALL ENTRIES IN it_proj1
      WHERE zzproj_desc = it_proj1-zzproj_desc.
      SORT it_zproj_type BY zzproj_desc.
    ENDIF.
  ENDIF.

  CLEAR : lv_cuky,lv_exchng_rate, lwa_exchng_rate,lv_cuky_doc,lv_exchng_rate_doc,lwa_exchng_rate_doc.

  SORT it_kna1 BY kunnr.
  SORT it_proj BY pspnr.
  LOOP AT it_pos ASSIGNING <fs_pos>.

    CLEAR : wa_proj,
            wa_kna1.

    READ TABLE it_proj INTO wa_proj WITH KEY pspnr = <fs_pos>-pspnr BINARY SEARCH.
    IF sy-subrc = 0.
      <fs_pos>-zproj_name  = wa_proj-zproj_name.
      <fs_pos>-kunnr_1     = wa_proj-zzkunag.
      <fs_pos>-zzproj_desc = wa_proj-zzproj_desc.
      <fs_pos>-zzbu_code   = wa_proj-zzbu_code.           "added by Yatindra/Jyotika on 27.11.2018

*============================ logic added by Yatindra/Jyotika on 07.12.2018 ================================**
      LOOP AT it_hrp1000 INTO wa_hrp1000 WHERE objid = <fs_pos>-zzbu_code.
        IF sy-subrc = 0.
          wa_hrp1000_temp-plvar = wa_hrp1000-plvar.
          wa_hrp1000_temp-otype = wa_hrp1000-otype.
          wa_hrp1000_temp-objid = wa_hrp1000-objid.
          wa_hrp1000_temp-istat = wa_hrp1000-istat.
          wa_hrp1000_temp-begda = wa_hrp1000-begda.
          wa_hrp1000_temp-endda = wa_hrp1000-endda.
          wa_hrp1000_temp-stext = wa_hrp1000-stext.
          APPEND wa_hrp1000_temp TO it_hrp1000_temp.
          CLEAR: wa_hrp1000, wa_hrp1000_temp.
        ENDIF.
      ENDLOOP.

      IF it_hrp1000_temp[] IS NOT INITIAL.
        SORT it_hrp1000_temp BY endda DESCENDING.

        READ TABLE it_hrp1000_temp INTO wa_hrp1000_temp INDEX 1.
        IF  sy-subrc = 0.
          <fs_pos>-zmc_stext   = wa_hrp1000_temp-stext.
        ENDIF.
      ENDIF.
*============================ logic added by Yatindra/Jyotika on 07.12.2018 ================================**

      READ TABLE it_zproj_type INTO wa_zproj_type WITH KEY zzproj_desc = wa_proj-zzproj_desc BINARY SEARCH.
      IF sy-subrc = 0.
        <fs_pos>-zzcat_desc = wa_zproj_type-zzcat_desc.
      ENDIF.
    ENDIF.

*logic for lob
    IF wa_proj-zzbu_code IS NOT INITIAL.
      CLEAR wa_lob.
      SORT it_lob BY zzbu_code.
      READ TABLE it_lob INTO wa_lob WITH KEY zzbu_code = wa_proj-zzbu_code BINARY SEARCH.
      IF sy-subrc NE 0.

        CALL FUNCTION 'RH_STRUC_GET'
          EXPORTING
            act_otype      = 'O'
            act_objid      = wa_proj-zzbu_code
            act_wegid      = 'A002'
          TABLES
            result_tab     = it_result_tab
            result_objec   = it_result_objec
            result_struc   = it_result_struc
          EXCEPTIONS
            no_plvar_found = 1
            no_entry_found = 2
            OTHERS         = 3.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.

        IF it_result_struc[] IS NOT INITIAL.
          SORT it_result_struc BY level DESCENDING.
        ENDIF.

        CLEAR wa_result_struc.
        READ TABLE it_result_struc INTO wa_result_struc  INDEX 2.
        IF sy-subrc = 0.
*      wa_final-gvbdu = wa_result_struc-objid.

          READ TABLE it_result_objec INTO wa_result_objec
                 WITH KEY objid = wa_result_struc-objid."wa_final-gvbdu.
          IF sy-subrc = 0.
            <fs_pos>-zstext = wa_result_objec-stext.
            wa_lob-zzbu_code = wa_proj-zzbu_code.
            wa_lob-zstext = wa_result_objec-stext.
            APPEND wa_lob TO it_lob.
          ENDIF.
        ENDIF.

      ELSE.
        <fs_pos>-zstext = wa_lob-zstext.

      ENDIF.

    ENDIF.
*end for lob

    READ TABLE it_kna1 INTO wa_kna1 WITH KEY kunnr = wa_proj-zzkunag BINARY SEARCH.

    IF sy-subrc = 0.
      <fs_pos>-name1 = wa_kna1-name1.
    ENDIF.


*start for loc currency  Z_Curr(Local)
    IF p_budat IS NOT INITIAL.

      IF lv_cuky NE <fs_pos>-hwaer.

*clear lv_cuky.
        CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
          EXPORTING
            rate_type  = 'M'
            from_curr  = 'USD'
            to_currncy = <fs_pos>-hwaer
            date       = p_budat
          IMPORTING
            exch_rate  = lwa_exchng_rate
            return     = lv_return.

        IF sy-subrc = 0 ."and lv_return is initial.
          lv_cuky = <fs_pos>-hwaer.
          <fs_pos>-zusd_amount = ( <fs_pos>-dmshb * lwa_exchng_rate-from_factor ) / ( lwa_exchng_rate-exch_rate * lwa_exchng_rate-to_factor ).
        ENDIF.
      ELSE.
        <fs_pos>-zusd_amount = ( <fs_pos>-dmshb * lwa_exchng_rate-from_factor ) / (  lwa_exchng_rate-exch_rate * lwa_exchng_rate-to_factor ).


      ENDIF.
    ENDIF.

*end for loc currency  Z_Curr(Local)

* start for doc currency   Z_Curr(Doc)

    IF p_budat IS NOT INITIAL.

      IF lv_cuky_doc NE <fs_pos>-waers.

*clear lv_cuky.
        CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
          EXPORTING
            rate_type  = 'M'
            from_curr  = 'USD'
            to_currncy = <fs_pos>-waers
            date       = p_budat
          IMPORTING
            exch_rate  = lwa_exchng_rate_doc
            return     = lv_return_doc.

        IF sy-subrc = 0 ."and lv_return is initial.
          lv_cuky_doc = <fs_pos>-waers.
          <fs_pos>-zusd_amount_doc = ( <fs_pos>-wrshb * lwa_exchng_rate_doc-from_factor ) / ( lwa_exchng_rate_doc-exch_rate * lwa_exchng_rate_doc-to_factor ).
        ENDIF.
      ELSE.
        <fs_pos>-zusd_amount_doc = ( <fs_pos>-wrshb * lwa_exchng_rate_doc-from_factor ) / (  lwa_exchng_rate_doc-exch_rate * lwa_exchng_rate_doc-to_factor ).


      ENDIF.
    ENDIF.

*end for doc currency Z_Curr(Doc)
    REFRESH it_hrp1000_temp.
  ENDLOOP.
*end of addition
***BOC Seshu_001
  TYPES : BEGIN OF ty_proj,
            pspid TYPE ps_pspid,
            profl TYPE profidproj,
          END OF ty_proj.
  DATA : it_proj   TYPE TABLE OF ty_proj,
         wa_proj   TYPE ty_proj,
         it_proj_2 TYPE TABLE OF ty_proj,
         wa_proj_2 TYPE ty_proj.
*****BOC Seshu_003
  TYPES : BEGIN OF ty_temp,
            projk TYPE projk_ext,
          END OF ty_temp.

  DATA : it_temp_projk TYPE TABLE OF ty_temp,
         wa_temp_projk TYPE  ty_temp.

  LOOP AT it_pos INTO wa_pos.
    wa_temp_projk-projk = wa_pos-projk.
    APPEND wa_temp_projk TO it_temp_projk.
  ENDLOOP.
*****EOC Seshu_003

  LOOP AT it_pos INTO wa_pos.
    SPLIT wa_pos-projk AT '.' INTO lv_projk1 lv_projk2.
    wa_projk_2-projk =   lv_projk1.
    APPEND  wa_projk_2 TO  it_projk_2.
*    wa_pos-projk =   lv_projk1. " Commented by seshu_002
*    MODIFY it_pos FROM wa_pos INDEX sy-tabix TRANSPORTING projk. " Commented by seshu_003
    wa_pos-projk =   lv_projk1. " added by seshu_003
    MODIFY it_pos FROM wa_pos INDEX sy-tabix TRANSPORTING projk. " added by seshu_003
  ENDLOOP.

  SORT it_projk_2 .
  DELETE ADJACENT DUPLICATES FROM it_projk_2.
  LOOP AT it_projk_2 INTO wa_projk_2.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_INPUT'
      EXPORTING
        input  = wa_projk_2-projk
      IMPORTING
        output = wa_projk_3-projk.
    APPEND wa_projk_3 TO it_projk_3.
    CLEAR : wa_projk_2,wa_projk_3.
  ENDLOOP.


  SELECT pspid
  profl FROM proj INTO TABLE it_proj FOR ALL ENTRIES IN it_projk_3 WHERE pspid = it_projk_3-projk .


  LOOP AT  it_proj  INTO  wa_proj.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
      EXPORTING
        input  = wa_proj-pspid
      IMPORTING
        output = wa_proj_2-pspid.
    wa_proj_2-profl  =  wa_proj-profl .
    APPEND wa_proj_2 TO it_proj_2.
    CLEAR : wa_proj_2 ,wa_proj.
  ENDLOOP.


  LOOP AT it_pos INTO wa_pos.
    wa_pos2-vbeln =  wa_pos-zuonr+0(10).
    APPEND wa_pos2 TO it_pos2.
  ENDLOOP.
  SELECT vbeln
  kunnr FROM vbak INTO TABLE it_vbak FOR  ALL ENTRIES IN   it_pos2 WHERE vbeln = it_pos2-vbeln.
* Added by HCLTDEV34 for RAR module customer details. charm 3000006150
  IF it_pos2[] IS NOT INITIAL.
    SELECT vbeln,aubel FROM vbrp INTO TABLE @DATA(lt_vbrp)
      FOR ALL ENTRIES IN @it_pos2
      WHERE vbeln EQ @it_pos2-vbeln.
    IF lt_vbrp IS NOT INITIAL.
      SELECT vbeln
             kunnr FROM vbak
             APPENDING TABLE it_vbak
             FOR  ALL ENTRIES IN lt_vbrp
             WHERE vbeln = lt_vbrp-aubel.
    ENDIF.
  ENDIF.
* End of addition by HCLTDEV34. charm 3000006150
  DATA lv_zuonr(10) TYPE c.
  LOOP AT it_pos ASSIGNING <fs_pos> WHERE kunnr = ''  .
    READ TABLE it_proj_2 INTO wa_proj_2 WITH KEY pspid = <fs_pos>-projk.
    IF sy-subrc = 0 .
      IF wa_proj_2-profl = 'HCLPNP1'.
        IF <fs_pos>-blart = 'ZC'.
          lv_zuonr = <fs_pos>-zuonr+0(10).
          READ TABLE it_vbak INTO DATA(wa_vbak) WITH KEY vbeln =  lv_zuonr.
          IF sy-subrc = 0.
            <fs_pos>-kunnr_1 = wa_vbak-kunnr.
* Added by HCLTDEV34 for RAR module customer details. charm 3000006150
          ELSE.
            CLEAR wa_vbak.
            READ TABLE lt_vbrp INTO DATA(ls_vbrp) WITH KEY vbeln = lv_zuonr.
            IF sy-subrc IS INITIAL.
              READ TABLE it_vbak INTO wa_vbak WITH KEY vbeln = ls_vbrp-aubel.
              IF sy-subrc = 0.
                <fs_pos>-kunnr_1 = wa_vbak-kunnr.
              ENDIF.
            ENDIF.
          ENDIF.
* End of addition by HCLTDEV34. charm 3000006150
        ELSEIF <fs_pos>-blart = 'RV'.

          <fs_pos>-kunnr_1 =  <fs_pos>-gkont .
        ELSE.
          <fs_pos>-kunnr_1 = <fs_pos>-zuonr+0(10).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.
  REFRESH lt_vbrp.
*********BOC by <Namita Chandra>--CH<S 3000003843>--TR<HRDK9A08WK>*************
  it_pos_2[] = it_pos[].
  DELETE it_pos_2 WHERE kunnr_1 = ''.
  SORT it_pos_2 BY belnr bukrs gjahr blart.
  DELETE ADJACENT DUPLICATES FROM it_pos_2 COMPARING belnr bukrs gjahr blart.
  LOOP AT it_pos INTO wa_pos  WHERE kunnr_1 = '' AND blart = 'ZC' .
    DATA(lv_count) = sy-tabix.
    READ TABLE it_pos_2 INTO wa_pos_2 WITH KEY belnr = wa_pos-belnr
                                               bukrs = wa_pos-bukrs
                                               gjahr = wa_pos-gjahr
                                               blart = wa_pos-blart.
    IF sy-subrc = 0.
      wa_pos-kunnr_1 = wa_pos_2-kunnr_1.
      MODIFY it_pos FROM wa_pos INDEX lv_count TRANSPORTING kunnr_1.
    ENDIF.
  ENDLOOP.
*********EOC by <Namita Chandra>--CH<S 3000003843>--TR<HRDK9A08WK>*************

  SELECT kunnr name1 FROM kna1 INTO TABLE it_kna1_2 FOR ALL ENTRIES IN it_pos WHERE kunnr =  it_pos-kunnr_1 .
*  LOOP AT it_pos ASSIGNING <fs_pos> WHERE name1 = ''  . commented by seshu_003
  LOOP AT it_pos ASSIGNING <fs_pos>." WHERE name1 = ''  ." added by seshu_003
    READ TABLE it_proj_2 INTO wa_proj_2 WITH KEY pspid = <fs_pos>-projk.
    IF sy-subrc = 0 .
      IF wa_proj_2-profl = 'HCLPNP1'.

        READ TABLE it_kna1_2 INTO DATA(wa_kna1_2) WITH KEY kunnr = <fs_pos>-kunnr_1.
        IF sy-subrc = 0.
          <fs_pos>-name1 =  wa_kna1_2-name1.

        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.

***EOC Seshu_001
***BOC Seshu_003
  LOOP AT it_temp_projk INTO wa_temp_projk.
    wa_pos-projk =   wa_temp_projk.
    MODIFY it_pos FROM wa_pos INDEX sy-tabix TRANSPORTING projk.
  ENDLOOP.
***EOC Seshu_003

**BOA -- Jaspal -- 24/08/2020
  REFRESH it_pos_temp.
  it_pos_temp[] = it_pos[].
  SORT it_pos_temp BY blart.
  DELETE it_pos_temp  WHERE blart NE 'RV'.
  IF NOT it_pos_temp[]  IS INITIAL.
    SELECT
      vp~vbeln,
      vp~aubel,
      ac~rldnr,
      ac~rbukrs,
      ac~gjahr,
      ac~belnr,
      ac~awref AS acdoca_awref,
      vk~bname
      INTO TABLE @DATA(lt_data)
      FROM vbrp AS vp
      INNER JOIN acdoca AS ac
            ON vp~vbeln  EQ ac~awref
      INNER JOIN vbak AS vk
            ON vp~aubel EQ vk~vbeln
      FOR ALL ENTRIES IN @it_pos_temp
      WHERE ac~belnr EQ @it_pos_temp-belnr
        AND ac~rbukrs EQ @it_pos_temp-bukrs
        AND ac~gjahr EQ @it_pos_temp-gjahr
        AND ac~rldnr EQ @it_pos_temp-rldnr
        AND vk~bname NE ''.
  ENDIF.
  IF NOT lt_data[]  IS INITIAL.
    SORT lt_data BY rbukrs gjahr belnr ASCENDING.
    DELETE ADJACENT DUPLICATES FROM lt_data
                    COMPARING rbukrs gjahr belnr.
    SORT it_pos[] BY bukrs gjahr belnr ASCENDING.
    LOOP AT lt_data  INTO DATA(ls_data).
      READ TABLE it_pos INTO DATA(ls_pos)
                  WITH KEY bukrs = ls_data-rbukrs
                           gjahr = ls_data-gjahr
                           belnr = ls_data-belnr
                           BINARY SEARCH.

      IF sy-subrc EQ 0.
        DATA(lv_index) = sy-tabix.
        LOOP AT it_pos ASSIGNING FIELD-SYMBOL(<fs>) FROM lv_index
                       WHERE bukrs EQ ls_data-rbukrs
                         AND gjahr EQ ls_data-gjahr
                         AND belnr EQ ls_data-belnr.
          <fs>-crm_ord_no = ls_data-bname.
        ENDLOOP.
      ENDIF.
      CLEAR : ls_data.
    ENDLOOP.
  ENDIF.
  REFRESH : lt_data,
            it_pos_temp[].
  it_pos_temp[] = it_pos[].
  SORT it_pos_temp[] BY blart.
  DELETE it_pos_temp  WHERE blart NE 'ZC'.
  IF NOT it_pos_temp[]  IS INITIAL.
    SELECT
      vbeln,
      bname
      FROM vbak
      INTO TABLE @DATA(lt_vbak)
      FOR ALL ENTRIES IN @it_pos_temp[]
      WHERE vbeln EQ @it_pos_temp-zuonr+0(10).
* Added by HCLTDEV34 for RAR module customer details. charm 3000006150
    SELECT vbeln,aubel
      FROM vbrp
      INTO TABLE @DATA(lt_vbrp_t)
      FOR ALL ENTRIES IN @it_pos_temp[]
    WHERE vbeln EQ @it_pos_temp-zuonr+0(10).
    IF lt_vbrp_t IS NOT INITIAL.
      SELECT
       vbeln,
       bname
       FROM vbak
       INTO TABLE @DATA(lt_vbak_t)
       FOR ALL ENTRIES IN @lt_vbrp_t[]
       WHERE vbeln EQ @lt_vbrp_t-aubel.
    ENDIF.
* End of addition by HCLTDEV34 for RAR module customer details. charm 3000006150
  ENDIF.
  IF NOT lt_vbak[]  IS INITIAL.
    SORT it_pos[] BY zuonr.
    LOOP AT lt_vbak  INTO DATA(ls_vbak).
      LOOP AT it_pos ASSIGNING FIELD-SYMBOL(<fs_pos>)
              WHERE zuonr+0(10) = ls_vbak-vbeln.
        <fs_pos>-crm_ord_no = ls_vbak-bname.
      ENDLOOP.
      CLEAR ls_vbak.
    ENDLOOP.
  ENDIF.
* Added by HCLTDEV34 for RAR module customer details. charm 3000006150
  IF <fs_pos> IS ASSIGNED.
    UNASSIGN <fs_pos>.
  ENDIF.
  IF NOT lt_vbak_t[] IS INITIAL.
    LOOP AT lt_vbak_t INTO DATA(ls_vbak_t).
      READ TABLE lt_vbrp_t INTO DATA(ls_vbrp_t) WITH KEY aubel = ls_vbak_t-vbeln.
      IF sy-subrc IS INITIAL.
        LOOP AT it_pos ASSIGNING <fs_pos>
                WHERE zuonr+0(10) = ls_vbrp_t-vbeln.
          <fs_pos>-crm_ord_no = ls_vbak_t-bname.
        ENDLOOP.
      ENDIF.
      CLEAR: ls_vbak_t,ls_vbrp_t.
    ENDLOOP.
  ENDIF.
  IF <fs_pos> IS ASSIGNED.
    UNASSIGN <fs_pos>.
  ENDIF.
* End of Addition by HCLTDEV34 for RAR module customer details. charm 3000006150
  REFRESH : lt_vbak,
            it_pos_temp[],
            lt_vbak_t,
            lt_vbrp_t[].
**EOA -- Jaspal -- 24/08/2020

*DATA  L_REPID TYPE CHAR50. " *****  Added by Shiv on 17.02.2022 CH: 3000006112 TR: HRDK9A0I7L
*  IMPORT L_REPID  FROM MEMORY ID 'PRGNAME'. " *****  Added by Shiv on 17.02.2022 CH: 3000006112 TR: HRDK9A0I7L
*   IF L_REPID EQ 'ZFIREP_UBR_AGE'. "addition - dinakaran - performance opt "Added by Shiv on 17.02.2022 CH: 3000006112 TR: HRDK9A0I7L
*      EXPORT IT_POS  TO MEMORY ID 'UBR2'.                       "Added by Shiv on 17.02.2022 CH: 3000006112 TR: HRDK9A0I7L
*   ELSEIF RB_ALV = 'X'. "addition - dinakaran - performance opt "Added by Shiv on 17.02.2022 CH: 3000006112 TR: HRDK9A0I7L
  IF rb_alv = 'X'. "addition - dinakaran - performance opt "Commented by Shiv on 17.02.2022 CH: 3000006112 TR: HRDK9A0I7L
* leave to ALV:
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        text = TEXT-009.

    CALL FUNCTION 'FAGL_ITEMS_DISPLAY'
      EXPORTING
        caller_repid  = c_repid_gl
        i_rldnr       = gv_relevant_ledger
        acctype       = c_koart_gl
        x_opvw        = x_gl_opvw
        x_change      = x_change
        i_u_save      = gd_alvsave
        is_u_variant  = gs_variant
        it_u_fieldcat = gt_fieldcat[]
        it_kontab     = it_accts[]
        it_slbtab     = it_comps[]
        it_t001       = it_h_t001[]
        it_skat       = it_h_skat[]
        it_skb1       = it_h_skb1[]
        x_grid        = x_grid
        x_inet        = pa_inet
        i_log_handle  = gs_log_handle
        i_ucomm       = gv_ucomm
      TABLES
        it_items      = it_pos.
*begin of addition - dinakaran - performance opt
  ELSEIF rb_app = 'X'. "write to application server

    PERFORM f_write_file_to_app_server TABLES it_pos
                                        USING p_appl.
  ELSEIF rb_upd = 'X'."Update to custom table ZFI_FAGLL03
    LOOP AT it_pos ASSIGNING <fs_pos>.
      gw_pos_tmp-runid = p_runid.
      gw_pos_tmp-counter = gw_pos_tmp-counter + 1.
      MOVE-CORRESPONDING <fs_pos> TO gw_pos_tmp.
      APPEND gw_pos_tmp TO it_pos_tmp.
      DELETE it_pos INDEX 1.
    ENDLOOP.
****************BOC By <VAISHALI GAUR>--CH<3000002365>--TR<HRDK9A03TW>--Date<07.11.2019>****
    CLEAR : it_set.
    CALL FUNCTION 'G_SET_GET_ALL_VALUES'
      EXPORTING
        client        = sy-mandt
        setnr         = 'ZFAGLL03_BI_USER'
        class         = '0000'
      TABLES
        set_values    = it_set
      EXCEPTIONS
        set_not_found = 1
        OTHERS        = 2.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.
    LOOP AT it_set INTO wa_set.
      r_uname-sign = 'I'.
      r_uname-option = 'EQ'.
      r_uname-low = wa_set-from.
      CONDENSE r_uname-low.
      APPEND r_uname TO r_uname[].
      CLEAR r_uname.
    ENDLOOP.
    IF it_set IS INITIAL .
      PERFORM f_update_custom_tab.
    ELSE.
      IF sy-uname IN r_uname[].
        PERFORM f_update_bi_tab.
      ELSE.
        PERFORM f_update_custom_tab.
      ENDIF.
    ENDIF.
****************EOC By <VAISHALI GAUR>--CH<3000002365>--TR<HRDK9A03TW>--Date<07.11.2019>****

  ENDIF.
*end   of addition - dinakaran - performance opt
  FREE it_h_t001.                                           "1825079
  FREE it_h_skat.                                           "1825079
  FREE it_h_skb1.                                           "1825079
  FREE it_pos.                                              "1825079

ENDFORM.                    "deco_at_output_alv

*----------------------------------------------------------------------*
*  FORM SEL_ACCOUNT_CHECK
*----------------------------------------------------------------------*
FORM sel_account_check.

  DATA: ld_lines          LIKE sy-index,
        ld_single_account TYPE c,
        ld_single_bukrs   TYPE c.


  READ TABLE sd_saknr INDEX 1.
  IF sy-subrc NE 0.
    READ TABLE sd_bukrs INDEX 1.
    IF sy-subrc NE 0.
      deco_message_0 w019.
    ENDIF.
  ENDIF.

  DESCRIBE TABLE sd_saknr LINES ld_lines.
  LOOP AT sd_saknr TRANSPORTING NO FIELDS
       WHERE sign NE 'I' OR
             option NE 'EQ'.
    EXIT.
  ENDLOOP.

  IF sy-subrc = 0 OR ld_lines = 0.
    SELECT SINGLE saknr bukrs FROM skb1                 "#EC CI_GENBUFF
           INTO (gd_saknr_msg, gd_bukrs_msg)
           WHERE saknr IN sd_saknr
    AND bukrs IN sd_bukrs.
    IF sy-subrc NE 0.
      deco_message_0 e030(msitem).
    ENDIF.
    IF NOT x_erfs IS INITIAL
    OR NOT x_merk IS INITIAL
    OR NOT x_park IS INITIAL.
      SELECT SINGLE saknr FROM skb1 INTO skb1-saknr     "#EC CI_GENBUFF
             WHERE saknr IN sd_saknr
               AND bukrs IN sd_bukrs
      AND ( xkres = 'X' OR xlgclr = 'X' ).
      IF sy-subrc NE 0.
        deco_message_2 e430(f4) with gd_saknr_msg gd_bukrs_msg.
      ENDIF.
    ENDIF.
  ELSE.  "worklist
    SELECT saknr bukrs FROM skb1
       INTO (gd_saknr_msg, gd_bukrs_msg)
       FOR ALL ENTRIES IN sd_saknr
       WHERE saknr = sd_saknr-low
         AND bukrs IN sd_bukrs.
      EXIT.
    ENDSELECT.
    IF sy-subrc NE 0.
      deco_message_0 e030(msitem).
    ENDIF.
    IF NOT x_erfs IS INITIAL
    OR NOT x_merk IS INITIAL
    OR NOT x_park IS INITIAL.
      SELECT saknr FROM skb1 INTO skb1-saknr
             FOR ALL ENTRIES IN sd_saknr
             WHERE saknr = sd_saknr-low
               AND bukrs IN sd_bukrs
               AND ( xkres = 'X' OR xlgclr = 'X' ).
        EXIT.
      ENDSELECT.
      IF sy-subrc NE 0.
        deco_message_2 e430(f4) with gd_saknr_msg gd_bukrs_msg.
      ENDIF.
    ENDIF.
  ENDIF.
*...write sd_saknr und sd_bukrs into memory
*...(important later for Dispute-Management).

  EXPORT sd_saknr TO MEMORY ID 'FILITEXTS_SAKNR'.
  EXPORT sd_bukrs TO MEMORY ID 'FILITEXTS_BUKRS'.

*...find out, if single accounts and company codes have been selected..*
*...(important for header display).....................................*

  CLEAR ld_single_account.
  DESCRIBE TABLE sd_saknr LINES ld_lines.
  IF ld_lines EQ 1.
    READ TABLE sd_saknr INDEX 1.
    IF ( sd_saknr-sign EQ 'I' AND sd_saknr-option EQ 'EQ' ) OR
       ( sd_saknr-sign EQ 'I' AND sd_saknr-option EQ 'BT' AND
         sd_saknr-low  EQ sd_saknr-high ).
      ld_single_account = 'X'.
    ENDIF.
  ENDIF.
  CLEAR ld_single_bukrs.
  DESCRIBE TABLE sd_bukrs LINES ld_lines.
  IF ld_lines EQ 1.
    READ TABLE sd_bukrs INDEX 1.
    IF ( sd_bukrs-sign EQ 'I' AND sd_bukrs-option EQ 'EQ' ) OR
       ( sd_bukrs-sign EQ 'I' AND sd_bukrs-option EQ 'BT' AND
         sd_bukrs-low  EQ sd_bukrs-high ).
      ld_single_bukrs = 'X'.
    ENDIF.
  ENDIF.
  EXPORT ld_single_bukrs ld_single_account TO MEMORY ID
                                      'FILITEXTS_SINGLE'.

ENDFORM.                    "sel_account_check

*----------------------------------------------------------------------*
*  FORM SEL_TYPE_CHECK
*----------------------------------------------------------------------*
FORM sel_type_check.
  IF x_norm IS INITIAL AND x_merk IS INITIAL AND x_park IS INITIAL.
    deco_message_0 e020.
  ENDIF.
ENDFORM.                    "sel_type_check

*----------------------------------------------------------------------*
*      Form  POS_TABLE_FILL
*----------------------------------------------------------------------*
FORM pos_table_fill  CHANGING  p_stop.
  DATA: text_index TYPE i,
        okay       TYPE c VALUE space,
        x_noauth   TYPE c VALUE space.


  CLEAR wa_pos.
* move-corresponding bsis  to wa_pos.
  MOVE-CORRESPONDING wa_sel  TO wa_pos.
*... check item against selection flags:
  PERFORM check_item_ok  USING x_norm
                               'X'
                               x_merk
                               x_park
                               wa_pos
                         CHANGING okay.
  CHECK okay = 'X'.
*
  wa_pos-koart = c_koart_gl.
*  wa_pos-konto = bsis-hkont.
*  wa_pos-dmshb = bsis-dmbtr.
*  wa_pos-wrshb = bsis-wrbtr.
  wa_pos-konto = wa_sel-hkont.
*  wa_pos-dmshb = wa_sel-dmbtr.
*  wa_pos-wrshb = wa_sel-wrbtr.

* recon. account + line item display => open item management:
  IF ( skb1-mitkz EQ 'D' OR skb1-mitkz EQ 'K' ) AND skb1-xkres NE space.
    wa_sel-xopvw = 'X'.
* Ledgergroup specific clearing => open item
  ELSEIF skb1-xlgclr = 'X'.
    wa_sel-xopvw = 'X'.
  ENDIF.

* Valuation fields not yet supported in NewGL
*  wa_bsegp-bdiff = bsis-bdiff.
*  wa_bsegp-bdif2 = bsis-bdif2.
*  wa_bsegp-bdif3 = bsis-bdif3.
  wa_bsegp-bdiff = wa_sel-bdiff.
  wa_bsegp-bdif2 = wa_sel-bdif2.
  wa_bsegp-bdif3 = wa_sel-bdif3.

  IF gv_special_account = 'X'.                              "1004374
    CLEAR wa_sel-xopvw .                                    "1004374
  ENDIF.                                                    "1004374

* derive nontrivial rfpos fields:
  CALL FUNCTION 'FAGL_ITEM_DERIVE_FIELDS'
    EXPORTING
      s_t001    = it_h_t001
      s_bsegp   = wa_bsegp
      key_date  = p_keydate
*     xopvw     = bsis-xopvw
      xopvw     = wa_sel-xopvw
    CHANGING
      s_item    = wa_pos
    EXCEPTIONS
      bad_input = 1
      OTHERS    = 2.
  IF sy-subrc NE 0.
    deco_message_0 a022.
  ENDIF.
* fill currency fields:
* perform item_currency_fields.

* check authority for fields
  PERFORM item_check_auth CHANGING x_noauth.
  IF NOT x_noauth IS INITIAL.                               "1511192
    gd_count_noauth = gd_count_noauth + 1.                  "1511192
  ENDIF.                                                    "1511192

* expiring currency convertion
  IF NOT gd_expcur_flag IS INITIAL.
    PERFORM curr_convert_item.
  ENDIF.

* check dark select-options and add item to table:
  IF x_noauth IS INITIAL.
    PERFORM item_check_append.
  ENDIF.

* check max number:
  DESCRIBE TABLE it_pos LINES n_lines.
  IF pa_nmax > 0 AND n_lines GE pa_nmax.
    p_stop = 'X'.
*   stop.
  ENDIF.
ENDFORM.                    "pos_table_fill

*&---------------------------------------------------------------------*
*&      Form  T001_INFO_FILL
*&---------------------------------------------------------------------*
FORM t001_info_fill USING ip_bukrs TYPE skb1-bukrs.

  READ TABLE it_h_t001 WITH KEY mandt = sy-mandt
                                bukrs = ip_bukrs
                       BINARY SEARCH.
  IF sy-subrc NE 0.
    CLEAR: it_h_t001.
    SELECT SINGLE * FROM t001 INTO it_h_t001
    WHERE bukrs = ip_bukrs.
    INSERT TABLE it_h_t001.

*    table of companies:
    PERFORM fill_comp_table  USING  ip_bukrs
                              it_h_t001-waers
                              it_h_t001-kkber.
  ENDIF.

  IF wa_x001-bukrs NE skb1-bukrs.
    CLEAR: wa_x001.
    CALL FUNCTION 'FI_CURRENCY_INFORMATION'
      EXPORTING
        i_bukrs                = ip_bukrs
      IMPORTING
        e_x001                 = wa_x001
      EXCEPTIONS
        currency_2_not_defined = 1
        currency_3_not_defined = 2
        OTHERS                 = 3.
    IF sy-subrc = 0.
* ?
    ENDIF.
  ENDIF.

ENDFORM.                    "t001_info_fill

*&---------------------------------------------------------------------*
*&      Form  SKAT_INFO_FILL
*&---------------------------------------------------------------------*
FORM skat_info_fill.
  DATA: langu   LIKE sy-langu.
  CLEAR it_h_skat.
  IF idtimeacc_cl_switch_check=>filoc_time_acc_sfws_01( ) EQ 'X'.
    DATA:
    lv_key_date   TYPE datum.
*   Choose key date
    lv_key_date = idtimeacc_cl_utils=>choose_key_date(
        im_op_itm_flg       = x_opsel
        im_cl_itm_flg       = x_clsel
        im_al_itm_flg       = x_aisel
        im_op_key_dat       = pa_stida
        im_cl_key_dat       = pa_stid2
        im_rng_cl_key_dats  = so_augdt[]
        im_rng_all_key_dats = so_budat[]
    ).
*   Find G/L Account Text By Two Languages
    CALL METHOD idtimeacc_cl_utils=>read_glacc_text_by2_langs
      EXPORTING
        im_chart_accnts = it_h_t001-ktopl
        im_accnt_no     = skb1-saknr
        im_sec_langu    = it_h_t001-spras
        im_date_from    = lv_key_date
      RECEIVING
        re_str_acctxt   = it_h_skat
      EXCEPTIONS
        not_maintained  = 1
        OTHERS          = 2.
    IF sy-subrc = 0.
      INSERT TABLE it_h_skat.
      EXIT.
    ENDIF.
  ENDIF. " Note 1731392

  SELECT SINGLE * FROM skat INTO it_h_skat
       WHERE spras = sy-langu
       AND   ktopl = it_h_t001-ktopl
  AND   saknr = skb1-saknr.
  IF sy-subrc = 0.
    INSERT TABLE it_h_skat.
    EXIT.
  ENDIF.
  SELECT SINGLE * FROM skat INTO it_h_skat
       WHERE spras = it_h_t001-spras
       AND   ktopl = it_h_t001-ktopl
  AND   saknr = skb1-saknr.
  IF sy-subrc = 0.
    INSERT TABLE it_h_skat.
    EXIT.
  ENDIF.
  SELECT SINGLE * FROM skat INTO it_h_skat
       WHERE ktopl = it_h_t001-ktopl
  AND   saknr = skb1-saknr.
  IF sy-subrc = 0.
    INSERT TABLE it_h_skat.
    EXIT.
  ENDIF.
ENDFORM.                    "skat_info_fill

*&---------------------------------------------------------------------*
*&      Form  SKB1_INFO_FILL
*&---------------------------------------------------------------------*
FORM skb1_info_fill.
  DATA: sak_name   LIKE kna1-name1.
  CLEAR it_h_skb1.
  MOVE-CORRESPONDING skb1 TO it_h_skb1.
  INSERT TABLE it_h_skb1.
* table of accounts:
  IF idtimeacc_cl_switch_check=>filoc_time_acc_sfws_01( ) EQ 'X'.
    DATA:
      lv_key_date   TYPE datum,
      lv_skat_txt50 TYPE txt50.
*   Choose key date
    lv_key_date = idtimeacc_cl_utils=>choose_key_date(
        im_op_itm_flg       = x_opsel
        im_cl_itm_flg       = x_clsel
        im_al_itm_flg       = x_aisel
        im_op_key_dat       = pa_stida
        im_cl_key_dat       = pa_stid2
        im_rng_cl_key_dats  = so_augdt[]
        im_rng_all_key_dats = so_budat[]
    ).
    CALL FUNCTION 'IDCN_GLACC_TEXT_GET'
      EXPORTING
        kontenplan     = it_h_t001-ktopl
        sachkonto      = skb1-saknr
        dfrom          = lv_key_date
      IMPORTING
        txt50          = lv_skat_txt50
      EXCEPTIONS
        not_maintained = 1
        OTHERS         = 2.
    IF sy-subrc = 0.
      MOVE lv_skat_txt50 TO skat-txt50.
    ENDIF.
  ENDIF. " Note 1731392

  WRITE skat-txt50 TO sak_name.
  PERFORM fill_acct_table  USING  c_koart_gl
                                  skb1-saknr
                                  skb1-bukrs
                                  space
                                  sak_name
                                  skb1-saknr.
ENDFORM.                    "skb1_info_fill


*&---------------------------------------------------------------------*
*&      Form  MAP_SEL_TO_LDB
*&---------------------------------------------------------------------*
*form map_sel_to_ldb.
*
*  data: ld_stida like sy-datum.
*
*  clear:   sd_augdt, sd_budat, sd_opopt, sd_apopt, sd_stida.
*  refresh: sd_augdt, sd_budat.
*
** Determine whether parked (xstav) and/or normal items
** (xstan) must be selected by the log. database
*  if x_park = 'X'.
*    b0sg-xstav = 'X'.
*  else.
*    clear b0sg-xstav.
*  endif.
*  if ( x_norm = 'X' or x_shbv = 'X' or x_merk = 'X' ).
*    b0sg-xstan = 'X'.
*  else.
*    clear b0sg-xstan.
*  endif.
*
** Determine relevant keydates for the selection by the log. database
** (sd_stida)
*  get parameter id 'FI_STIDA' field ld_stida.
*  if not ld_stida is initial and sy-subrc eq 0.
*    pa_stida = ld_stida.
*    set parameter id 'FI_STIDA' field '00000000'.
*  endif.
*  case 'X'.
*    when x_opsel.
*      if pa_stida is initial.
*        p_keydate         = '99991231'.
*        sd_stida          = '99991231'.
*      else.
*        p_keydate         = pa_stida.
*        sd_stida          = pa_stida.
*      endif.
*      sd_opopt          = 'X'.
*    when x_clsel.
*      if pa_stid2 is initial.
*        p_keydate       = '99991231'.
*        sd_stida        = '00010101'.
*      else.
*        p_keydate       = pa_stid2.
*        sd_stida        = pa_stid2.
*        sd_budat-sign   = 'I'.
*        sd_budat-option = 'LE'.
*        sd_budat-low    = pa_stid2.
*        append sd_budat.
*      endif.
*      sd_augdt[]        = so_augdt[].
*    when x_aisel.
*      p_keydate         = '99991231'.
*      sd_stida          = '99991231'.
*      sd_budat[]        = so_budat[].
*      sd_opopt          = 'X'.
*      sd_apopt          = 'X'.
*  endcase.
*  pa_stida_default = sd_stida.
*
** For reading from archives:
** number of archived items as i-message:
*  sd_iarch = 'X'.
*  sd_memor = 'X'.
*
*endform.                    "map_sel_to_ldb

*&---------------------------------------------------------------------*
*&      Form  map_sel_to_items
*&---------------------------------------------------------------------*
FORM map_sel_to_items USING
                        p_gb_xplacc TYPE boolean
                      CHANGING
                        p_gt_selection_part TYPE  gusl_t_selection.

  DATA: lt_selection   TYPE  gusl_t_selection.
  DATA: ls_selection   TYPE  gusl_s_selection.
  FIELD-SYMBOLS: <wa1> TYPE any.
  DATA: ls_selopt      TYPE rsdsselopt.
  DATA: ls_selopt_t    TYPE rsds_selopt_t.
  DATA: ld_si_table_fs TYPE tabname.
  DATA: ld_bsis_fs     TYPE tabname VALUE 'BSIS_FS'.
  DATA: ls_trange_tab_line TYPE rsds_range.
  DATA: ls_frange_tab_line TYPE rsds_frange.
  DATA: ld_stida       TYPE budat.
  DATA: ld_stida_2     TYPE budat.
  DATA: lt_augdt   TYPE range_date OCCURS 0 WITH HEADER LINE.
  DATA: lt_budat   TYPE range_date OCCURS 0 WITH HEADER LINE.
  RANGES: lt_saknr     FOR skb1-saknr.
  RANGES: lt_bukrs     FOR skb1-bukrs.
  RANGES: lt_bstat     FOR faglflexa-bstat.
  RANGES: lt_rldnr     FOR faglflexa-rldnr.
  RANGES: lt_xarch     FOR bsas-xarch.

  DATA: ld_lines LIKE sy-tabix.

* ledger
  IF  x_merk IS INITIAL
  AND x_park IS INITIAL
  AND x_erfs IS INITIAL.
    lt_rldnr-sign = 'I'.
    lt_rldnr-option = 'EQ'.
    lt_rldnr-low    = gv_relevant_ledger.
    APPEND lt_rldnr.

    REFRESH ls_selopt_t.
    LOOP AT lt_rldnr ASSIGNING <wa1>.
      MOVE-CORRESPONDING <wa1> TO ls_selopt.
      APPEND ls_selopt TO ls_selopt_t.
    ENDLOOP.
    ls_selection-fieldname = 'RLDNR'.
    ls_selection-t_range  = ls_selopt_t.
    APPEND ls_selection TO lt_selection.
  ENDIF.

* document status
  IF NOT x_norm IS INITIAL.
    lt_bstat-sign = 'I'.
    lt_bstat-option = 'EQ'.
    lt_bstat-low    = ' '.
    APPEND lt_bstat.
    IF NOT gv_relevant_ledger IS INITIAL.
      lt_bstat-sign = 'I'.
      lt_bstat-option = 'EQ'.
      lt_bstat-low    = 'L'.
      APPEND lt_bstat.
*Begin Added on 29-May-2022, Incluse BSTAT = U as well. This is as per the standard  program.
        lt_bstat-low    = if_fins_acdoc_constants=>gc_document_status-gl_only.
      APPEND lt_bstat.
      IF cl_fins_acdoc_util=>is_simulation_ledger( iv_rldnr = gv_relevant_ledger ) = abap_true.
        lt_bstat-low    = if_fins_acdoc_constants=>gc_document_status-gl_simulation.
        APPEND lt_bstat.
      ENDIF.
*      Posting to prediction ledger using BSTAT 'P'
      IF cl_fins_acdoc_util=>is_prediction_ledger( iv_rldnr = gv_relevant_ledger ) = abap_true.
        lt_bstat-low    = if_fins_acdoc_constants=>gc_document_status-predictive.
        APPEND lt_bstat.
      ENDIF.
* End of Added on 29-May-2022, Incluse BSTAT = U as well. This is as per the standard  program.
    ENDIF.
    IF gv_relevant_ledger = gv_leading_ledger
                          AND NOT x_glyec IS INITIAL.
      lt_bstat-sign = 'I'.
      lt_bstat-option = 'EQ'.
      lt_bstat-low    = 'J'.
      APPEND lt_bstat.
    ENDIF.
  ENDIF.
  IF NOT x_merk IS INITIAL.
    lt_bstat-sign = 'I'.
    lt_bstat-option = 'EQ'.
    lt_bstat-low    = 'S'.
    APPEND lt_bstat.
  ENDIF.
  IF NOT x_park IS INITIAL.
    lt_bstat-sign = 'I'.
    lt_bstat-option = 'EQ'.
    lt_bstat-low    = 'V'.
    APPEND lt_bstat.
    lt_bstat-sign = 'I'.
    lt_bstat-option = 'EQ'.
    lt_bstat-low    = 'W'.
    APPEND lt_bstat.
  ENDIF.
  REFRESH ls_selopt_t.
  LOOP AT lt_bstat ASSIGNING <wa1>.
    MOVE-CORRESPONDING <wa1> TO ls_selopt.
    APPEND ls_selopt TO ls_selopt_t.
  ENDLOOP.
  ls_selection-fieldname = 'BSTAT'.
  ls_selection-t_range  = ls_selopt_t.
  APPEND ls_selection TO lt_selection.


* dates
* if P_gb_xplacc is initial.
* normal date selection
  GET PARAMETER ID 'FI_STIDA' FIELD ld_stida_2.
  IF NOT ld_stida_2 IS INITIAL AND sy-subrc EQ 0.
    pa_stida = ld_stida_2.
    SET PARAMETER ID 'FI_STIDA' FIELD '00000000'.
  ENDIF.
  IF NOT x_opsel IS INITIAL.
    IF pa_stida IS INITIAL.
      p_keydate         = '99991231'.
      ld_stida          = '99991231'.
    ELSE.
      p_keydate         = pa_stida.
      ld_stida          = pa_stida.
    ENDIF.
    lt_budat-sign = 'I'.
    lt_budat-option = 'LE'.
    lt_budat-low    = ld_stida.
    APPEND lt_budat.
    lt_augdt-sign = 'I'.
    lt_augdt-option = 'GT'.
    lt_augdt-low    = ld_stida.
    APPEND lt_augdt.
    IF gd_usear = 'X'.                                      "1383956
      lt_augdt-sign = 'I'.                                  "1383956
      lt_augdt-option = 'EQ'.                               "1383956
      lt_augdt-low    = '00000000'.                         "1383956
      APPEND lt_augdt.                                      "1383956
    ENDIF.                                                  "1383956
  ENDIF.
  IF NOT x_clsel IS INITIAL.
    IF pa_stid2 IS INITIAL.
      p_keydate       = '99991231'.
      ld_stida        = '00010101'.
      LOOP AT so_augdt ASSIGNING <wa1>.
        MOVE-CORRESPONDING <wa1> TO lt_augdt.
        APPEND lt_augdt.
      ENDLOOP.
      IF lt_augdt[] IS INITIAL.                             "1041811
        lt_augdt-sign = 'I'.                                "1008367
        lt_augdt-option = 'BT'.                             "1008367
        lt_augdt-low    = '00010101'.                       "1008367
        lt_augdt-high   = '99991231'.                       "1008367
        APPEND lt_augdt.                                    "1008367
      ENDIF.                                                "1008367
    ELSE.
      p_keydate       = pa_stid2.
      ld_stida        = pa_stid2.
      LOOP AT so_augdt ASSIGNING <wa1>.
        MOVE-CORRESPONDING <wa1> TO lt_augdt.
        APPEND lt_augdt.
      ENDLOOP.
      lt_budat-sign = 'I'.
      lt_budat-option = 'LE'.
      lt_budat-low    = ld_stida.
      APPEND lt_budat.
      lt_augdt-sign = 'I'.
      lt_augdt-option = 'GT'.
      lt_augdt-low    = ld_stida.
      APPEND lt_augdt.
      IF lt_augdt[] IS INITIAL.                             "1041811
        lt_augdt-sign = 'I'.                                "1008367
        lt_augdt-option = 'BT'.                             "1008367
        lt_augdt-low    = '00010101'.                       "1008367
        lt_augdt-high   = '99991231'.                       "1008367
        APPEND lt_augdt.                                    "1008367
      ENDIF.                                                "1008367
    ENDIF.
  ENDIF.
  IF NOT x_aisel IS INITIAL.
    p_keydate         = '99991231'.
    ld_stida          = '99991231'.
    LOOP AT so_budat ASSIGNING <wa1>.
      MOVE-CORRESPONDING <wa1> TO lt_budat.
      APPEND lt_budat.
    ENDLOOP.
*    lt_budat-sign = 'I'.
*    lt_budat-option = 'LE'.
*    lt_budat-low    = ld_stida.
*    append lt_budat.
  ENDIF.

  pa_stida_default = ld_stida.

* expiring currencies:
  IF ld_stida IS INITIAL OR ld_stida = '00010101'
                         OR ld_stida = '99991231'.
    gd_alw_date = sy-datlo.
  ELSE.
    gd_alw_date = ld_stida.
  ENDIF.

*  CALL FUNCTION 'FAGL_ITEMS_LDB_SELECTIONS'
*    EXPORTING
*      RADIO_OPEN          = x_opsel
*      RADIO_CLEARED       = x_clsel
*      RADIO_ALL           = x_aisel
*      STIDA               = ld_stida
**   IMPORTING
**     OPOPT               =
**     APOPT               =
**     STIDA_RET           =
*    TABLES
*      AUGDT_IN            = so_augdt
*      BUDAT_IN            = so_budat
*      AUGDT_RET           = lt_AUGDT_RET
*      BUDAT_RET           = lt_BUDAT_RET
*    EXCEPTIONS
*      RADIO_ERROR         = 1
*      OTHERS              = 2
  .
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  IF NOT so_yrper[] IS INITIAL.
    IF p_gb_xplacc IS INITIAL.
* date selections for accounts excl PL accounts
    ELSE.
* date selections for PL accounts
* modify SO_YRPER:
***   has to be stored specially for 'refresh' of list         "1530241
      gt_yrper_old = so_yrper[].                            "1530241
      gt_yrper = so_yrper[].
      DESCRIBE TABLE gt_yrper LINES ld_lines.
      IF ld_lines EQ 1 .
        READ TABLE gt_yrper INTO gd_yrper INDEX 1.
        IF gd_yrper-sign = 'I' AND gd_yrper-option = 'BT'.
          gd_yrper-low(4) = gd_yrper-high(4).
          MODIFY gt_yrper FROM gd_yrper INDEX 1.
        ENDIF.
      ENDIF.
      so_yrper[] = gt_yrper.
*  loop at gt_yrper into gd_yrper.
*    clear it_selscreen.
*    it_selscreen-selname = 'SO_YRPER'.
*    it_selscreen-kind    = 'S'.
*    move-corresponding gd_yrper to it_selscreen.
*    append it_selscreen.
*  endloop.
    ENDIF.
  ENDIF.

* Called from RRI (possibly FAGLB03) and the Entry View        "1384389
* was set out of a migration for example.                      "1384389
  IF gv_xrric = 'X' AND gv_xerfs = 'X'.
    IF NOT so_yrper[] IS INITIAL.
      DATA:   period     TYPE poper OCCURS 0 WITH HEADER LINE.
      DATA:   year       TYPE ryear OCCURS 0 WITH HEADER LINE.
      RANGES: monat      FOR bkpf-monat.
      RANGES: poper      FOR faglflexa-poper.
      RANGES: gjahr      FOR bkpf-gjahr.
      RANGES: ryear      FOR faglflexa-ryear.
      DATA:   ld_line_yp LIKE sy-tabix.

      LOOP AT so_yrper.
        year = so_yrper-low(4).
        IF NOT year IS INITIAL.
          APPEND year.
        ENDIF.
        year = so_yrper-high(4).
        IF NOT year IS INITIAL.
          APPEND year.
        ENDIF.
        period = so_yrper-low+4(3).
        IF NOT period IS INITIAL.
          APPEND period.
        ENDIF.
        IF so_yrper-low(4) = '1950'.
          period = '016'.
          APPEND period.
        ELSE.
          period = so_yrper-high+4(3).
          IF NOT period IS INITIAL.
            APPEND period.
          ENDIF.
        ENDIF.
      ENDLOOP.

      SORT period.
      SORT year.
      DELETE ADJACENT DUPLICATES FROM period.
      DELETE ADJACENT DUPLICATES FROM year.

      DESCRIBE TABLE period LINES ld_line_yp.
      IF ld_line_yp = 1.
        READ TABLE period INDEX 1.
        CLEAR monat.
        monat-option = 'EQ'.
        monat-sign   = 'I'.
        monat-low    = period.
        APPEND monat.
      ELSE.
        READ TABLE period INDEX 1.
        CLEAR monat.
        monat-option = 'BT'.
        monat-sign   = 'I'.
        monat-low    = period.
        READ TABLE period INDEX ld_line_yp.
        monat-high   = period.
        APPEND monat.
      ENDIF.

      DESCRIBE TABLE year LINES ld_line_yp.
      IF ld_line_yp = 1.
        READ TABLE year INDEX 1.
        CLEAR gjahr.
        gjahr-option = 'EQ'.
        gjahr-sign   = 'I'.
        gjahr-low    = year.
        APPEND gjahr.
      ELSE.
        READ TABLE year INDEX 1.
        CLEAR gjahr.
        gjahr-option = 'BT'.
        gjahr-sign   = 'I'.
        gjahr-low    = year.
        READ TABLE year INDEX ld_line_yp.
        gjahr-high   = year.
        APPEND gjahr.
      ENDIF.

      REFRESH ls_selopt_t.
      LOOP AT monat ASSIGNING <wa1>.
        MOVE-CORRESPONDING <wa1> TO ls_selopt.
        APPEND ls_selopt TO ls_selopt_t.
      ENDLOOP.
      ls_selection-fieldname = 'MONAT'.
      ls_selection-t_range  = ls_selopt_t.
      APPEND ls_selection TO lt_selection.
      REFRESH ls_selopt_t.
      LOOP AT gjahr ASSIGNING <wa1>.
        MOVE-CORRESPONDING <wa1> TO ls_selopt.
        APPEND ls_selopt TO ls_selopt_t.
      ENDLOOP.
      ls_selection-fieldname = 'GJAHR'.
      ls_selection-t_range  = ls_selopt_t.
      APPEND ls_selection TO lt_selection.
      REFRESH ls_selopt_t.
      LOOP AT poper ASSIGNING <wa1>.
        MOVE-CORRESPONDING <wa1> TO ls_selopt.
        APPEND ls_selopt TO ls_selopt_t.
      ENDLOOP.
    ENDIF.
  ENDIF.                                                    "1384389

  REFRESH ls_selopt_t.
  LOOP AT lt_budat ASSIGNING <wa1>.
    MOVE-CORRESPONDING <wa1> TO ls_selopt.
    APPEND ls_selopt TO ls_selopt_t.
  ENDLOOP.
  ls_selection-fieldname = 'BUDAT'.
  ls_selection-t_range  = ls_selopt_t.
  APPEND ls_selection TO lt_selection.

  REFRESH ls_selopt_t.
  IF pa_stid2 IS INITIAL.                                   "1041811
    LOOP AT lt_augdt ASSIGNING <wa1>.                       "1041811
      MOVE-CORRESPONDING <wa1> TO ls_selopt.                "1041811
      APPEND ls_selopt TO ls_selopt_t.                      "1041811
    ENDLOOP.                                                "1041811
    ls_selection-fieldname = 'AUGDT'.                       "1041811
    ls_selection-t_range  = ls_selopt_t.                    "1041811
    APPEND ls_selection TO lt_selection.                    "1041811
  ELSE.                                                     "1041811
    LOOP AT lt_augdt ASSIGNING <wa1>.                       "1041811
      MOVE-CORRESPONDING <wa1> TO ls_selopt.                "1041811
      APPEND ls_selopt TO ls_selopt_t.                      "1041811
      ls_selection-fieldname = 'AUGDT'.                     "1041811
      ls_selection-t_range  = ls_selopt_t.                  "1041811
      APPEND ls_selection TO lt_selection.                  "1041811
      REFRESH ls_selopt_t.                                  "1041811
    ENDLOOP.                                                "1041811
  ENDIF.                                                    "1041811

* free selections
  LOOP AT fs_dyns-trange INTO ls_trange_tab_line
    WHERE tablename = ld_bsis_fs.
    LOOP AT ls_trange_tab_line-frange_t INTO ls_frange_tab_line.
      CLEAR ls_selection.
      ls_selection = ls_frange_tab_line.
      APPEND ls_selection TO lt_selection.
    ENDLOOP.
  ENDLOOP.

  CONCATENATE gv_si_table '_FS' INTO ld_si_table_fs.
  LOOP AT fs_dyns-trange INTO ls_trange_tab_line
    WHERE tablename = ld_si_table_fs.
    LOOP AT ls_trange_tab_line-frange_t INTO ls_frange_tab_line.
      CLEAR ls_selection.
      ls_selection = ls_frange_tab_line.
      APPEND ls_selection TO lt_selection.
    ENDLOOP.
  ENDLOOP.

* If only data from database should be selected,
* archived data should not be selected
  IF gd_usear IS INITIAL AND x_erfs IS INITIAL.             "1437369
    lt_xarch-sign = 'I'.
    lt_xarch-option = 'EQ'.
    lt_xarch-low  = ' '.
    APPEND lt_xarch.
    REFRESH ls_selopt_t.
    LOOP AT lt_xarch ASSIGNING <wa1>.
      MOVE-CORRESPONDING <wa1> TO ls_selopt.
      APPEND ls_selopt TO ls_selopt_t.
    ENDLOOP.
    ls_selection-fieldname = 'XARCH'.
    ls_selection-t_range  = ls_selopt_t.
    APPEND ls_selection TO lt_selection.
  ENDIF.
* modify selections according to year period selection
*  if not so_yrper[] is initial.
*    data:   period     type poper occurs 0 with header line.
*    data:   year       type ryear occurs 0 with header line.
*    Ranges: monat      for bkpf-monat.
*    ranges: poper      for faglflexa-poper.
*    Ranges: gjahr      for bkpf-gjahr.
*    ranges: ryear      for faglflexa-ryear.
*    data:   ld_line_yp like sy-tabix.
*
*    loop at so_yrper.
*      period = so_yrper-low+4(3).
*      if not period is initial.
*        append period.
*      endif.
*      period = so_yrper-high+4(3).
*      if not period is initial.
*        append period.
*      endif.
*      year = so_yrper-low(4).
*      if not year is initial.
*        append year.
*      endif.
*      year = so_yrper-high(4).
*      if not year is initial.
*        append year.
*      endif.
*    endloop.
*
*    sort period.
*    sort year.
*    DELETE ADJACENT DUPLICATES FROM period.
*    DELETE ADJACENT DUPLICATES FROM year.
*
*    describe table period lines ld_line_yp.
*    if ld_line_yp = 1.
*      read table period index 1.
*      if  x_merk is initial
*      and x_erfs is initial.
*        clear poper.
*        poper-option = 'EQ'.
*        poper-sign   = 'I'.
*        poper-low    = period.
*        append poper.
*      else.
*        clear monat.
*        monat-option = 'EQ'.
*        monat-sign   = 'I'.
*        monat-low    = period.
*        append monat.
*      endif.
*    else.
*      read table period index 1.
*      if  x_merk is initial
*      and x_erfs is initial.
*        clear poper.
*        poper-option = 'BT'.
*        poper-sign   = 'I'.
*        poper-low    = period.
*        read table period index ld_line_yp.
*        poper-high   = period.
*        append poper.
*      else.
*        clear monat.
*        monat-option = 'BT'.
*        monat-sign   = 'I'.
*        monat-low    = period.
*        read table period index ld_line_yp.
*        monat-high   = period.
*        append monat.
*      endif.
*    endif.
*
*    describe table year lines ld_line_yp.
*    if ld_line_yp = 1.
*      read table year index 1.
*      if  x_merk is initial
*      and x_erfs is initial.
*        clear ryear.
*        ryear-option = 'EQ'.
*        ryear-sign   = 'I'.
*        ryear-low    = year.
*        append ryear.
*      else.
*        clear gjahr.
*        gjahr-option = 'EQ'.
*        gjahr-sign   = 'I'.
*        gjahr-low    = year.
*        append gjahr.
*      endif.
*    else.
*      read table year index 1.
*      if  x_merk is initial
*      and x_erfs is initial.
*        clear ryear.
*        ryear-option = 'BT'.
*        ryear-sign   = 'I'.
*        ryear-low    = year.
*        read table year index ld_line_yp.
*        ryear-high   = year.
*        append ryear.
*      else.
*        clear gjahr.
*        gjahr-option = 'BT'.
*        gjahr-sign   = 'I'.
*        gjahr-low    = year.
*        read table year index ld_line_yp.
*        gjahr-high   = year.
*        append gjahr.
*      endif.
*    endif.
*
*    refresh ls_selopt_t.
*    loop at monat assigning <wa1>.
*      move-corresponding <wa1> to ls_selopt.
*      append ls_selopt to ls_selopt_t.
*    endloop.
*    ls_SELECTION-fieldname = 'MONAT'.
*    ls_SELECTION-T_RANGE  = Ls_selopt_t.
*    append ls_SELECTION to lt_SELECTION.
*    refresh ls_selopt_t.
*    loop at gjahr assigning <wa1>.
*      move-corresponding <wa1> to ls_selopt.
*      append ls_selopt to ls_selopt_t.
*    endloop.
*    ls_SELECTION-fieldname = 'GJAHR'.
*    ls_SELECTION-T_RANGE  = Ls_selopt_t.
*    append ls_SELECTION to lt_SELECTION.
*    refresh ls_selopt_t.
*    loop at poper assigning <wa1>.
*      move-corresponding <wa1> to ls_selopt.
*      append ls_selopt to ls_selopt_t.
*    endloop.
*    ls_SELECTION-fieldname = 'POPER'.
*    ls_SELECTION-T_RANGE  = Ls_selopt_t.
*    append ls_SELECTION to lt_SELECTION.
*    refresh ls_selopt_t.
*    loop at RYEAR assigning <wa1>.
*      move-corresponding <wa1> to ls_selopt.
*      append ls_selopt to ls_selopt_t.
*    endloop.
*    ls_SELECTION-fieldname = 'RYEAR'.
*    ls_SELECTION-T_RANGE  = Ls_selopt_t.
*    append ls_SELECTION to lt_SELECTION.
*  endif.

* archiving nothing neccesary

  p_gt_selection_part[] = lt_selection[].

ENDFORM.                    "map_sel_to_items

*&---------------------------------------------------------------------*
*&      Form  SET_PARAMETERS
*&---------------------------------------------------------------------*
FORM set_parameters.
* set general parameters:
  PERFORM set_general_param.
* set acc.type specific parameters:
  CLEAR: sd_saknr, sd_bukrs.
  CLEAR: so_wlsak, so_wlbuk.
  IF gd_wl_on IS INITIAL.
    READ TABLE sd_saknr INDEX 1.
    IF sy-subrc = 0 AND sd_saknr-sign = 'I' AND sd_saknr-option = 'EQ'
        AND NOT sd_saknr-low IS INITIAL.
      SET PARAMETER ID 'SAK' FIELD sd_saknr-low.
    ENDIF.
    READ TABLE sd_bukrs INDEX 1.
    IF sy-subrc = 0 AND sd_bukrs-sign = 'I' AND sd_bukrs-option = 'EQ'
        AND NOT sd_bukrs-low IS INITIAL.
      SET PARAMETER ID 'BUK' FIELD sd_bukrs-low.
    ENDIF.
    SET PARAMETER ID 'AVS' FIELD space.
    SET PARAMETER ID 'AVB' FIELD space.
  ELSE.
*   worklists switched on:
    SET PARAMETER ID 'AVS' FIELD pa_wlsak.
    SET PARAMETER ID 'AVB' FIELD pa_wlbuk.
    READ TABLE so_wlsak INDEX 1.
    IF sy-subrc = 0 AND so_wlsak-sign = 'I' AND so_wlsak-option = 'EQ'
        AND NOT so_wlsak-low IS INITIAL.
      SET PARAMETER ID 'SAK' FIELD so_wlsak-low.
    ENDIF.
    READ TABLE so_wlbuk INDEX 1.
    IF sy-subrc = 0 AND so_wlbuk-sign = 'I' AND so_wlbuk-option = 'EQ'
        AND NOT so_wlbuk-low IS INITIAL.
      SET PARAMETER ID 'BUK' FIELD so_wlbuk-low.
    ENDIF.
  ENDIF.

* Set parameters for reading from archiv
  gd_usear = sd_usear.
  gd_usedb = sd_usedb.
  gd_memor = 'X'.

  gd_objec   = sd_objec.
  gd_useas   = sd_useas.
  IF gd_useas IS INITIAL.
    gt_files[] = sd_files[].
  ENDIF.
  gd_iarch   = sd_iarch.

ENDFORM.                    "set_parameters

*&---------------------------------------------------------------------*
*&      Form  SET_ACCT_AND_CCODE
*&---------------------------------------------------------------------*
FORM set_acct_and_ccode.

  REFRESH: sd_saknr, sd_bukrs, so_wlsak, so_wlbuk.
  CLEAR:   sd_saknr, sd_bukrs, so_wlsak, so_wlbuk,
           pa_wlsak, pa_wlbuk.

  IF gd_wl_on IS INITIAL.
    GET PARAMETER ID 'SAK' FIELD sd_saknr-low.
    IF sy-subrc = 0 AND NOT sd_saknr-low IS INITIAL.
      sd_saknr-sign   = 'I'.
      sd_saknr-option = 'EQ'.
      APPEND sd_saknr.
    ENDIF.
    GET PARAMETER ID 'BUK' FIELD sd_bukrs-low.
    IF sy-subrc = 0 AND NOT sd_bukrs-low IS INITIAL.
      sd_bukrs-sign   = 'I'.
      sd_bukrs-option = 'EQ'.
      APPEND sd_bukrs.
    ENDIF.
  ELSE.
*   worklists switched on:
    GET PARAMETER ID 'AVS' FIELD pa_wlsak.
    GET PARAMETER ID 'AVB' FIELD pa_wlbuk.
    IF pa_wlsak IS INITIAL.
      GET PARAMETER ID 'SAK' FIELD so_wlsak-low.
      IF sy-subrc = 0 AND NOT so_wlsak-low IS INITIAL.
        so_wlsak-sign   = 'I'.
        so_wlsak-option = 'EQ'.
        APPEND so_wlsak.
      ENDIF.
    ENDIF.
    IF pa_wlbuk IS INITIAL.
      GET PARAMETER ID 'BUK' FIELD so_wlbuk-low.
      IF sy-subrc = 0 AND NOT so_wlbuk-low IS INITIAL.
        so_wlbuk-sign   = 'I'.
        so_wlbuk-option = 'EQ'.
        APPEND so_wlbuk.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                               " SET_ACCT_AND_CCODE

*&---------------------------------------------------------------------*
*&      Form  exclude_pl_acounts
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM exclude_pl_accounts .

  DATA: ld_lines TYPE i.
  DATA: ls_account_slt TYPE gty_acccoco.

  IF  sy-calld = 'X' AND
  NOT ( so_yrper[] IS INITIAL
  OR NOT gv_xumsav IS INITIAL ).
*    ( sy-tcode = 'FAGLB03' or sy-tcode cp 'S+38'
*      or sy-tcode eq 'SE80' ).

* make copy of sd_saknr
    gt_saknr = sd_saknr[].
    gt_bukrs = sd_bukrs[].                                  "1530241

* Exclude PL accounts.
* check if worklist or not

    DESCRIBE TABLE sd_saknr LINES ld_lines.
    LOOP AT sd_saknr TRANSPORTING NO FIELDS
         WHERE sign NE 'I' OR
               option NE 'EQ'.
      EXIT.
    ENDLOOP.
    IF sy-subrc = 0 OR ld_lines = 0.
      SELECT        s~saknr t~bukrs s~gvtyp
               INTO TABLE gt_accoco
               FROM t001 AS t INNER JOIN ska1 AS s
                 ON t~ktopl =  s~ktopl
              WHERE t~bukrs IN sd_bukrs
      AND s~saknr IN sd_saknr.
    ELSE.                                       "worklist.
      SELECT        s~saknr t~bukrs s~gvtyp
               INTO  gd_accoco
               FROM t001 AS t INNER JOIN ska1 AS s
                 ON t~ktopl =  s~ktopl
                FOR ALL ENTRIES IN sd_saknr
              WHERE t~bukrs IN sd_bukrs
                AND s~saknr = sd_saknr-low.
        APPEND gd_accoco TO gt_accoco.
      ENDSELECT.
    ENDIF.

* PL account numbers remain in GT_ACCOCO
* all others are transfered into SD_SAKNR.
    REFRESH sd_saknr.
    CLEAR sd_saknr.
    sd_saknr-sign   = 'I'.
    sd_saknr-option = 'EQ'.
    REFRESH sd_bukrs.                                       "1573934
    CLEAR sd_bukrs.                                         "1573934
    sd_bukrs-sign = 'I'.                                    "1573934
    sd_bukrs-option = 'EQ'.                                 "1573934
    LOOP AT gt_accoco INTO gd_accoco WHERE gvtyp = space.
      DELETE gt_accoco INDEX sy-tabix.
      sd_saknr-low = gd_accoco-saknr.
      APPEND sd_saknr.
      sd_bukrs-low = gd_accoco-bukrs.                       "1050960
      APPEND sd_bukrs.                                      "1322995
    ENDLOOP.
    IF sd_saknr[] IS INITIAL.
      APPEND sd_saknr.
    ENDIF.
    IF sd_bukrs[] IS INITIAL.                               "1573934
      APPEND sd_bukrs.                                      "1573934
    ENDIF.                                                  "1573934

    DELETE ADJACENT DUPLICATES FROM sd_saknr                "1728409
                          COMPARING sign option low high.   "1728409
    DELETE ADJACENT DUPLICATES FROM sd_bukrs                "1728409
                          COMPARING sign option low high.   "1728409

* classify Settlement Accounts
    REFRESH gt_accoco_slt.
    LOOP AT gt_account_slt INTO ls_account_slt.
      LOOP AT gt_accoco INTO gd_accoco
        WHERE saknr = ls_account_slt-saknr
        AND   bukrs = ls_account_slt-bukrs.
        ls_account_slt-gvtyp = gd_accoco-gvtyp.
        APPEND ls_account_slt TO gt_accoco_slt.
      ENDLOOP.
      IF sy-subrc = 0.
        DELETE gt_account_slt.
      ENDIF.
    ENDLOOP.

  ENDIF.
ENDFORM.                    " exclude_pl_acounts

*&--------------------------------------------------------------------*
*&      Form  include_pl_accounts
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
FORM include_pl_accounts.
  DATA: sak_name   LIKE kna1-name1.
  DATA: ld_f_bkpf_bes_subrc LIKE sy-subrc.


  IF  sy-calld = 'X'
  AND NOT so_yrper[] IS INITIAL
  AND gv_xumsav IS INITIAL.

    AUTHORITY-CHECK OBJECT 'F_BKPF_KOA'
      ID 'KOART' FIELD 'S'
      ID 'ACTVT' FIELD '03'.
    IF sy-subrc NE 0.
      deco_message_2 e812(fr) with TEXT-300 'S'.
    ENDIF.

    gb_xplacc = 'X'.
* map selections to lineitem selection logic:
    PERFORM map_sel_to_items USING gb_xplacc
                             CHANGING gt_selection_part.

    LOOP AT gt_accoco INTO gd_accoco.

      PERFORM t001_info_fill USING gd_accoco-bukrs.

* fill work area fields
      skb1-saknr = gd_accoco-saknr.
      skb1-bukrs = gd_accoco-bukrs.

* authority check
      SELECT SINGLE begru xkres xopvw mitkz xlgclr FROM skb1 "1174335
        INTO CORRESPONDING FIELDS OF skb1
        WHERE saknr = gd_accoco-saknr
      AND   bukrs = gd_accoco-bukrs.

* ONLY select the data, if the account is defined in the       "1361304
* Company Code. Check was before done in the LDB_PROCESS       "1361304
      IF sy-subrc = 0.                                      "1361304

        CLEAR ld_f_bkpf_bes_subrc.
        IF NOT skb1-begru IS INITIAL.
          AUTHORITY-CHECK OBJECT 'F_BKPF_BES'
                   ID 'BRGRU' FIELD skb1-begru
                   ID 'ACTVT' FIELD '03'.
          IF sy-subrc <> 0.
            ld_f_bkpf_bes_subrc = sy-subrc.
            sy-subrc = 0.
          ENDIF.
          AUTHORITY-CHECK OBJECT 'F_SKA1_BES'
                      ID 'BRGRU' FIELD skb1-begru
                      ID 'ACTVT' FIELD '03'.
          IF NOT sy-subrc IS INITIAL
          OR NOT ld_f_bkpf_bes_subrc IS INITIAL.
            CONTINUE.
          ENDIF.
        ENDIF.

        PERFORM check_slt_account USING skb1-saknr
                                      skb1-bukrs
                                      skb1-xkres
                                      gb_xplacc.

* map selection to lineitem selection ranges
* add masterdata information
        PERFORM map_sel_to_items_mast_dat USING
                                          gb_xplacc
                                          gt_selection_part
                                        CHANGING
                                          gt_selection_full.

* select items and fill them in Output table
        CLEAR gv_special_account.                           "1822909
        PERFORM check_trtm_account.                         "1004374
        PERFORM check_glyec_account.                        "1834289
        PERFORM select_items.
        IF NOT x_stop IS INITIAL.
          EXIT. "#EC CI_NOORDER for Hana Migration <VIKAS> Charm - 1100008668   TR -HRDK979834
        ENDIF.
* fill account text
        PERFORM skat_info_fill.
*     write skat-txt50 to sak_name.
        WRITE it_h_skat-txt50 TO sak_name.
        PERFORM fill_acct_table USING  'S'
                                       gd_accoco-saknr
                                       gd_accoco-bukrs
                                       space
                                       sak_name
                                       gd_accoco-saknr.

      ENDIF.                                                "1361304

    ENDLOOP.

* restore accounts (for refresh of list).
    sd_saknr[] = gt_saknr.
    sd_bukrs[] = gt_bukrs.                                  "1530241
    so_yrper[] = gt_yrper_old.                              "1530241

  ENDIF.

ENDFORM.                    "include_pl_accounts

*&--------------------------------------------------------------------*
*&      Form  sdf_selscreen
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
FORM sdf_selscreen.

  DATA: ld_lines TYPE sytabix.

  REFRESH: it_selscreen.
* fill selections: first single values & parameters
  it_selscreen-selname = 'SD_SAKNR'.
  it_selscreen-kind    = 'S'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = gd_accoco-saknr.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_BUKRS'.
  it_selscreen-kind    = 'S'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = gd_accoco-bukrs.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_OPOPT'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_opopt.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_APOPT'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_apopt.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_STIDA'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_stida.
  APPEND it_selscreen.
* now select option tables:
  LOOP AT sd_augdt.
    CLEAR it_selscreen.
    it_selscreen-selname = 'SD_AUGDT'.
    it_selscreen-kind    = 'S'.
    MOVE-CORRESPONDING sd_augdt TO it_selscreen.
    APPEND it_selscreen.
  ENDLOOP.
  LOOP AT sd_budat.
    CLEAR it_selscreen.
    it_selscreen-selname = 'SD_BUDAT'.
    it_selscreen-kind    = 'S'.
    MOVE-CORRESPONDING sd_budat TO it_selscreen.
    APPEND it_selscreen.
  ENDLOOP.

* modify SO_YRPER:
  gt_yrper = so_yrper[].
  DESCRIBE TABLE gt_yrper LINES ld_lines.
  IF ld_lines EQ 1 .
    READ TABLE gt_yrper INTO gd_yrper INDEX 1.
    IF gd_yrper-sign = 'I' AND gd_yrper-option = 'BT'.
      gd_yrper-low(4) = gd_yrper-high(4).
      MODIFY gt_yrper FROM gd_yrper INDEX 1.
    ENDIF.
  ENDIF.
  LOOP AT gt_yrper INTO gd_yrper.
    CLEAR it_selscreen.
    it_selscreen-selname = 'SO_YRPER'.
    it_selscreen-kind    = 'S'.
    MOVE-CORRESPONDING gd_yrper TO it_selscreen.
    APPEND it_selscreen.
  ENDLOOP.
  IF sy-subrc <> 0.
    sy-subrc = 0.
  ENDIF.

* Parameters and Select Options for Archives
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_USEDB'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_usedb.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_USEAR'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_usear.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_USEAS'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_useas.
  APPEND it_selscreen.
  IF NOT sd_files[] IS INITIAL.
    LOOP AT sd_files.
      CLEAR it_selscreen.
      it_selscreen-selname = 'SD_FILES'.
      it_selscreen-kind    = 'S'.
      MOVE-CORRESPONDING sd_files TO it_selscreen.
      APPEND it_selscreen.
    ENDLOOP.
  ENDIF.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_MEMOR'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_memor.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_IARCH'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_iarch.
  APPEND it_selscreen.

  CLEAR it_selscreen.
  it_selscreen-selname = 'SD_NOOAP'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = sd_nooap.
  APPEND it_selscreen.

* Set parameters for reading from archiv
  gd_usear = sd_usear.
  gd_usedb = sd_usedb.
  gd_memor = 'X'.

  gd_objec   = sd_objec.
  gd_useas   = sd_useas.
  IF gd_useas IS INITIAL.
    gt_files[] = sd_files[].
  ENDIF.
  gd_iarch   = sd_iarch.

ENDFORM.                               " SDF_SELSCREEN
*&--------------------------------------------------------------------*
*&      Form  sdf_dynamics
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
*form sdf_dynamics.
*
*  data: rt_dyn_trange  type rsds_trange.
*  data: ld_rsds_expr type rsds_expr,
*        ld_rsdsexpr  type rsdsexpr.
*
*  refresh: it_dyn_texpr.
** get report dynamic selections:
*  call function 'RS_REFRESH_FROM_DYNAMICAL_SEL'
*    EXPORTING
*      curr_report        = g_repid
*      mode_write_or_move = 'M'
*    IMPORTING
*      p_trange           = rt_dyn_trange
*    EXCEPTIONS
*      not_found          = 1
*      wrong_type         = 2
*      others             = 3.
*  if sy-subrc ne 0.
*    exit.
*  endif.
** delete rt_dyn_trange where tablename ne 'BSIS'.
*"740027
*  call function 'FREE_SELECTIONS_RANGE_2_EX'
*    EXPORTING
*      field_ranges = rt_dyn_trange
*    IMPORTING
*      expressions  = it_dyn_texpr[].
*  loop at it_dyn_texpr into ld_rsds_expr where tablename = 'BSIS'.
*    loop at ld_rsds_expr-expr_tab into ld_rsdsexpr
*             where fieldname = 'GJAHR' or fieldname = 'MONAT'.
*      if ld_rsdsexpr-fieldname = 'GJAHR'.
*        if     ld_rsdsexpr-option = 'BT'
*           and ld_rsdsexpr-low ne ld_rsdsexpr-high.
*          ld_rsdsexpr-option = 'EQ'.
*          ld_rsdsexpr-low = ld_rsdsexpr-high.
*          clear ld_rsdsexpr-high.
*          modify ld_rsds_expr-expr_tab from ld_rsdsexpr.
*        endif.
*      elseif ld_rsdsexpr-fieldname = 'MONAT'.
*        if ld_rsdsexpr-option = 'BT'.
*          ld_rsdsexpr-high = so_yrper-high+5.
*          modify ld_rsds_expr-expr_tab from ld_rsdsexpr.
*        endif.
*      endif.
*    endloop.
*    modify it_dyn_texpr from ld_rsds_expr.
*  endloop.
*
*endform.                    "sdf_dynamics

*&--------------------------------------------------------------------*
*&      Form  fill_sdf_callback
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
*form fill_sdf_callback.
*  refresh: it_callback.
*  it_callback-ldbnode = 'BSIS'.
*  it_callback-get     = 'X'.
*  it_callback-cb_prog = c_repid_fagl_gl.
*  it_callback-cb_form = 'CB_SDF_GET_BSIS'.
*  append it_callback.
*endform.                    "fill_sdf_callback

*&--------------------------------------------------------------------*
*&      Form  cb_sdf_get_bsis
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
*      -->NAME       text
*      -->LS_BSIS    text
*      -->MODE       text
*      -->SELECTED   text
*---------------------------------------------------------------------*
*form cb_sdf_get_bsis  using  name     like ldbn-ldbnode
*                             ls_bsis  like bsis
*                             mode     type c
*                             selected type c.
*  bsis = ls_bsis.
*  perform pos_table_fill  changing  x_stop.
*endform.                    "cb_sdf_get_bsis


*&---------------------------------------------------------------------*
*&     Include RFITEM_INC
*&---------------------------------------------------------------------*
INCLUDE fagl_account_items_inc.

*----------------------------------------------------------------------*
*      New Forms
*----------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*&      Form  FS_SET_SSCRTEXTS_DYNSEL
*&---------------------------------------------------------------------*
*       Text fÃ¼r Drucktaste
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fs_set_sscrtexts_dynsel CHANGING p_text " LIKE SSCRTEXTS-DYNSEL.
                                             LIKE smp_dyntxt.
  DATA l_text LIKE smp_dyntxt.

  MOVE: icon_fencing TO l_text-icon_id,
        'Free selections'(270) TO l_text-text.              "#EC *

  IF fs_num > 0.
    WRITE fs_num TO l_text-icon_text(2).
    MOVE 'active'(271) TO l_text-icon_text+3.               "#EC *
  ENDIF.
  p_text = l_text.

ENDFORM.                               " SET_SSCRTEXTS_DYNSEL
*&---------------------------------------------------------------------*
*&      Form  FS_SET_SSCRTEXTS_DYNSEL3
*&---------------------------------------------------------------------*
*       Text fÃ¼r Drucktaste
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fs_set_sscrtexts_dynsel3 CHANGING p_text " LIKE SSCRTEXTS-DYNSEL.
                                             LIKE smp_dyntxt.
  DATA l_text LIKE smp_dyntxt.

  MOVE: icon_other_object TO l_text-icon_id,
        TEXT-272 TO l_text-text.                            "#EC *
  MOVE TEXT-272 TO l_text-icon_text.

  p_text = l_text.

ENDFORM.                               " SET_SSCRTEXTS_DYNSEL
*&---------------------------------------------------------------------*
*&      Form  FS_SET_SSCRTEXTS_DYNSEL4
*&---------------------------------------------------------------------*
*       Text fÃ¼r Drucktaste
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fs_set_sscrtexts_dynsel4 CHANGING p_text " LIKE SSCRTEXTS-DYNSEL.
                                             LIKE smp_dyntxt.
  DATA l_text LIKE smp_dyntxt.
  DATA ld_text LIKE l_text-text.

  IF gv_xerfs IS INITIAL.
    ld_text = TEXT-278.
  ELSE.
    ld_text = TEXT-277.
  ENDIF.

  MOVE: icon_summarize_undo TO l_text-icon_id,
        ld_text TO l_text-text.                             "#EC *
  MOVE  ld_text TO l_text-icon_text.

  p_text = l_text.

ENDFORM.                               " SET_SSCRTEXTS_DYNSEL

*&---------------------------------------------------------------------*
*&      Form  choose_ledger
*&---------------------------------------------------------------------*
FORM choose_ledger
            TABLES it_chosen_values TYPE ty_sval
            USING uc_relevant_ledger TYPE rldnr_flex
            CHANGING cc_new_ledger TYPE rldnr_flex.

  INCLUDE <icon>.

  DATA ic_icon_okay LIKE icon-name.
  DATA ic_icon_save LIKE icon-name.

* set exporting parameters for function modul
* POPUP_GET_VALUES_USER_BUTTONS
*  it_chosen_values-tabname = 'T881'.
*  it_chosen_values-fieldname = 'RLDNR'.
  it_chosen_values-tabname = 'BKPF'.
  it_chosen_values-fieldname = 'RLDNR'.
  it_chosen_values-field_obl = 'X'.
  it_chosen_values-value     = uc_relevant_ledger.
  APPEND it_chosen_values.

  ic_icon_okay = icon_okay.
  ic_icon_save = icon_system_save.

* call function modul

  CALL FUNCTION 'POPUP_GET_VALUES_USER_BUTTONS'
    EXPORTING
*     F1_FORMNAME        = ' '
*     F1_PROGRAMNAME     = ' '
      f4_formname        = 'F4_LEDGER'
      f4_programname     = 'FAGL_ACCOUNT_BALANCE'
      formname           = 'CHECK_OK_CODES'
      programname        = 'FAGL_ACCOUNT_BALANCE'
      popup_title        = 'Ledger setzen'(275)
      ok_pushbuttontext  = ''
      icon_ok_push       = ic_icon_okay
      quickinfo_ok_push  = TEXT-273
      first_pushbutton   = ' '
      icon_button_1      = ic_icon_save
      quickinfo_button_1 = TEXT-274
*     SECOND_PUSHBUTTON  = ' '
*     ICON_BUTTON_2      =
*     QUICKINFO_BUTTON_2 = ' '
      start_column       = '25'
      start_row          = '7'
*     NO_CHECK_FOR_FIXED_VALUES       = ' '
* IMPORTING
*     RETURNCODE         =
    TABLES
      fields             = it_chosen_values
    EXCEPTIONS
      error_in_fields    = 1
      OTHERS             = 2.

  IF sy-subrc <> 0.
    deco_message_sy.
  ENDIF.

  cc_new_ledger = it_chosen_values-value.

ENDFORM.                    " choose_ledger

*----------------------------------------------------------------------*
*   form worklist_on_off_new
*   set worklist flag on <-> off, set button text accordingly
*----------------------------------------------------------------------*
*form worklist_on_off_new.
*
*  data: ld_value   type c.
*
*  if gd_wl_on = c_x.
*    perform wl_memory_set_get using c_x
*                                    ld_value.
*  else.
*    ld_value = c_x.
*    perform wl_memory_set_get using c_x
*                                    ld_value.
*  endif.
*  perform wl_flag_and_button.
*
*endform.                    "worklist_on_off

*&---------------------------------------------------------------------*
*&      Form  find_relevant_ledger
*&---------------------------------------------------------------------*
FORM find_relevant_ledger CHANGING cc_relevant_ledger TYPE fagl_rldnr.

*  DATA lv_return_code TYPE syst-subrc.
*  DATA lv_ledger_user_format TYPE usr05-parva.

* Access to user master data for the ledger.
* open question: Is the parameter ID correct?

*  CALL FUNCTION 'G_GET_USER_PARAMETER'
*    EXPORTING
*      parameter_id    = 'GLN_FLEX'
*    IMPORTING
*      parameter_value = lv_ledger_user_format
*      rc              = lv_return_code.

  CALL FUNCTION 'GL_USER_DATA_GET'
    EXPORTING
      owner          = gc_owner
      name           = gc_parameter_id
    IMPORTING
      value          = cc_relevant_ledger
    EXCEPTIONS
      invalid_owner  = 1
      name_not_found = 2.

*  cc_relevant_ledger = lv_ledger_user_format.

* If program runs in decouple mode use ledger from API
  IF cl_fin_ui_deco=>mv_mode = abap_true.
    IF NOT gv_deco_ledger IS INITIAL.
      cc_relevant_ledger = gv_deco_ledger.
      sy-subrc = 0.
    ENDIF.
  ENDIF.

  IF sy-subrc NE 0.
* default ledger.
    CALL FUNCTION 'FAGL_GET_LEADING_LEDGER'
      IMPORTING
        e_rldnr   = cc_relevant_ledger
      EXCEPTIONS
        not_found = 1.

    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
  ENDIF.

ENDFORM.                    " find_relevant_ledger

*&---------------------------------------------------------------------*
*&      Form  FREE_SELECTIONS
*&---------------------------------------------------------------------*
*       free selections
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM free_selections.
*? DATA BEGIN OF P_TABLES OCCURS 10.
*?          INCLUDE STRUCTURE RSDSTABS.
*?  DATA END   OF P_TABLES.
  DATA BEGIN OF tables_tab OCCURS 10.
  INCLUDE STRUCTURE rsdstabs.
  DATA END   OF tables_tab.
*Felder obiger Tabellen
  DATA: BEGIN OF fields OCCURS 10.
          INCLUDE STRUCTURE rsdsfields.
        DATA: END   OF fields.
  DATA: BEGIN OF fields_not OCCURS 10.
          INCLUDE STRUCTURE rsdsfields.
        DATA: END   OF fields_not.

  DATA:ds_expr_tab TYPE rsds_expr_tab.
  DATA:ds_expr_tab_line LIKE rsdsexpr.

  DATA: ds_texpr  TYPE rsds_expr.
  DATA: ld_rep_ldgr TYPE rldnr.
  DATA: ls_tab TYPE  fagl_tabnames.
  DATA: selection_id LIKE  rsdynsel-selid.
  DATA: ls_dfies TYPE dfies.
  DATA: lt_dfies TYPE TABLE OF dfies.
  DATA: lt_incl TYPE TABLE OF dfies.
  DATA: ld_lines LIKE sy-tabix.

** new declaration
*  DATA: ls_tablenames  TYPE fagl_tabnames.
**  DATA: ds_trange  TYPE RSDS_TRANGE.
**  data: ds_trange_tab type RSDS_TRANGE.
*  data: ds_trange_tab_line type RSDS_RANGE.
**  Data: ds_Frange_tab type RSDS_FRANGE_T.
*  data: ds_frange_tab_line type RSDS_FRANGE.
  DATA: ld_tablename TYPE rsds_expr-tablename.
*  data: ds_Texpr_tab_line type RSDS_EXPR.
*  data: ds_expr_tab_tab_line like RSDSEXPR.
*  data: ld_fieldname type RSDSEXPR-fieldname.
*  data: lt_excl_fields like fields occurs 0 with header line.
*  data: ls_texpr_tab_line type RSDS_EXPR.
*  data: ls_expr_tab_line LIKE RSDSEXPR.
*  data: ls_num like sy-tfill.
*  data: ls_field like rsdsfields.
*  data: begin of lt_tab_fld_active occurs 0,
*          tablename LIKE RSDSTABS-PRIM_TAB,
*          fieldname like RSDSEXPR-fieldname,
*        end of lt_tab_fld_active.
*  data: ld_xdel type c.


* new free selection
  tables_tab-prim_tab = 'SKA1_FS'. APPEND tables_tab.
  tables_tab-prim_tab = 'SKB1_FS'. APPEND tables_tab.
*tables_tab-prim_tab = 'BKPF_FS'. APPEND tables_tab.
*tables_tab-prim_tab = 'BSEG_FS'. APPEND tables_tab.
  tables_tab-prim_tab = 'BSIS_FS'. APPEND tables_tab.
  IF  gv_xerfs IS INITIAL.
    CONCATENATE gv_si_table '_FS' INTO ld_tablename.
    tables_tab-prim_tab = ld_tablename. APPEND tables_tab.
  ENDIF.

  fields[] = fs_field[].

  CALL FUNCTION 'FREE_SELECTIONS_INIT'
    EXPORTING
*     kind                     = 'G'
      kind                     = 'T'
*     kind                     = 'F'
*         Alte Abgrenzungen erscheinen wieder
      expressions              = fs_dyns-texpr
*     FIELD_GROUPS_KEY         = ds_groups_key
*     RESTRICTION              =
*     ALV                      =
*     CURR_QUAN_PROG           = SY-CPROG
*     CURR_QUAN_RELATION       =
    IMPORTING
      selection_id             = selection_id
      where_clauses            = fs_dyns-clauses
      expressions              = fs_dyns-texpr
      field_ranges             = fs_dyns-trange
      number_of_active_fields  = fs_num
    TABLES
      tables_tab               = tables_tab
      fields_tab               = fields
*     FIELD_DESC               =
*     FIELD_TEXTS              =
*     EVENTS                   =
*     EVENT_FIELDS             =
      fields_not_selected      = fields_not
    EXCEPTIONS
      fields_incomplete        = 1
      fields_no_join           = 2
      field_not_found          = 3
      no_tables                = 4
      table_not_found          = 5
      expression_not_supported = 6
      incorrect_expression     = 7
      illegal_kind             = 8
      area_not_found           = 9
      inconsistent_area        = 10
      kind_f_no_fields_left    = 11
      kind_f_no_fields         = 12
      too_many_fields          = 13
      dup_field                = 14
      field_no_type            = 15
      field_ill_type           = 16
      dup_event_field          = 17
      node_not_in_ldb          = 18
      area_no_field            = 19
      OTHERS                   = 20.
  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    deco_message_0 e104.
  ENDIF.
* endif.

  CHECK sy-subrc = 0.
  CALL FUNCTION 'FREE_SELECTIONS_DIALOG'
    EXPORTING
      selection_id            = selection_id
      title                   = 'Freie Selektion '(276)
*     FRAME_TEXT              = ' '
*     STATUS                  =
*     AS_WINDOW               = ' '
*     START_ROW               = 2
*     START_COL               = 2
*     NO_INTERVALS            = ' '
*     JUST_DISPLAY            = ' '
*     PFKEY                   =
*     ALV                     = ' '
      tree_visible            = ' '
*     DIAG_TEXT_1             =
*     DIAG_TEXT_2             =
*     WARNING_TITLE           =
    IMPORTING
      where_clauses           = fs_dyns-clauses
      expressions             = fs_dyns-texpr
      field_ranges            = fs_dyns-trange
      number_of_active_fields = fs_num
    TABLES
      fields_tab              = fields
*     FCODE_TAB               =
      fields_not_selected     = fields_not
    EXCEPTIONS
      internal_error          = 1
*     no_action               =
      selid_not_found         = 2
      illegal_status          = 3
      OTHERS                  = 0.

  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    deco_message_0 e104.
  ENDIF.

  PERFORM check_reporting_fields.

  fs_field[] = fields[].

ENDFORM.                    "free_selections
*&---------------------------------------------------------------------*
*&      Form  set_dyn_sel_ldb
*&---------------------------------------------------------------------*
*       Modify dynamic Selections of Log. DB
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_dyn_sel_ldb .
  DATA: ls_dyns TYPE rsds_type.
  DATA: ls_clauses_tab_line TYPE rsds_where.
  DATA: ls_texpr_tab_line TYPE rsds_expr.
  DATA: ls_trange_tab_line TYPE rsds_range.

  ls_dyns = fs_dyns.
  LOOP AT ls_dyns-clauses INTO ls_clauses_tab_line.
    IF ls_clauses_tab_line-tablename = 'SKA1_FS'
    OR ls_clauses_tab_line-tablename = 'SKB1_FS'.
      IF ls_clauses_tab_line-tablename = 'SKA1_FS'.
        ls_clauses_tab_line-tablename = 'SKA1'.
        MODIFY ls_dyns-clauses FROM ls_clauses_tab_line.
      ELSE.
        ls_clauses_tab_line-tablename = 'SKB1'.
        MODIFY ls_dyns-clauses FROM ls_clauses_tab_line.
      ENDIF.
    ELSE.
      DELETE ls_dyns-clauses.
    ENDIF.
  ENDLOOP.

  LOOP AT ls_dyns-texpr INTO ls_texpr_tab_line.
    IF ls_texpr_tab_line-tablename = 'SKA1_FS'
    OR ls_texpr_tab_line-tablename = 'SKB1_FS'.
      IF ls_texpr_tab_line-tablename = 'SKA1_FS'.
        ls_texpr_tab_line-tablename = 'SKA1'.
        MODIFY ls_dyns-texpr FROM ls_texpr_tab_line.
      ELSE.
        ls_texpr_tab_line-tablename = 'SKB1'.
        MODIFY ls_dyns-texpr FROM ls_texpr_tab_line.
      ENDIF.
    ELSE.
      DELETE ls_dyns-texpr.
    ENDIF.
  ENDLOOP.

  LOOP AT ls_dyns-trange INTO ls_trange_tab_line.
    IF ls_trange_tab_line-tablename = 'SKA1_FS'
    OR ls_trange_tab_line-tablename = 'SKB1_FS'.
      IF ls_trange_tab_line-tablename = 'SKA1_FS'.
        ls_trange_tab_line-tablename = 'SKA1'.
        MODIFY ls_dyns-trange FROM ls_trange_tab_line.
      ELSE.
        ls_trange_tab_line-tablename = 'SKB1'.
        MODIFY ls_dyns-trange FROM ls_trange_tab_line.
      ENDIF.
    ELSE.
      DELETE ls_dyns-trange.
    ENDIF.
  ENDLOOP.


  PERFORM modif_dyn_sel(sapdbsdf) USING ls_dyns.
  gs_dyns = ls_dyns.
ENDFORM.                    " set_dyn_sel_ldb
*&---------------------------------------------------------------------*
*&      Form  find_si_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GV_RELEVANT_LEDGER  text
*      <--P_GV_SI_TABLE  text
*----------------------------------------------------------------------*
FORM find_si_table  USING    p_rldnr TYPE rldnr_flex
                    CHANGING p_si_table LIKE fagl_tabnames-si_table.

  DATA: ls_tablenames  TYPE fagl_tabnames.

  CALL FUNCTION 'FAGL_GET_TABLENAMES'
    EXPORTING
      i_ledger    = p_rldnr
    IMPORTING
      es_tabnames = ls_tablenames.

  p_si_table = ls_tablenames-si_table.

ENDFORM.                    " find_si_table
*&---------------------------------------------------------------------*
*&      Form  del_free_selections_si_tab
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM del_free_selections_si_tab
                         CHANGING p_gd_xdels TYPE xfeld.

  DATA: ls_clauses_tab_line TYPE rsds_where.
  DATA: ls_texpr_tab_line TYPE rsds_expr.
  DATA: ls_expr_tab_line LIKE rsdsexpr.
  DATA: ls_trange_tab_line TYPE rsds_range.
  DATA: ls_num LIKE sy-tfill.
  DATA: ls_field LIKE rsdsfields.
  DATA: BEGIN OF lt_tab_fld_active OCCURS 0,
          tablename LIKE rsdstabs-prim_tab,
          fieldname LIKE rsdsexpr-fieldname,
        END OF lt_tab_fld_active.
  DATA: ls_si_table_fs TYPE tabname.
  DATA: ld_xdels TYPE xfeld.

  CONCATENATE gv_save_si_table '_FS' INTO ls_si_table_fs.

  LOOP AT fs_dyns-clauses INTO ls_clauses_tab_line.
    IF ls_clauses_tab_line-tablename = gv_save_si_table.
      DELETE fs_dyns-clauses.
      ld_xdels = 'X'.
    ENDIF.
  ENDLOOP.

  LOOP AT fs_dyns-texpr INTO ls_texpr_tab_line.
    IF ls_texpr_tab_line-tablename = ls_si_table_fs.
      DELETE fs_dyns-texpr.
      ld_xdels = 'X'.
    ENDIF.
  ENDLOOP.

  LOOP AT fs_dyns-trange INTO ls_trange_tab_line.
    IF ls_trange_tab_line-tablename = ls_si_table_fs.
      DELETE fs_dyns-trange.
      ld_xdels = 'X'.
    ENDIF.
  ENDLOOP.

  LOOP AT fs_field INTO ls_field.
    IF ls_field-tablename = ls_si_table_fs.
      DELETE fs_field.
      ld_xdels = 'X'.
    ENDIF.
  ENDLOOP.

  LOOP AT fs_dyns-texpr INTO ls_texpr_tab_line.
    lt_tab_fld_active-tablename = ls_texpr_tab_line-tablename.
    LOOP AT ls_texpr_tab_line-expr_tab INTO ls_expr_tab_line.
      IF NOT ls_expr_tab_line-fieldname IS INITIAL.
        lt_tab_fld_active-fieldname = ls_expr_tab_line-fieldname.
        COLLECT lt_tab_fld_active.
      ENDIF.
    ENDLOOP.
  ENDLOOP.
  DESCRIBE TABLE lt_tab_fld_active LINES ls_num.
  IF ls_num NE fs_num.
    fs_num = ls_num.
  ENDIF.

  p_gd_xdels = ld_xdels.

ENDFORM.                    " change_free_selections

*&---------------------------------------------------------------------*
*&      Form  GET_GENERAL_PARAM_NEW
*&---------------------------------------------------------------------*
*form get_general_param_new.
*  data: charh(16)   type c,
*        ld_num(16)  type n.
*  data: ls_rfopt  type rfopt.
*  data: ld_parid type usr05-parid.
*
**... get checkbox stuff depending on acc.type:
*  case sy-repid.
*    when c_repid_ar.
*      get parameter id 'FIT_X_AR' field charh.
*      get parameter id 'FIT_ALV_AR' field pa_vari.
*      ld_parid = 'FIT_ALV_AR'.
*    when c_repid_ap.
*      get parameter id 'FIT_X_AP' field charh.
*      get parameter id 'FIT_ALV_AP' field pa_vari.
*      ld_parid = 'FIT_ALV_AP'.
*    when c_repid_gl.
*      get parameter id 'FIT_X_GL' field charh.
*      get parameter id 'FIT_ALV_GL' field pa_vari.
*      ld_parid = 'FIT_ALV_GL'.
*    when c_repid_FAGl_GL.                        "Param IDs in Arbeit
*      get parameter id 'FIT_X_GL' field charh.
*      get parameter id 'FIT_ALV_GL' field pa_vari.
*      ld_parid = 'FIT_ALV_GL'.
*    when others.
**     horror case!
*      exit.
*  endcase.
*  if not charh is initial.
*    x_norm = charh(1).
*    x_shbv = charh+1(1).
*    x_merk = charh+2(1).
*    x_park = charh+3(1).
*    x_apar = charh+4(1).
*  endif.
*
**...changing of pa_vari (default value FIT_ALV_**)
*  get parameter id 'FOP' field ls_rfopt.
*  if not ls_rfopt-xarbv is initial.
*    select single parva from usr05 into (pa_vari)
*                        where bname = sy-uname
*                        and parid = ld_parid.
*    if sy-subrc <> 0.
*      clear pa_vari.
*    endif.
*  endif.
*
**... get item number limit:
*  get parameter id 'FIT_X_NMAX' field ld_num.
*  if ld_num co ' 0123456789'.
*    pa_nmax = ld_num.
*  endif.
*
*endform.                               " GET_GENERAL_PARAM
*
**&---------------------------------------------------------------------
**
**&      Form  SET_GENERAL_PARAM_NEW
**&---------------------------------------------------------------------
**
*form set_general_param_new.
*
*  data: ls_rfopt  type rfopt.
*  data: charh(16) type c,
*        ld_num(16)  type n,
*        ls_usr05  like usr05.
*  data: ld_refresh_count   type i,
*        ld_memory_id(40)   type c.
*
*  check sy-calld is initial.
*  check sy-tcode cp 'FBL+N' or
*      ( sy-tcode cp 'S+38' and sy-repid cp 'RFITEM++' ) or
*      ( sy-tcode eq 'SE80' and sy-repid cp 'RFITEM++' ).
*
*  charh(1)   = x_norm.
*  charh+1(1) = x_shbv.
*  charh+2(1) = x_merk.
*  charh+3(1) = x_park.
*  charh+4(1) = x_apar.
** if in refresh call, then do not update layout parameter:
*  ld_memory_id = sy-repid.
*  write '/REFR' to ld_memory_id+35(5).
*  condense ld_memory_id no-gaps.
*  import counter to ld_refresh_count
*         from memory id ld_memory_id.
*  case sy-repid.
*    when c_repid_ar.
*      set parameter id 'FIT_X_AR'   field charh.
*      if ld_refresh_count = 0.
*        get parameter id 'FOP' field ls_rfopt.
*        if ls_rfopt-xarbv is initial.
*          set parameter id 'FIT_ALV_AR' field pa_vari.
*          write 'FIT_ALV_AR' to ls_usr05-parid.
*        else.
*          set parameter id 'FIT_ALV_AR' field space.
*        endif.
*      endif.
*    when c_repid_ap.
*      set parameter id 'FIT_X_AP'   field charh.
*      if ld_refresh_count = 0.
*        get parameter id 'FOP' field ls_rfopt.
*        if ls_rfopt-xarbv is initial.
*          set parameter id 'FIT_ALV_AP' field pa_vari.
*          write 'FIT_ALV_AP' to ls_usr05-parid.
*        else.
*          set parameter id 'FIT_ALV_AP' field space.
*        endif.
*      endif.
*    when c_repid_gl.
*      set parameter id 'FIT_X_GL'   field charh.
*      if ld_refresh_count = 0.
*        get parameter id 'FOP' field ls_rfopt.
*        if ls_rfopt-xarbv is initial.
*          set parameter id 'FIT_ALV_GL' field pa_vari.
*          write 'FIT_ALV_GL' to ls_usr05-parid.
*        else.
*          set parameter id 'FIT_ALV_GL' field space.
*        endif.
*      endif.
*    when c_repid_FAGl_GL.
*      set parameter id 'FIT_X_GL'   field charh.
*      if ld_refresh_count = 0.
*        get parameter id 'FOP' field ls_rfopt.
*        if ls_rfopt-xarbv is initial.
*          set parameter id 'FIT_ALV_GL' field pa_vari.
*          write 'FIT_ALV_GL' to ls_usr05-parid.
*        else.
*          set parameter id 'FIT_ALV_GL' field space.
*        endif.
*      endif.
*    when others.
**     horror case!
*      exit.
*  endcase.
*  if ld_refresh_count = 0.
*    get parameter id 'FOP' field ls_rfopt.
*    if ls_rfopt-xarbv is initial.
*      ls_usr05-bname = sy-uname.
*      write pa_vari to ls_usr05-parva.
*      if ls_usr05-parva is initial.
*        delete from usr05 where bname = ls_usr05-bname
*                          and   parid = ls_usr05-parid.
*      else.
*        modify usr05 from ls_usr05.
*      endif.
*      commit work.
*    endif.
*  endif.
*  ld_num = pa_nmax.
*  set parameter id 'FIT_X_NMAX' field ld_num.
*
*endform.                               " SET_GENERAL_PARAM

*&---------------------------------------------------------------------*
*&      Form  MAKE_FIELDCATALOG_NEW
*&---------------------------------------------------------------------*
*form make_fieldcatalog_new.
*  data: lt_dfies_rfposx   like dfies occurs  50 with header line,
*        lt_dfies_bsix     like dfies occurs 100 with header line,
*        lt_duplicates     type tpit_t_fname with header line,
*        ld_fname          like dfies-fieldname,
*        ld_name_bsix      like dcobjdef-name,
*        lt_fmrfc          like fmrfc occurs 1.
*
**...define icon fields:
*
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'SYM_AUGP'.
*  gt_fieldcat-symbol    = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'ICO_AUGP'.
*  gt_fieldcat-icon      = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'ICO_DUE'.
*  gt_fieldcat-icon      = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'ICO_DUE1'.
*  gt_fieldcat-icon      = 'X'.
*  append gt_fieldcat.
*
**...define technical and obsolete fields (static):
*
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'ACTIV'.
*  gt_fieldcat-tech      = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'STAKZ'.
*  gt_fieldcat-tech      = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'XAUGP'.
*  gt_fieldcat-tech      = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'COLOR'.
*  gt_fieldcat-tech      = 'X'.
*  append gt_fieldcat.
*  clear gt_fieldcat.
*  gt_fieldcat-fieldname = 'XZAHL'.
*  gt_fieldcat-tech      = 'X'.
*  append gt_fieldcat.
** hide GKONT and GKART, if OPEN FI exit 1650 not used:
*  call function 'BF_FUNCTIONS_FIND'
*    EXPORTING
*      i_event       = '00001650'
*    TABLES
*      t_fmrfc       = lt_fmrfc
*    EXCEPTIONS
*      nothing_found = 1
*      others        = 2.
*  if sy-subrc ne 0.
*    clear gt_fieldcat.
*    gt_fieldcat-fieldname = 'GKONT'.
*    gt_fieldcat-tech      = 'X'.
*    append gt_fieldcat.
*    clear gt_fieldcat.
*    gt_fieldcat-fieldname = 'GKART'.
*    gt_fieldcat-tech      = 'X'.
*    append gt_fieldcat.
*  endif.
*
**...define obsolete fields (dynamic):
*
** check for existence of special fields:
*  read table it_t021s index 1.
*  check sy-subrc = 0.
*
** get RFPOSX field list:
*  call function 'DDIF_NAMETAB_GET'
*       exporting
*            tabname     = 'RFPOSX'
*       tables
**           X031L_TAB   =
*            dfies_tab   = lt_dfies_rfposx
*       exceptions
*            not_found   = 1
*            others      = 2
*            .
*  check sy-subrc = 0.
*
** collect duplicates = special fields which are contained in RFPOSX:
*  loop at it_t021s.
*    check not it_t021s-tname is initial.
*    read table lt_dfies_rfposx with key
*                               fieldname = it_t021s-fname.
*    check sy-subrc = 0.
*    lt_duplicates-fname = it_t021s-fname.
*    append lt_duplicates.
*  endloop.
*
** found duplicates?
*  read table lt_duplicates index 1.
*  check sy-subrc = 0.
*
** get BSIx field list:
*  case g_repid.
*    when c_repid_ar.
*      ld_name_bsix = 'BSID'.
*    when c_repid_ap.
*      ld_name_bsix = 'BSIK'.
*    when c_repid_gl.
*      ld_name_bsix = 'BSIS'.
*  endcase.
*  call function 'DDIF_NAMETAB_GET'
*       exporting
*            tabname     = ld_name_bsix
*       tables
**           X031L_TAB   =
*            dfies_tab   = lt_dfies_bsix
*       exceptions
*            not_found   = 1
*            others      = 2
*            .
*  check sy-subrc = 0.
*
** check whether duplicates are contained in BSIx:
*  loop at lt_duplicates.
*    clear ld_fname.
*    read table lt_dfies_bsix with key
*                             fieldname = lt_duplicates-fname.
*    if sy-subrc = 0.
**     standard field ok. set special field to 'tech':
*      ld_fname = 'U_'.
*      write lt_duplicates-fname to ld_fname+2.
*    else.
**     special field ok. set standard field to 'tech':
*      ld_fname = lt_duplicates-fname.
*    endif.
*    clear gt_fieldcat.
*    gt_fieldcat-fieldname = ld_fname.
*    gt_fieldcat-tech      = 'X'.
*    append gt_fieldcat.
*  endloop.
*
*endform.                               " MAKE_FIELDCATALOG

**&---------------------------------------------------------------------
**
**&      Form  SPECIAL_FIELDS_new
**&---------------------------------------------------------------------
**
*form special_fields_init_new using   rs_variant like disvariant.
*  data: it_var_fieldcat  type slis_t_fieldcat_alv with header line,
*        it_max_fieldcat  type slis_t_fieldcat_alv,
*        dummy_layout     type slis_layout_alv.
*
** ... get existing variant:
*  perform get_existing_variant using rs_variant.
**... get fieldcat of initial variant:
*  perform get_initial_fieldcat_new   tables it_var_fieldcat
*                                 using  rs_variant.
**... analyze initial fieldcat:
*  perform analyze_act_fieldcat  tables it_var_fieldcat.
**... read required special tables and fill item fields:
*  perform read_special_tables_new.
*
*endform.                               " SPECIAL_FIELDS_INIT

*&---------------------------------------------------------------------*
*&      Form GET_INITIAL_FIELDCAT
*&---------------------------------------------------------------------*
*form get_initial_fieldcat_new  tables rt_var_fieldcat
*                                      type slis_t_fieldcat_alv
*                           using  rs_variant like disvariant.
*  data: it_max_fieldcat  type slis_t_fieldcat_alv,
*        dummy_layout     type slis_layout_alv,
*        ls_variant       type disvariant,
*        ld_exit          type c.
*
*  ls_variant = rs_variant.
*
**... build maximal fieldcat:
*  call function 'REUSE_ALV_FIELDCATALOG_MERGE'
*    EXPORTING
*      i_buffer_active        = 'X'
*      i_program_name         = g_repid
*      i_structure_name       = 'FAGLPOSX'
*    CHANGING
*      ct_fieldcat            = it_max_fieldcat
*    EXCEPTIONS
*      inconsistent_interface = 1
*      program_error          = 2
*      others                 = 3.
*  if sy-subrc <> 0.
*    message a011.
*  endif.
**... get variant fieldcat:
*  call function 'REUSE_ALV_VARIANT_SELECT'
*    EXPORTING
*      i_dialog            = ' '
*      i_user_specific     = 'X'
*      it_default_fieldcat = it_max_fieldcat
*      i_layout            = dummy_layout
*      i_buffer_active     = 'X'
*    IMPORTING
*      e_exit              = ld_exit
*      et_fieldcat         = rt_var_fieldcat[]
*    CHANGING
*      cs_variant          = ls_variant
*    EXCEPTIONS
*      wrong_input         = 1
*      fc_not_complete     = 2
*      not_found           = 3
*      program_error       = 4
*      others              = 5.
*  if sy-subrc <> 0.
**... take maximal fieldcat for special fields:
*    rt_var_fieldcat[] = it_max_fieldcat[].
*  endif.
*
*endform.                               " GET_INITIAL_FIELDCAT

*&---------------------------------------------------------------------*
*&      Form  READ_SPECIAL_TABLES
*&---------------------------------------------------------------------*
*form read_special_tables_new.
*  data: posindex   like sy-tabix.
*
**... check item table filled?
*  read table it_pos index 1.
*  check sy-subrc = 0.
**... loop over all pending tables:
*  loop at it_spectab where tstat = 'P'.
** building additional help tables for BKPF and BSEG for optimized
** database selections.
*    perform create_performance_tables_new using it_spectab-tname.
*    case it_spectab-tname.
*      when 'BKPF'.
*        PERFORM SPECIAL_FIELDS_USED USING it_spectab-tname.
*        if sy-subrc = 0.
*          perform complete_bkpf.
*        endif.
*      when 'BSEG'.
*        perform complete_bseg.
*      when 'BSEGC'.
*        PERFORM SPECIAL_FIELDS_USED USING it_spectab-tname.
*        if sy-subrc = 0.
*          perform complete_bsegc.
*        endif.
*      when 'BSEC'.
*        perform complete_bsec.
*      when 'BSED'.
*        perform complete_bsed.
*      when 'BSBV'.
*        perform complete_bsbv.
*      when 'PAYR'.
*        perform complete_payr.
*      when '_TEXT'.
*        perform complete_document_text.
*    endcase.
*  endloop.
**... final bookkeeping: status of special tables & fields
*  perform upd_special_status.
*
*endform.                               " READ_SPECIAL_TABLES

*---------------------------------------------------------------------*
*       FORM create_performance_tables                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  id_tablename                                                  *
*---------------------------------------------------------------------*
*form create_performance_tables
*                            using id_tablename type dd03p-tabname .
*
*  field-symbols : <lfs_pos>              type FAGLPOSX.
*  statics :       lst_performance_tables type c.
*
*  if lst_performance_tables is initial.
*    if id_tablename eq 'BKPF' or id_tablename eq 'BSEG' .
*
** Creating additional tables for speeding up the database selects
*      refresh: gt_pos_parked, gt_pos_posted, gt_pos_archived.
*
*      loop at it_pos assigning <lfs_pos>.
*        gd_pos_reduced-bukrs = <lfs_pos>-bukrs.
*        gd_pos_reduced-belnr = <lfs_pos>-belnr.
*        gd_pos_reduced-gjahr = <lfs_pos>-gjahr.
*        gd_pos_reduced-buzei = <lfs_pos>-buzei.
*        gd_pos_reduced-budat = <lfs_pos>-budat.
*
*        if <lfs_pos>-bstat ca 'VWZ'.
*          insert gd_pos_reduced into table gt_pos_parked.
*        elseif <lfs_pos>-xarch eq 'X' and gd_usear = 'X'.
*          insert gd_pos_reduced into table gt_pos_archived.
*        else.
*          insert gd_pos_reduced into table gt_pos_posted.
*        endif.
*      endloop.
*
*      lst_performance_tables = 'X'.
*    endif.
*  endif.
*
*endform.

*&---------------------------------------------------------------------*
*&      Form  CHECK_ITEM_OK
*&---------------------------------------------------------------------*
*form check_item_ok_new using    p_norm
*                            p_shbv
*                            p_merk
*                            p_park
*                            p_item    like faglposx
*                   changing p_okay.
*
*  clear p_okay.
** normal document:
*  if p_norm = 'X'.
*    if ( p_item-bstat = space ) and ( p_item-umskz = space ).
*      p_okay = 'X'.
*    endif.
*  endif.
** SHB item:
*  if p_shbv = 'X'.
*    if ( p_item-umskz ne space ) and ( p_item-bstat ne 'S' ) and
*       ( p_item-bstat ne 'V' )   and ( p_item-bstat ne 'W' ) and
*       ( p_item-bstat ne 'Z' ).
*      p_okay = 'X'.
*    endif.
*  endif.
** Merkposten:
*  if p_merk = 'X'.
*    if p_item-bstat = 'S'.
*      p_okay = 'X'.
*    endif.
*  endif.
** parked document:
*  if p_park = 'X'.
*    if ( p_item-bstat = 'V' ) or ( p_item-bstat = 'W' ).
*      p_okay = 'X'.
*    endif.
*  endif.
*
*endform.                               " CHECK_ITEM_OK

*&---------------------------------------------------------------------*
*&      Form  CB_ITEM_ALV_USERCOMM
*&---------------------------------------------------------------------*
*form cb_item_alv_usercomm_new  using  r_ucomm     like sy-ucomm
*                                  rs_selfield type slis_selfield.
*  data: rt_fieldcat type slis_t_fieldcat_alv.
*  data: ld_refresh_count    type i,
*        ld_memory_id(40)    type c.
*  data: ls_variant          type disvariant,
*        lt_selscreen        like rsparams occurs 5 with header line,
*        ld_memory_id2(40)   type c.
*
*  case r_ucomm.
*    when '&OL0' or '&OAD' or '&OLX'.
**.... ALV change display variant. get new field catalog:
*      if x_grid is initial.
*        call function 'REUSE_ALV_LIST_LAYOUT_INFO_GET'
*          IMPORTING
*            et_fieldcat   = rt_fieldcat
*          EXCEPTIONS
*            no_infos      = 1
*            program_error = 2
*            others        = 3.
*      else.
*        call function 'REUSE_ALV_GRID_LAYOUT_INFO_GET'
*          IMPORTING
*            et_fieldcat   = rt_fieldcat
*          EXCEPTIONS
*            no_infos      = 1
*            program_error = 2
*            others        = 3.
*      endif.
*      if sy-subrc <> 0.
*        exit.
*      endif.
**     analyze new fieldcat:
*      perform analyze_act_fieldcat  tables rt_fieldcat.
**     treat new special fields:
*      perform read_special_tables.
*    when 'REFR' or 'LTOG'.
**.... list refresh:
*      if x_grid is initial.
*        call function 'REUSE_ALV_LIST_LAYOUT_INFO_GET'
*          IMPORTING
*            es_variant    = ls_variant
*          EXCEPTIONS
*            no_infos      = 1
*            program_error = 2
*            others        = 3.
*      else.
*        call function 'REUSE_ALV_GRID_LAYOUT_INFO_GET'
*          IMPORTING
*            es_variant    = ls_variant
*          EXCEPTIONS
*            no_infos      = 1
*            program_error = 2
*            others        = 3.
*      endif.
*      if sy-subrc = 0 and not ls_variant-variant is initial.
*        ld_memory_id2 = g_repid.
*        write '/LAYO' to ld_memory_id2+35(5).
*        condense ld_memory_id2 no-gaps.
*        export layout from ls_variant-variant
*               to memory id ld_memory_id2.
*      endif.
*      ld_memory_id = g_repid.
*      write '/REFR' to ld_memory_id+35(5).
*      condense ld_memory_id no-gaps.
*      import counter to ld_refresh_count
*             from memory id ld_memory_id.
*      add 1 to ld_refresh_count.
*      export counter from ld_refresh_count
*             to memory id ld_memory_id.
*      if ld_refresh_count > 1.
*        leave program.
*      endif.
*      while ld_refresh_count > 0.
*        clear ls_variant.
*        lt_selscreen[] = gt_selscreen[].
*        import layout to ls_variant-variant
*               from memory id ld_memory_id2.
*        if sy-subrc = 0 and not ls_variant-variant is initial.
*          read table lt_selscreen with key selname = 'PA_VARI'.
*          if sy-subrc = 0.
*            lt_selscreen-low = ls_variant-variant.
*            modify lt_selscreen index sy-tabix.
*          endif.
*        endif.
*        submit (g_repid) with selection-table lt_selscreen
*                         with free selections gt_dyn_texpr
*                         with kd_index eq gt_searchpattern
*                         with dd_index eq gt_searchpattern
*                         with sd_index eq gt_searchpattern
*                         and return.
*        clear ld_refresh_count.
*        import counter to ld_refresh_count
*               from memory id ld_memory_id.
*        if ld_refresh_count > 0.
*          subtract 1 from ld_refresh_count.
*        endif.
*        export counter from ld_refresh_count
*               to memory id ld_memory_id.
*      endwhile.
*      if gd_dynp_val = 0.
*        submit (g_repid) with selection-table gt_selscreen
*                         with free selections gt_dyn_texpr
*                         with kd_index eq gt_searchpattern
*                         with dd_index eq gt_searchpattern
*                         with sd_index eq gt_searchpattern
*                         via selection-screen.
*      else.
*        leave program.
*      endif.
*
*  endcase.
*
*endform.                               " CB_ITEM_ALV_USERCOMM

*&---------------------------------------------------------------------*
*&      Form  CHANGE_STATUS_NEW
*&---------------------------------------------------------------------*
*form change_status_NEW.
*
*  data: begin of lt_exclude occurs 5,
*          fcode like sy-ucomm,
*        end of lt_exclude.
*  data: ld_flag(1) type c.
*  data: ls_rssubinfo like rssubinfo.
*
*
*  call function 'RS_SUBMIT_INFO'
*       importing
*            p_submit_info = ls_rssubinfo
*       exceptions
*            others        = 1.
*
*  if not ls_rssubinfo-mode_norml is initial.
** check: worklist functionality active?
**  get parameter id 'FI_WORKLISTS_FLAG' field ld_flag.
**  if ld_flag is initial.
**    lt_exclude-fcode = 'FC01'.
**    append lt_exclude.
***   clear user preference parameter:
**    set parameter id 'FIT_WL' field space.
**  endif.
**  lt_exclude-fcode = 'FC01'.
**  append lt_exclude.
*  get parameter id 'FI_WORKLISTS_FLAG' field ld_flag.
*  if ld_flag is initial.
*    lt_exclude-fcode = 'FC02'.
*    append lt_exclude.
**   clear user preference parameter:
*    set parameter id 'FIT_WL' field space.
*  endif.
**  lt_exclude-fcode = 'FC03'.
**  append lt_exclude.
*   lt_exclude-fcode = 'FC04'.
*   append lt_exclude.
**  lt_exclude-fcode = 'FC05'.
**  append lt_exclude.
*
** deactivate the dyn. Selections of Log. DB
*  lt_exclude-fcode = 'DYNS'.
*  append lt_exclude.
*
*  call function 'RS_SET_SELSCREEN_STATUS'
*    EXPORTING
*      p_status  = sy-pfkey
*    TABLES
*      p_exclude = lt_exclude.
*
*  endif.
*
*endform.                               " CHANGE_STATUS_NEW

*----------------------------------------------------------------------*
*   form wl_flag_and_button_new
*   set global flag and button text according to static memory
*----------------------------------------------------------------------*
*form wl_flag_and_button_new.
*
** icon freie selection
*  perform fs_set_sscrtexts_dynsel changing fs_f1_icon.
*  sscrfields-functxt_01 = fs_f1_icon.
*
** text worklist button
*  perform wl_memory_set_get using space
*                                  gd_wl_on.
*  if gd_wl_on is initial.
*    sscrfields-functxt_02 = text-w01.
*  else.
*    sscrfields-functxt_02 = text-w04.
*  endif.
*
*  sscrfields-functxt_03 = text-272.
*
*endform.                    "wl_flag_and_button_new
*&---------------------------------------------------------------------*
*&      Form  setlmnt_accounts
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM setlmnt_accounts .

  DATA: ls_account_slt TYPE gty_acccoco.
  DATA: ls_acc_debit   TYPE acct_det_c_c_bf.
  DATA: ls_acc_credit  TYPE acct_det_c_c_bf.
*  data: ld_bukrs       type bukrs.

  REFRESH gt_account_slt.

  DATA: lt_bukrs TYPE bukrs OCCURS 0 WITH HEADER LINE.

  SELECT bukrs FROM t001 INTO TABLE lt_bukrs
  WHERE bukrs IN sd_bukrs.
  LOOP AT lt_bukrs.
    CALL FUNCTION 'FI_ACCT_DET_CLEARING'
      EXPORTING
        id_company_code = lt_bukrs
      IMPORTING
        es_acc_debit    = ls_acc_debit
        es_acc_credit   = ls_acc_credit.
*   TABLES
*     RETURN                =

    IF NOT ls_acc_debit-hkont IS INITIAL.
      IF ls_acc_debit-hkont IN sd_saknr.
        ls_account_slt-bukrs = lt_bukrs.
        ls_account_slt-saknr = ls_acc_debit-hkont.
        APPEND ls_account_slt TO gt_account_slt.
      ENDIF.
    ENDIF.
    IF NOT ls_acc_credit-hkont IS INITIAL.
      IF ls_acc_credit-hkont IN sd_saknr.
        ls_account_slt-bukrs = lt_bukrs.
        ls_account_slt-saknr = ls_acc_credit-hkont.
        APPEND ls_account_slt TO gt_account_slt.
      ENDIF.
    ENDIF.
  ENDLOOP.
*  endselect.
  SORT gt_account_slt.

ENDFORM.                    " setlmnt_accounts
*&---------------------------------------------------------------------*
*&      Form  get_leading_ledger
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GV_LEADING_LEDGER  text
*----------------------------------------------------------------------*
FORM get_leading_ledger  CHANGING cc_leading_ledger TYPE fagl_rldnr.

  CALL FUNCTION 'FAGL_GET_LEADING_LEDGER'
    IMPORTING
      e_rldnr   = cc_leading_ledger
    EXCEPTIONS
      not_found = 1.

  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.                    " get_leading_ledger
*&---------------------------------------------------------------------*
*&      Form  check_reporting_fields
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_reporting_fields .

*Felder obiger Tabellen
  DATA: BEGIN OF fields OCCURS 10.
          INCLUDE STRUCTURE rsdsfields.
        DATA: END   OF fields.
*  DATA: BEGIN OF fields_not OCCURS 10.
*          INCLUDE STRUCTURE rsdsfields.
*  DATA: END   OF fields_not.

* new declaration
  DATA: ls_tablenames  TYPE fagl_tabnames.
*  DATA: ds_trange  TYPE RSDS_TRANGE.
*  data: ds_trange_tab type RSDS_TRANGE.
  DATA: ds_trange_tab_line TYPE rsds_range.
*  Data: ds_Frange_tab type RSDS_FRANGE_T.
  DATA: ds_frange_tab_line TYPE rsds_frange.
  DATA: ld_tablename TYPE rsds_expr-tablename.
  DATA: ds_texpr_tab_line TYPE rsds_expr.
  DATA: ds_expr_tab_tab_line LIKE rsdsexpr.
  DATA: ld_fieldname TYPE rsdsexpr-fieldname.
  DATA: lt_excl_fields LIKE fields OCCURS 0 WITH HEADER LINE.
  DATA: ls_texpr_tab_line TYPE rsds_expr.
  DATA: ls_expr_tab_line LIKE rsdsexpr.
  DATA: ls_num LIKE sy-tfill.
  DATA: ls_field LIKE rsdsfields.
  DATA: BEGIN OF lt_tab_fld_active OCCURS 0,
          tablename LIKE rsdstabs-prim_tab,
          fieldname LIKE rsdsexpr-fieldname,
        END OF lt_tab_fld_active.
  DATA: ld_xdel TYPE c.

* check selected fields against reporting fields of ledger
  CONCATENATE gv_si_table '_FS' INTO ld_tablename.

  CALL FUNCTION 'FAGL_GET_REPORTING_FIELDS'
    EXPORTING
      i_rldnr   = gv_relevant_ledger
    IMPORTING
      et_fields = gt_reporting_fields
      et_dfies  = gt_dfies_reporting_fields.

  gs_reporting_fields = 'DOCNR'.
  APPEND gs_reporting_fields TO gt_reporting_fields.
  gs_reporting_fields = 'DOCLN'.
  APPEND gs_reporting_fields TO gt_reporting_fields.
  gs_reporting_fields = 'POPER'.
  APPEND gs_reporting_fields TO gt_reporting_fields.
  gs_reporting_fields = 'KOKRS'.
  APPEND gs_reporting_fields TO gt_reporting_fields.
  gs_reporting_fields = 'RMVCT'.
  APPEND gs_reporting_fields TO gt_reporting_fields.

  LOOP AT fs_dyns-texpr INTO ds_texpr_tab_line
    WHERE tablename = ld_tablename.
    LOOP AT ds_texpr_tab_line-expr_tab INTO ds_expr_tab_tab_line.
      ld_fieldname = ds_expr_tab_tab_line-fieldname.
      IF NOT ld_fieldname IS INITIAL.
        READ TABLE gt_reporting_fields INTO gs_reporting_fields
        WITH KEY ld_fieldname.
        IF sy-subrc NE 0.
          lt_excl_fields-tablename = ld_tablename.
          lt_excl_fields-fieldname = ld_fieldname.
          COLLECT lt_excl_fields.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDLOOP.
  LOOP AT fs_dyns-trange INTO ds_trange_tab_line
    WHERE tablename = ld_tablename.
    LOOP AT ds_trange_tab_line-frange_t INTO ds_frange_tab_line.
      ld_fieldname = ds_frange_tab_line-fieldname.
      LOOP AT lt_excl_fields
        WHERE fieldname = ld_fieldname.
        EXIT.
      ENDLOOP.
      IF sy-subrc = 0.
        DELETE ds_trange_tab_line-frange_t.
        ld_xdel = 'X'.
      ENDIF.
    ENDLOOP.
    IF NOT ld_xdel IS INITIAL.
      MODIFY fs_dyns-trange FROM ds_trange_tab_line.
      deco_message_0 i103.
    ENDIF.
  ENDLOOP.

  IF NOT ld_xdel IS INITIAL.
    CALL FUNCTION 'FREE_SELECTIONS_RANGE_2_EX'
      EXPORTING
        field_ranges = fs_dyns-trange
      IMPORTING
        expressions  = fs_dyns-texpr.

    CALL FUNCTION 'FREE_SELECTIONS_RANGE_2_WHERE'
      EXPORTING
        field_ranges  = fs_dyns-trange
      IMPORTING
        where_clauses = fs_dyns-clauses.

    LOOP AT fs_dyns-texpr INTO ls_texpr_tab_line.
      lt_tab_fld_active-tablename = ls_texpr_tab_line-tablename.
      LOOP AT ls_texpr_tab_line-expr_tab INTO ls_expr_tab_line.
        IF NOT ls_expr_tab_line-fieldname IS INITIAL.
          lt_tab_fld_active-fieldname = ls_expr_tab_line-fieldname.
          COLLECT lt_tab_fld_active.
        ENDIF.
      ENDLOOP.
    ENDLOOP.
    DESCRIBE TABLE lt_tab_fld_active LINES ls_num.
    IF ls_num NE fs_num.
      fs_num = ls_num.
    ENDIF.
  ENDIF.

*            fs_field[] = fields[].

ENDFORM.                    " check_reporting_fields
*&---------------------------------------------------------------------*
*&      Form  map_sel_to_items_mast_dat
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM map_sel_to_items_mast_dat USING
                             p_gb_xplacc         TYPE  boolean
                             p_gt_selection_part TYPE  gusl_t_selection
                               CHANGING
                             p_gt_selection_full TYPE  gusl_t_selection.

  DATA: lt_selection   TYPE  gusl_t_selection.
  DATA: ls_selection   TYPE  gusl_s_selection.
  FIELD-SYMBOLS: <wa1> TYPE any.
  DATA: ls_selopt      TYPE rsdsselopt.
  DATA: ls_selopt_t    TYPE rsds_selopt_t.
  DATA: ls_si_table_fs TYPE tabname.
  DATA: ls_bsis_fs     TYPE tabname VALUE 'BSIS_FS'.
  DATA: ls_trange_tab_line TYPE rsds_range.
  DATA: ls_frange_tab_line TYPE rsds_frange.
  DATA: ld_stida       TYPE budat.
  DATA: ld_stida_2     TYPE budat.
  DATA: lt_augdt   TYPE range_date OCCURS 0 WITH HEADER LINE.
  DATA: lt_budat   TYPE range_date OCCURS 0 WITH HEADER LINE.
  RANGES: lt_saknr     FOR skb1-saknr.
  RANGES: lt_bukrs     FOR skb1-bukrs.
  RANGES: lt_rldnr     FOR faglflexa-rldnr.

  REFRESH p_gt_selection_full.

* masterdata
  lt_saknr-sign = 'I'.
  lt_saknr-option = 'EQ'.
  lt_saknr-low    = skb1-saknr.
  APPEND lt_saknr.
  lt_bukrs-sign = 'I'.
  lt_bukrs-option = 'EQ'.
  lt_bukrs-low    = skb1-bukrs.
  APPEND lt_bukrs.

  REFRESH ls_selopt_t.
  LOOP AT lt_bukrs ASSIGNING <wa1>.
    MOVE-CORRESPONDING <wa1> TO ls_selopt.
    APPEND ls_selopt TO ls_selopt_t.
  ENDLOOP.
  ls_selection-fieldname = 'BUKRS'.
  ls_selection-t_range  = ls_selopt_t.
  APPEND ls_selection TO lt_selection.
  REFRESH ls_selopt_t.
  LOOP AT lt_bukrs ASSIGNING <wa1>.
    MOVE-CORRESPONDING <wa1> TO ls_selopt.
    APPEND ls_selopt TO ls_selopt_t.
  ENDLOOP.
  ls_selection-fieldname = 'RBUKRS'.
  ls_selection-t_range  = ls_selopt_t.
  APPEND ls_selection TO lt_selection.

  REFRESH ls_selopt_t.
  LOOP AT lt_saknr ASSIGNING <wa1>.
    MOVE-CORRESPONDING <wa1> TO ls_selopt.
    APPEND ls_selopt TO ls_selopt_t.
  ENDLOOP.
  ls_selection-fieldname = 'HKONT'.
  ls_selection-t_range  = ls_selopt_t.
  APPEND ls_selection TO lt_selection.
  REFRESH ls_selopt_t.
  LOOP AT lt_saknr ASSIGNING <wa1>.
    MOVE-CORRESPONDING <wa1> TO ls_selopt.
    APPEND ls_selopt TO ls_selopt_t.
  ENDLOOP.
  ls_selection-fieldname = 'RACCT'.
  ls_selection-t_range  = ls_selopt_t.
  APPEND ls_selection TO lt_selection.

  LOOP AT p_gt_selection_part INTO ls_selection.
    APPEND ls_selection TO lt_selection.
  ENDLOOP.

  p_gt_selection_full[] = lt_selection[].

ENDFORM.                    " map_sel_to_items_mast_dat
*&---------------------------------------------------------------------*
*&      Form  select_items
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM select_items .
  DATA: ld_read_bseg.
  DATA: ld_lines LIKE sy-tabix.
  DATA: lt_files TYPE  as_t_rng_archiv.
  STATICS lv_reset_init TYPE gusl_bool. "correction archive and non archive
*  DATA lv_reset_init TYPE gusl_bool. "correction archive and non archive

  CHECK x_stop IS INITIAL.

  IF NOT x_opsel IS INITIAL
  OR NOT x_aisel IS INITIAL.
    IF ( NOT skb1-xopvw IS INITIAL
    OR ( NOT skb1-xkres IS INITIAL
         AND NOT x_erfs IS INITIAL )
    OR ( NOT skb1-xkres IS INITIAL
         AND x_erfs IS INITIAL
         AND ( skb1-mitkz EQ 'D' OR skb1-mitkz EQ 'K' ) ) ).
      IF gv_special_account IS INITIAL.                     "1004374
        IF NOT x_merk IS INITIAL
        OR NOT x_norm IS INITIAL.
          IF NOT gd_usedb IS INITIAL.
* recon. account + line item display -> read additional data
            IF ( skb1-mitkz EQ 'D' OR skb1-mitkz EQ 'K' )
            AND skb1-xkres NE space AND x_erfs IS INITIAL.  "1699013
              ld_read_bseg = 'X'.
            ENDIF.

            gd_cursor_open = 'X'.                           "987950
            WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL. "987950
*             check x_stop is initial.                         "987950
              REFRESH it_sel.
              IF gd_cursor_open = 'X'.
                CALL FUNCTION 'FAGL_GET_ITEMS_BSIS'
                  EXPORTING
                    iv_acdoc_compatibility_mode = abap_false
                    iv_data_temperature         = lv_data_temperature    "FAGLL03 4./5. HW
                    i_selection                 = gt_selection_full
*                   I_FIELDLIST                 =
                    i_blocksize                 = gd_max_pack_lines      "987950
                    i_block_data                = gusl_c_true            "987950
*                   I_AGGREGATION               = GUSL_C_FALSE
                    i_read_bseg                 = ld_read_bseg
                    i_max_lines                 = gd_max_lines
                    i_reset_init                = lv_reset_init  "correction archive and non archive
                  IMPORTING                                   "987950
                    flag_cursor_open            = gd_cursor_open         "987950
                  CHANGING
                    c_t_faglpose                = it_sel.

                CLEAR lv_reset_init. "correction archive and non archive

              ENDIF.

              CLEAR gd_xarch.
              LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
                IF NOT x_merk IS INITIAL
                OR NOT x_erfs IS INITIAL.
                  gp_yrper(4) = wa_sel-gjahr.
                  gp_yrper+5  = wa_sel-monat.
                ELSE.
                  gp_yrper(4) = wa_sel-ryear.
                  gp_yrper+4 = wa_sel-poper.
                ENDIF.
                CHECK gp_yrper IN so_yrper.
                IF  NOT gd_usear IS INITIAL
                AND NOT x_erfs IS INITIAL
                AND NOT wa_sel-xarch IS INITIAL.
                ELSE.
* writing items into it_pos.
                  PERFORM pos_table_fill  CHANGING  x_stop.
                ENDIF.
                IF NOT x_stop IS INITIAL.
                  CLEAR gd_cursor_open.                     "987950
                  EXIT.
                ENDIF.
              ENDLOOP.
              IF NOT gd_max_lines IS INITIAL.
                DESCRIBE TABLE it_sel LINES ld_lines.
                gd_max_lines = gd_max_lines - ld_lines.
              ENDIF.
            ENDWHILE.                                       "987950
            FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.            "1105201
            FREE MEMORY ID 'FAGLL03_REMAIN_SEL_BSEG'.

* tmp skip select FAGL_GET_ITEMS_BSAS for option all items (x_aisel) as all items are selected with FAGL_GET_ITEMS_BSIS
            IF NOT ( x_aisel = abap_true
            AND ( cl_fins_acdoc_util=>is_simulation_ledger( iv_rldnr = gv_relevant_ledger ) = abap_true
            OR cl_fins_acdoc_util=>is_prediction_ledger( iv_rldnr = gv_relevant_ledger ) = abap_true ) ).

              gd_cursor_open = 'X'.                         "987950
              WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL. "987950
*             check x_stop is initial.                         "987950
                REFRESH it_sel.
                CALL FUNCTION 'FAGL_GET_ITEMS_BSAS'
                  EXPORTING
                    iv_acdoc_compatibility_mode = abap_false
                    iv_data_temperature         = lv_data_temperature    "FAGLL03 4./5. HW
                    i_selection                 = gt_selection_full
*                   I_FIELDLIST                 =
                    i_blocksize                 = gd_max_pack_lines      "987950
                    i_block_data                = gusl_c_true            "987950
*                   I_AGGREGATION               = GUSL_C_FALSE
                    i_read_bseg                 = ld_read_bseg
                    i_max_lines                 = gd_max_lines
                    i_reset_init                = lv_reset_init  "correction archive and non archive
                  IMPORTING                                   "987950
                    flag_cursor_open            = gd_cursor_open         "987950
                  CHANGING
                    c_t_faglpose                = it_sel.

                CLEAR lv_reset_init.  "correction archive and non archive

                CLEAR gd_xarch.
                LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
                  IF NOT x_merk IS INITIAL
                  OR NOT x_erfs IS INITIAL.
                    gp_yrper(4) = wa_sel-gjahr.
                    gp_yrper+5  = wa_sel-monat.
                  ELSE.
                    gp_yrper(4) = wa_sel-ryear.
                    gp_yrper+4 = wa_sel-poper.
                  ENDIF.
                  CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
                  IF  NOT gd_usear IS INITIAL
                  AND NOT x_erfs IS INITIAL
                  AND NOT wa_sel-xarch IS INITIAL.
                  ELSE.
                    PERFORM pos_table_fill  CHANGING  x_stop.
                  ENDIF.
                  IF NOT x_stop IS INITIAL.
                    CLEAR gd_cursor_open.                   "987950
                    EXIT.
                  ENDIF.
                ENDLOOP.
                IF NOT gd_max_lines IS INITIAL.
                  DESCRIBE TABLE it_sel LINES ld_lines.
                  gd_max_lines = gd_max_lines - ld_lines.
                ENDIF.
              ENDWHILE.                                     "987950
              FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.          "1105201
            ENDIF.
          ENDIF.

          IF NOT gd_usear IS INITIAL.
            CHECK x_stop IS INITIAL.
            REFRESH it_sel.
            lt_files[] = gt_files[].
            CALL FUNCTION 'FAGL_GET_ARCH_ITEMS_BSIS'
              EXPORTING
                i_selection  = gt_selection_full
*               I_FIELDLIST  =
*               I_BLOCKSIZE  =
*               I_BLOCK_DATA = GUSL_C_FALSE
*               I_AGGREGATION          = GUSL_C_FALSE
                i_read_bseg  = ld_read_bseg
                i_arch_sel   = lt_files
                i_max_lines  = gd_max_lines
*             IMPORTING
*               FLAG_CURSOR_OPEN       =
              CHANGING
                c_t_faglpose = it_sel
                c_t_bkpf     = ybkpf
                c_t_bseg     = ybseg.

            lv_reset_init = abap_true. "correction archive and non archive
            gd_xarch = 'X'.
            LOOP AT it_sel INTO wa_sel.
              wa_sel-xarch = 'X'.
* relevant basically if report is called from balance display.
              IF NOT x_merk IS INITIAL
              OR NOT x_erfs IS INITIAL.
                gp_yrper(4) = wa_sel-gjahr.
                gp_yrper+5  = wa_sel-monat.
              ELSE.
                gp_yrper(4) = wa_sel-ryear.
                gp_yrper+4 = wa_sel-poper.
              ENDIF.
              CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
              PERFORM pos_table_fill  CHANGING  x_stop.
              IF NOT x_stop IS INITIAL.
                EXIT.
              ENDIF.
            ENDLOOP.
            PERFORM import_arch_from_itab.
            IF NOT gd_max_lines IS INITIAL.
              DESCRIBE TABLE it_sel LINES ld_lines.
              gd_max_lines = gd_max_lines - ld_lines.
            ENDIF.
            FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.            "1105201
          ENDIF.
        ENDIF.
      ENDIF.                                                "1004374
    ENDIF.

    IF ( skb1-xopvw IS INITIAL
    AND ( ( NOT skb1-xkres IS INITIAL
          AND skb1-mitkz NE 'D'
          AND skb1-mitkz NE 'K')
          OR skb1-xkres IS INITIAL )
    AND skb1-xlgclr IS INITIAL
    AND NOT x_norm IS INITIAL
    AND x_merk IS INITIAL
    AND x_park IS INITIAL
    AND x_erfs IS INITIAL )
    OR NOT gv_special_account IS INITIAL.                   "1004374
      IF NOT gd_usedb IS INITIAL.
        gd_cursor_open = 'X'.                               "987950
        WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL.   "987950
*         check x_stop is initial.                             "987950
          REFRESH it_sel.
          CALL FUNCTION 'FAGL_GET_ITEMS_BSEG'
            EXPORTING
              iv_acdoc_compatibility_mode = abap_false
              iv_data_temperature         = lv_data_temperature
              i_selection                 = gt_selection_full
*             I_FIELDLIST                 =
              i_blocksize                 = gd_max_pack_lines          "987950
              i_block_data                = gusl_c_true                "987950
*             I_AGGREGATION               = GUSL_C_FALSE
              i_max_lines                 = gd_max_lines
              i_reset_init                = lv_reset_init  "correction archive and non archive
            IMPORTING                                       "987950
              flag_cursor_open            = gd_cursor_open             "987950
            CHANGING
              c_t_faglpose                = it_sel.

          CLEAR lv_reset_init.  "correction archive and non archive

          CLEAR gd_xarch.
          LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
            IF NOT x_merk IS INITIAL
            OR NOT x_erfs IS INITIAL.
              gp_yrper(4) = wa_sel-gjahr.
              gp_yrper+5  = wa_sel-monat.
            ELSE.
              gp_yrper(4) = wa_sel-ryear.
              gp_yrper+4 = wa_sel-poper.
            ENDIF.
            CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
            PERFORM pos_table_fill  CHANGING  x_stop.
            IF NOT x_stop IS INITIAL.
              CLEAR gd_cursor_open.                         "987950
              EXIT.
            ENDIF.
          ENDLOOP.
          IF NOT gd_max_lines IS INITIAL.
            DESCRIBE TABLE it_sel LINES ld_lines.
            gd_max_lines = gd_max_lines - ld_lines.
          ENDIF.
        ENDWHILE.                                           "987950
*        FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.                "1105201
        FREE MEMORY ID 'FAGLL03_REMAIN_SEL_BSEG'.
      ENDIF.

      IF NOT gd_usear IS INITIAL.
        CHECK x_stop IS INITIAL.
        REFRESH it_sel.
        lt_files[] = gt_files[].
        CALL FUNCTION 'FAGL_GET_ARCH_ITEMS_BSEG'
          EXPORTING
            i_selection  = gt_selection_full
*           I_FIELDLIST  =
*           I_BLOCKSIZE  =
*           I_BLOCK_DATA = GUSL_C_FALSE
*           I_AGGREGATION          = GUSL_C_FALSE
            i_arch_sel   = lt_files
            i_max_lines  = gd_max_lines
*         IMPORTING
*           FLAG_CURSOR_OPEN       =
          CHANGING
            c_t_faglpose = it_sel
            c_t_bkpf     = ybkpf
            c_t_bseg     = ybseg.
        lv_reset_init = abap_true. "correction archive and non archive
        gd_xarch = 'X'.
        LOOP AT it_sel INTO wa_sel.
          wa_sel-xarch = 'X'.
* relevant basically if report is called from balance display.
          IF NOT x_merk IS INITIAL
          OR NOT x_erfs IS INITIAL.
            gp_yrper(4) = wa_sel-gjahr.
            gp_yrper+5  = wa_sel-monat.
          ELSE.
            gp_yrper(4) = wa_sel-ryear.
            gp_yrper+4 = wa_sel-poper.
          ENDIF.
          CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
          PERFORM pos_table_fill  CHANGING  x_stop.
          IF NOT x_stop IS INITIAL.
            EXIT.
          ENDIF.
        ENDLOOP.
        PERFORM import_arch_from_itab.
        IF NOT gd_max_lines IS INITIAL.
          DESCRIBE TABLE it_sel LINES ld_lines.
          gd_max_lines = gd_max_lines - ld_lines.
        ENDIF.
        FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.                "1105201
      ENDIF.
    ENDIF.

* read items from faglbsis if ledger group specific clearing
    IF skb1-xlgclr = 'X'.
      IF gv_special_account IS INITIAL.                     "1004374
*        IF NOT x_merk IS INITIAL
*        OR NOT x_norm IS INITIAL.
        IF NOT x_norm IS INITIAL.
          IF NOT gd_usedb IS INITIAL.
            gd_cursor_open = 'X'.                           "987950
            WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL. "987950
*             check x_stop is initial.                         "987950
              REFRESH it_sel.
              CALL FUNCTION 'FAGL_GET_ITEMS_FAGLBSIS'
                EXPORTING
                  iv_acdoc_compatibility_mode = abap_false
                  iv_data_temperature         = lv_data_temperature    "FAGLL03 4./5. HW
                  i_selection                 = gt_selection_full
*                 I_FIELDLIST                 =
                  i_blocksize                 = gd_max_pack_lines      "987950
                  i_block_data                = gusl_c_true            "987950
*                 I_AGGREGATION               = GUSL_C_FALSE
                  i_read_bseg                 = ld_read_bseg
                  i_max_lines                 = gd_max_lines
                  i_reset_init                = lv_reset_init  "correction archive and non archive
                IMPORTING                                   "987950
                  flag_cursor_open            = gd_cursor_open         "987950
                CHANGING
                  c_t_faglpose                = it_sel.

              CLEAR lv_reset_init.  "correction archive and non archive

              CLEAR gd_xarch.
              LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
                IF NOT x_merk IS INITIAL
                OR NOT x_erfs IS INITIAL.
                  gp_yrper(4) = wa_sel-gjahr.
                  gp_yrper+5  = wa_sel-monat.
                ELSE.
                  gp_yrper(4) = wa_sel-ryear.
                  gp_yrper+4 = wa_sel-poper.
                ENDIF.
                CHECK gp_yrper IN so_yrper.
                IF  NOT gd_usear IS INITIAL
                AND NOT x_erfs IS INITIAL
                AND NOT wa_sel-xarch IS INITIAL.
                ELSE.
* writing items into it_pos.
                  PERFORM pos_table_fill  CHANGING  x_stop.
                ENDIF.
                IF NOT x_stop IS INITIAL.
                  CLEAR gd_cursor_open.                     "987950
                  EXIT.
                ENDIF.
              ENDLOOP.
              IF NOT gd_max_lines IS INITIAL.
                DESCRIBE TABLE it_sel LINES ld_lines.
                gd_max_lines = gd_max_lines - ld_lines.
              ENDIF.
            ENDWHILE.                                       "987950
            FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.            "1105201

* Note 2914454
* tmp skip select FAGL_GET_ITEMS_BSAS for option all items (x_aisel) as all items are selected with FAGL_GET_ITEMS_BSIS
            IF NOT ( x_aisel = abap_true
            AND ( cl_fins_acdoc_util=>is_simulation_ledger( iv_rldnr = gv_relevant_ledger ) = abap_true
            OR cl_fins_acdoc_util=>is_prediction_ledger( iv_rldnr = gv_relevant_ledger ) = abap_true ) ).

            gd_cursor_open = 'X'.                           "987950
            WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL. "987950
*             check x_stop is initial.                         "987950
              REFRESH it_sel.
              CALL FUNCTION 'FAGL_GET_ITEMS_FAGLBSAS'
                EXPORTING
                  iv_acdoc_compatibility_mode = abap_false             "FAGLL03 4./5. HW
                  iv_data_temperature         = lv_data_temperature    "FAGLL03 4./5. HW
                  i_selection                 = gt_selection_full
*                   I_FIELDLIST                 =
                    i_blocksize                 = gd_max_pack_lines      "987950
                    i_block_data                = gusl_c_true            "987950
*                   I_AGGREGATION               = GUSL_C_FALSE
                  i_read_bseg                 = ld_read_bseg
                  i_max_lines                 = gd_max_lines
                  i_reset_init                = lv_reset_init  "correction archive and non archive
                IMPORTING                                   "987950
                  flag_cursor_open            = gd_cursor_open         "987950
                CHANGING
                  c_t_faglpose                = it_sel.

              CLEAR lv_reset_init.  "correction archive and non archive

              CLEAR gd_xarch.
              LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
                IF NOT x_merk IS INITIAL
                OR NOT x_erfs IS INITIAL.
                  gp_yrper(4) = wa_sel-gjahr.
                  gp_yrper+5  = wa_sel-monat.
                ELSE.
                  gp_yrper(4) = wa_sel-ryear.
                  gp_yrper+4 = wa_sel-poper.
                ENDIF.
                CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
                IF  NOT gd_usear IS INITIAL
                AND NOT x_erfs IS INITIAL
                AND NOT wa_sel-xarch IS INITIAL.
                ELSE.
                  PERFORM pos_table_fill  CHANGING  x_stop.
                ENDIF.
                IF NOT x_stop IS INITIAL.
                  CLEAR gd_cursor_open.                     "987950
                  EXIT.
                ENDIF.
              ENDLOOP.
              IF NOT gd_max_lines IS INITIAL.
                DESCRIBE TABLE it_sel LINES ld_lines.
                gd_max_lines = gd_max_lines - ld_lines.
              ENDIF.
            ENDWHILE.                                       "987950
            FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.            "1105201
           ENDIF.
          ENDIF.
** If items are archieved
          IF NOT gd_usear IS INITIAL.
            CHECK x_stop IS INITIAL.
            REFRESH it_sel.
            lt_files[] = gt_files[].
            CALL FUNCTION 'FAGL_GET_ARCH_ITEMS_FAGLBSAS'
              EXPORTING
                i_selection  = gt_selection_full
*               I_FIELDLIST  =
*               I_BLOCKSIZE  =
*               I_BLOCK_DATA = GUSL_C_FALSE
*               I_AGGREGATION          = GUSL_C_FALSE
                i_read_bseg  = ld_read_bseg
                i_arch_sel   = lt_files
                i_max_lines  = gd_max_lines
*             IMPORTING
*               FLAG_CURSOR_OPEN       =
              CHANGING
                c_t_faglpose = it_sel
                c_t_bkpf     = ybkpf
                c_t_bseg     = ybseg.
            lv_reset_init = abap_true. "correction archive and non archive
            gd_xarch = 'X'.
            LOOP AT it_sel INTO wa_sel.
              wa_sel-xarch = 'X'.
* relevant basically if report is called from balance display.
              IF NOT x_merk IS INITIAL
              OR NOT x_erfs IS INITIAL.
                gp_yrper(4) = wa_sel-gjahr.
                gp_yrper+5  = wa_sel-monat.
              ELSE.
                gp_yrper(4) = wa_sel-ryear.
                gp_yrper+4 = wa_sel-poper.
              ENDIF.
              CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
              PERFORM pos_table_fill  CHANGING  x_stop.
              IF NOT x_stop IS INITIAL.
                EXIT.
              ENDIF.
            ENDLOOP.
            PERFORM import_arch_from_itab.
            IF NOT gd_max_lines IS INITIAL.
              DESCRIBE TABLE it_sel LINES ld_lines.
              gd_max_lines = gd_max_lines - ld_lines.
            ENDIF.
            FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.            "1105201
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    IF NOT x_park IS INITIAL.
      IF NOT gd_usedb IS INITIAL.
        CHECK x_stop IS INITIAL.
        REFRESH it_sel.
        CALL FUNCTION 'FAGL_GET_ITEMS_VBSEGS'
          EXPORTING
            i_selection  = gt_selection_full
*           I_FIELDLIST  =
*           I_BLOCKSIZE  =
*           I_BLOCK_DATA = GUSL_C_FALSE
*           I_AGGREGATION          = GUSL_C_FALSE
            i_max_lines  = gd_max_lines
            i_reset_init = lv_reset_init  "correction archive and non archive
*         IMPORTING
*           FLAG_CURSOR_OPEN       =
          CHANGING
            c_t_faglpose = it_sel.

        CLEAR lv_reset_init. "correction archive and non archive

        CLEAR gd_xarch.
        LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
          gp_yrper(4) = wa_sel-gjahr.
          gp_yrper+5  = wa_sel-monat.
          CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
          PERFORM pos_table_fill  CHANGING  x_stop.
          IF NOT x_stop IS INITIAL.
            EXIT.
          ENDIF.
        ENDLOOP.
        IF NOT gd_max_lines IS INITIAL.
          DESCRIBE TABLE it_sel LINES ld_lines.
          gd_max_lines = gd_max_lines - ld_lines.
        ENDIF.
      ENDIF.
    ENDIF.
  ELSE.
*cleared items
    IF ( NOT skb1-xopvw IS INITIAL
    OR ( NOT skb1-xkres IS INITIAL
         AND NOT x_erfs IS INITIAL )
    OR ( NOT skb1-xkres IS INITIAL
         AND x_erfs IS INITIAL
         AND ( gv_relevant_ledger = gv_leading_ledger
         OR skb1-mitkz EQ 'D' OR skb1-mitkz EQ 'K' ) ) ).
      IF NOT x_norm IS INITIAL.
        IF NOT gd_usedb IS INITIAL.
          IF ( skb1-mitkz EQ 'D' OR skb1-mitkz EQ 'K' )     "1107639
          AND skb1-xkres NE space AND x_erfs IS INITIAL.    "1699013
            ld_read_bseg = 'X'.                             "1107639
          ENDIF.                                            "1107639
          gd_cursor_open = 'X'.                             "987950
          WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL. "987950
*           check x_stop is initial.                           "987950
            REFRESH it_sel.
            CALL FUNCTION 'FAGL_GET_ITEMS_BSAS'
              EXPORTING
                iv_acdoc_compatibility_mode = abap_false
                iv_data_temperature         = lv_data_temperature    "FAGLL03 4./5. HW
                i_selection                 = gt_selection_full
*               I_FIELDLIST                 =
                i_blocksize                 = gd_max_pack_lines        "987950
                i_block_data                = gusl_c_true              "987950
*               I_AGGREGATION               = GUSL_C_FALSE
                i_read_bseg                 = ld_read_bseg             "1107639
                i_max_lines                 = gd_max_lines
                i_reset_init                = lv_reset_init  "correction archive and non archive
              IMPORTING                                     "987950
                flag_cursor_open            = gd_cursor_open           "987950
              CHANGING
                c_t_faglpose                = it_sel.

            CLEAR lv_reset_init. "correction archive and non archive

            CLEAR gd_xarch.
            LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
              IF NOT x_merk IS INITIAL
              OR NOT x_erfs IS INITIAL.
                gp_yrper(4) = wa_sel-gjahr.
                gp_yrper+5  = wa_sel-monat.
              ELSE.
                gp_yrper(4) = wa_sel-ryear.
                gp_yrper+4 = wa_sel-poper.
              ENDIF.
              CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
              IF  NOT gd_usear IS INITIAL
              AND NOT x_erfs IS INITIAL
              AND NOT wa_sel-xarch IS INITIAL.
              ELSE.
                PERFORM pos_table_fill  CHANGING  x_stop.
              ENDIF.
              IF NOT x_stop IS INITIAL.
                CLEAR gd_cursor_open.                       "987950
                EXIT.
              ENDIF.
            ENDLOOP.
            IF NOT gd_max_lines IS INITIAL.
              DESCRIBE TABLE it_sel LINES ld_lines.
              gd_max_lines = gd_max_lines - ld_lines.
            ENDIF.
          ENDWHILE.                                         "987950
          FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.              "1105201
        ENDIF.

        IF NOT gd_usear IS INITIAL.
          CHECK x_stop IS INITIAL.
          REFRESH it_sel.
          lt_files[] = gt_files[].
          CALL FUNCTION 'FAGL_GET_ARCH_ITEMS_BSIS'
            EXPORTING
              i_selection  = gt_selection_full
*             I_FIELDLIST  =
*             I_BLOCKSIZE  =
*             I_BLOCK_DATA = GUSL_C_FALSE
*             I_AGGREGATION          = GUSL_C_FALSE
              i_read_bseg  = ld_read_bseg         "1107639
              i_arch_sel   = lt_files
              i_max_lines  = gd_max_lines
*           IMPORTING
*             FLAG_CURSOR_OPEN       =
            CHANGING
              c_t_faglpose = it_sel
              c_t_bkpf     = ybkpf
              c_t_bseg     = ybseg.
          lv_reset_init = abap_true. "correction archive and non archive
          gd_xarch = 'X'.
          LOOP AT it_sel INTO wa_sel.
            wa_sel-xarch = 'X'.
* relevant basically if report is called from balance display.
            IF NOT x_merk IS INITIAL
            OR NOT x_erfs IS INITIAL.
              gp_yrper(4) = wa_sel-gjahr.
              gp_yrper+5  = wa_sel-monat.
            ELSE.
              gp_yrper(4) = wa_sel-ryear.
              gp_yrper+4 = wa_sel-poper.
            ENDIF.
            CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
            PERFORM pos_table_fill  CHANGING  x_stop.
            IF NOT x_stop IS INITIAL.
              EXIT.
            ENDIF.
          ENDLOOP.
          PERFORM import_arch_from_itab.
          IF NOT gd_max_lines IS INITIAL.
            DESCRIBE TABLE it_sel LINES ld_lines.
            gd_max_lines = gd_max_lines - ld_lines.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSEIF skb1-xlgclr = 'X'.
      IF NOT x_norm IS INITIAL.
        IF NOT gd_usedb IS INITIAL.
          gd_cursor_open = 'X'.                             "987950
          WHILE gd_cursor_open = 'X' AND x_stop IS INITIAL. "987950
*           check x_stop is initial.                           "987950
            REFRESH it_sel.
            CALL FUNCTION 'FAGL_GET_ITEMS_FAGLBSAS'
              EXPORTING
                iv_acdoc_compatibility_mode = abap_false     "FAGLL03 4./5. HW
                iv_data_temperature         = lv_data_temperature    "FAGLL03 4./5. HW
                i_selection                 = gt_selection_full
*               I_FIELDLIST                 =
                i_blocksize                 = gd_max_pack_lines        "987950
                i_block_data                = gusl_c_true              "987950
*               I_AGGREGATION               = GUSL_C_FALSE
                i_max_lines                 = gd_max_lines
                i_reset_init                = lv_reset_init  "correction archive and non archive
              IMPORTING                                     "987950
                flag_cursor_open            = gd_cursor_open           "987950
              CHANGING
                c_t_faglpose                = it_sel.

            CLEAR lv_reset_init. "correction archive and non archive

            CLEAR gd_xarch.
            LOOP AT it_sel INTO wa_sel.
* relevant basically if report is called from balance display.
              IF NOT x_merk IS INITIAL
              OR NOT x_erfs IS INITIAL.
                gp_yrper(4) = wa_sel-gjahr.
                gp_yrper+5  = wa_sel-monat.
              ELSE.
                gp_yrper(4) = wa_sel-ryear.
                gp_yrper+4 = wa_sel-poper.
              ENDIF.
              CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
              IF  NOT gd_usear IS INITIAL
              AND NOT x_erfs IS INITIAL
              AND NOT wa_sel-xarch IS INITIAL.
              ELSE.
                PERFORM pos_table_fill  CHANGING  x_stop.
              ENDIF.
              IF NOT x_stop IS INITIAL.
                CLEAR gd_cursor_open.                       "987950
                EXIT.
              ENDIF.
            ENDLOOP.
            IF NOT gd_max_lines IS INITIAL.
              DESCRIBE TABLE it_sel LINES ld_lines.
              gd_max_lines = gd_max_lines - ld_lines.
            ENDIF.
          ENDWHILE.                                         "987950
          FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.              "1105201
        ENDIF.

        IF NOT gd_usear IS INITIAL.
          CHECK x_stop IS INITIAL.
          REFRESH it_sel.
          lt_files[] = gt_files[].
          CALL FUNCTION 'FAGL_GET_ARCH_ITEMS_FAGLBSAS'
            EXPORTING
              i_selection  = gt_selection_full
*             I_FIELDLIST  =
*             I_BLOCKSIZE  =
*             I_BLOCK_DATA = GUSL_C_FALSE
*             I_AGGREGATION          = GUSL_C_FALSE
              i_arch_sel   = lt_files
              i_max_lines  = gd_max_lines
*           IMPORTING
*             FLAG_CURSOR_OPEN       =
            CHANGING
              c_t_faglpose = it_sel
              c_t_bkpf     = ybkpf
              c_t_bseg     = ybseg.
          lv_reset_init = abap_true. "correction archive and non archive
          gd_xarch = 'X'.
          LOOP AT it_sel INTO wa_sel.
            wa_sel-xarch = 'X'.
* relevant basically if report is called from balance display.
            IF NOT x_merk IS INITIAL
            OR NOT x_erfs IS INITIAL.
              gp_yrper(4) = wa_sel-gjahr.
              gp_yrper+5  = wa_sel-monat.
            ELSE.
              gp_yrper(4) = wa_sel-ryear.
              gp_yrper+4 = wa_sel-poper.
            ENDIF.
            CHECK gp_yrper IN so_yrper.
* writing items into it_pos.
            PERFORM pos_table_fill  CHANGING  x_stop.
            IF NOT x_stop IS INITIAL.
              EXIT.
            ENDIF.
          ENDLOOP.
          PERFORM import_arch_from_itab.
          IF NOT gd_max_lines IS INITIAL.
            DESCRIBE TABLE it_sel LINES ld_lines.
            gd_max_lines = gd_max_lines - ld_lines.
          ENDIF.
          FREE MEMORY ID 'FAGLL03_REMAIN_SEL'.              "1105201
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

 ENDFORM.                    " select_items
*&---------------------------------------------------------------------*
*&      Form  check_auth_ledger
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_auth_ledger .
  DATA: lt_bukrs TYPE bukrs OCCURS 0 WITH HEADER LINE.

  IF NOT sd_bukrs[] IS INITIAL.
    SELECT bukrs FROM t001 INTO TABLE lt_bukrs
    WHERE bukrs IN sd_bukrs.
  ELSE.
*  Possibly the worklist function is active
    SELECT bukrs FROM t001 INTO TABLE lt_bukrs
    WHERE bukrs IN so_wlbuk.
  ENDIF.
  LOOP AT lt_bukrs.
    CALL FUNCTION 'FAGL_AUTHORITY_LEDGER'
      EXPORTING
        i_bukrs = lt_bukrs
        i_rldnr = gv_relevant_ledger
        i_actvt = '03'.
  ENDLOOP.
ENDFORM.                    " check_auth_ledger
*&---------------------------------------------------------------------*
*&      Form  init_rri_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM init_rri_data .
  DATA: ls_fieldr TYPE rstifields
        , lt_fieldr       TYPE TABLE OF rstifields.
  DATA: ls_sel          TYPE rstisel
      , ls_sel_2        TYPE rstisel
      , lt_sel          TYPE TABLE OF rstisel
      , ls_fields       TYPE rstifields
      , lt_fields       TYPE TABLE OF rstifields.
  DATA: ld_rldnr        TYPE rldnr.
  DATA: ld_si_table     TYPE tabname.
  DATA: ld_tabname      TYPE tabname.
  DATA: lt_x031l_1  LIKE x031l OCCURS 0 WITH HEADER LINE.
  DATA: lt_x031l_2  LIKE x031l OCCURS 0 WITH HEADER LINE.
  FIELD-SYMBOLS: <wa1> TYPE any.
  FIELD-SYMBOLS: <wa2> TYPE table.
  DATA: ld_t_range_name TYPE string.
  DATA: BEGIN OF lt_selection OCCURS 0,
          tablename TYPE tabname,
          fieldname TYPE fieldname.
          INCLUDE TYPE gusl_s_range.
        DATA: END   OF lt_selection.
  DATA: ls_tablenames  TYPE fagl_tabnames.
  DATA: ds_trange_tab_line TYPE rsds_range.
  DATA: ds_frange_tab_line TYPE rsds_frange.
  DATA: ds_texpr_tab_line TYPE rsds_expr.
  DATA: ds_expr_tab_tab_line LIKE rsdsexpr.
  DATA: ld_fieldname TYPE rsdsexpr-fieldname.
  DATA: ls_texpr_tab_line TYPE rsds_expr.
  DATA: ls_expr_tab_line LIKE rsdsexpr.
  DATA: ls_num LIKE sy-tfill.
  DATA: ls_field LIKE rsdsfields.
  DATA: ls_selopt      TYPE rsdsselopt.
  DATA: ls_selopt_t    TYPE rsds_selopt_t.
  DATA: a_rec          LIKE rstirec.
  DATA: rri_subrc      LIKE sy-subrc.
  DATA: ld_versn       LIKE t011-versn.
  DATA: ld_lines       TYPE i.
  DATA: ld_ergsl       LIKE rf011p-ergsl.
  DATA: ld_poper       TYPE poper.
  DATA: ld_ryear       TYPE gjahr.
  DATA: ld_yrper       LIKE gp_yrper.
  DATA: ld_curtp       TYPE curtp.
  DATA: ld_variant     TYPE slis_vari.
  CONSTANTS:
    lc_variant_s_fc TYPE slis_vari VALUE '1SAP-FC',
    lc_variant_s_lc TYPE slis_vari VALUE '1SAP-LC'.
  DATA: ld_kennzahl_set   TYPE boolean.                     "1093945
  DATA: ld_xbilk_acc      TYPE boolean.                     "1692932
  DATA: ld_xbilk_cnt      TYPE i.                           "1692932
  DATA: ld_ktopl          TYPE ska1-ktopl.                  "1692932
  DATA: ld_account_found  TYPE boolean.                     "1093945
  DATA: ld_cum_display    TYPE boolean.                     "1093945
  DATA: ld_bukrs          LIKE t001-bukrs.                  "1093945
  DATA: ld_saknr          LIKE ska1-saknr.                  "1093945
  DATA: ls_ska1           LIKE ska1.                        "1093945
  DATA: ls_t001           LIKE t001.                        "1093945
  DATA: lt_set_sel        TYPE TABLE OF rgsb4.              "1417516
  DATA: ls_set_sel        TYPE rgsb4.                       "1417516
  DATA: setnr(50)         TYPE c.                           "1417516


  CALL FUNCTION 'RSTI_APPL_STACK_POP'
    IMPORTING
      i_rec                      = a_rec
    EXCEPTIONS
      appl_stack_not_initialized = 1.
  rri_subrc = sy-subrc.
  IF rri_subrc = 0.
*    check Receiver is this report
    IF NOT ( ( a_rec-rtool = 'RT'
               AND a_rec-ronam = 'FAGL_ACCOUNT_ITEMS_GL' )
          OR ( a_rec-rtool = 'TR' AND a_rec-ronam = 'FAGLL03' ) ) .
      rri_subrc = 2.
    ENDIF.
  ENDIF.
  IF rri_subrc = 0.
    REFRESH sd_bukrs.
    REFRESH sd_saknr.
    CLEAR   gd_wl_on.
    CLEAR   x_opsel.
    x_aisel = 'X'.
    gv_xrric = 'X'.

    CALL FUNCTION 'RSTI_SELECTION_IMPORT'
      TABLES
        it_sel            = lt_sel
        it_fields         = lt_fields
      EXCEPTIONS
        no_selection_data = 1
        OTHERS            = 2.
    IF sy-subrc <> 0.
      CALL FUNCTION 'RSTI_APPL_STACK_INITIALIZE'
        EXPORTING
          e_tool = a_rec-rtool
          e_onam = a_rec-ronam.
      EXIT.
    ENDIF.

* delete selection which are not given correctly            "984308
    LOOP AT lt_sel INTO ls_sel                              "984308
      WHERE sign   IS INITIAL                               "984308
        AND option IS INITIAL                               "984308
        AND low    IS INITIAL.                              "984308
      DELETE lt_sel.                                        "984308
    ENDLOOP.                                                "984308

* deleted restrictions to USEDB, USEAR and USEAS               "1599984
    LOOP AT lt_sel INTO ls_sel
      WHERE field = 'USEDB'
         OR field = 'USEAR'
         OR field = 'USEAS'.
      DELETE lt_sel.
    ENDLOOP.

* customer could have used the special selection field 'PERIO'   "1703181
    LOOP AT lt_sel INTO ls_sel
      WHERE field = 'RYEAR'.
    ENDLOOP.
    IF sy-subrc NE 0.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'POPER'.
      ENDLOOP.
      IF sy-subrc NE 0.
        LOOP AT lt_sel INTO ls_sel
          WHERE field = 'PERIO'.
        ENDLOOP.
        IF sy-subrc = 0.
          ls_sel_2-sign   = 'I'.
          ls_sel_2-option = 'EQ'.
          ls_sel_2-field  = 'RYEAR'.
          ls_sel_2-low    = ls_sel-low(4).
          APPEND ls_sel_2 TO lt_sel.
          ls_sel_2-field  = 'POPER'.
          ls_sel_2-low    = ls_sel-low+4(3).
          APPEND ls_sel_2 TO lt_sel.
        ENDIF.
      ENDIF.
    ENDIF.
* customer could have used the special selection field 'PERIO'   "1703181

* determine versn for recherche
    LOOP AT lt_sel INTO ls_sel
      WHERE field = 'VERSN'.
      ld_versn = ls_sel-low.
      DELETE lt_sel.
    ENDLOOP.
    IF ld_versn IS INITIAL.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'SAK_PLUMI'.
        ld_versn = ls_sel-hienm.
      ENDLOOP.
    ENDIF.
    LOOP AT lt_sel INTO ls_sel
      WHERE field = 'RACCT'.
      EXIT.
    ENDLOOP.
    IF sy-subrc = 0.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'SAK_PLUMI'
        OR field = 'ERGSL'
        OR field = 'SAKFB_LONG'.
        DELETE lt_sel.
      ENDLOOP.
    ENDIF.

    CLEAR ld_ktopl.                                         "1764246
    LOOP AT lt_sel INTO ls_sel WHERE field = 'KTOPL'.       "1692932
      ld_ktopl = ls_sel-low.                                "1692932
    ENDLOOP.                                                "1692932
    IF ld_ktopl IS INITIAL.                                 "1764246
      LOOP AT lt_sel INTO ls_sel WHERE field = 'RKTPL'.     "1764246
        ld_ktopl = ls_sel-low.                              "1764246
      ENDLOOP.                                              "1764246
    ENDIF.                                                  "1764246
    IF ld_ktopl IS INITIAL.                                 "1764246
      ld_ktopl = ld_versn.                                  "1692932
    ENDIF.                                                  "1692932
    LOOP AT lt_sel INTO ls_sel WHERE field = '&KKENNZAHL'.  "1692932
      IF ls_sel-low = 'BILWERT'.                            "1692932
        ld_kennzahl_set = 'X'.                              "1692932
      ENDIF.                                                "1692932
    ENDLOOP.                                                "1692932
    CLEAR ld_xbilk_acc.                                     "1692932


* Begin of Note "1093945
    LOOP AT lt_sel INTO ls_sel.
* determine Company Code
      IF ls_sel-field = 'BUKRS'                             "1257457
      OR ls_sel-field = 'RBUKRS'.
        CLEAR lt_selection.
        ls_sel-field = 'SD_BUKRS'.
        MOVE-CORRESPONDING ls_sel TO lt_selection.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
        DELETE lt_sel.
      ENDIF.
* determine GL Accounts
      IF ls_sel-field = 'RACCT'
      OR ls_sel-field = 'SAKNR'
      OR ls_sel-field = 'HKONT'
      OR ( ls_sel-field = 'COST_ELEM'                       "1847834
                     AND NOT ls_sel-type = 'SET' ).         "1847834
        CLEAR lt_selection.
        ls_sel-field = 'SD_SAKNR'.
        MOVE-CORRESPONDING ls_sel TO lt_selection.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
        IF ld_kennzahl_set = 'X'.                           "1692932
          SELECT SINGLE COUNT(*) FROM ska1 INTO ld_xbilk_cnt "1692932
                              WHERE ktopl = ld_ktopl        "1692932
                                AND saknr = ls_sel-low(10)  "1692932
          AND xbilk = 'X'.                                  "1692932
          IF sy-subrc = 0.                                  "1692932
            ld_xbilk_acc = 'X'.                             "1692932
          ENDIF.                                            "1692932
        ENDIF.                                              "1692932
        DELETE lt_sel.
        ld_account_found = 'X'.                             "1093945
      ENDIF.
    ENDLOOP.

    IF ld_account_found IS INITIAL.
      LOOP AT lt_sel INTO ls_sel.
* determine Accounts from FI recherche
        IF ( ls_sel-field = 'SAK_PLUMI'
        OR   ls_sel-field = 'ERGSL'
        OR   ls_sel-field = 'SAKFB_LONG' ).                 "1107224
          IF ld_versn IS INITIAL.                           "1107224
            ld_versn = ls_sel-hienm.                        "1107224
          ENDIF.                                            "1107224
          IF NOT ld_versn IS INITIAL.                       "1107224
            DATA: lt_accounts TYPE rfaccinf OCCURS 0 WITH HEADER LINE.
            ld_ergsl = ls_sel-low.
            CALL FUNCTION 'RGRE_ERGSL_TO_RACCT_CONVERT'
              EXPORTING
                i_bs_version         = ld_versn
                i_bs_item            = ld_ergsl
              TABLES
                t_accounts           = lt_accounts
              EXCEPTIONS
                bs_version_not_exist = 1
                OTHERS               = 2.
            IF sy-subrc <> 0.
*             MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*             WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
            ENDIF.

            DESCRIBE TABLE lt_accounts LINES ld_lines.
            CLEAR lt_selection.                             "1093945
            IF ld_lines GT 0.
              IF ld_kennzahl_set = 'X'.                     "1692932
                READ TABLE lt_accounts INDEX 1.             "1692932
                SELECT SINGLE COUNT(*) FROM ska1            "1692932
                          INTO ld_xbilk_cnt                 "1692932
                          WHERE ktopl = ld_ktopl            "1692932
                            AND saknr = lt_accounts-acct_from "1692932
                AND xbilk = 'X'.                            "1692932
                IF sy-subrc = 0.                            "1692932
                  ld_xbilk_acc = 'X'.                       "1692932
                ENDIF.                                      "1692932
              ENDIF.                                        "1692932
              LOOP AT lt_accounts.
                ls_sel-field = 'SD_SAKNR'.
                lt_selection-sign = 'I'.
                lt_selection-option = 'EQ'.
                lt_selection-low = lt_accounts-acct_from.
                lt_selection-fieldname = ls_sel-field.
                APPEND lt_selection.
              ENDLOOP.
              DELETE lt_sel.
            ELSE.
              CLEAR lt_selection.
              ls_sel-field = 'SD_SAKNR'.
              MOVE-CORRESPONDING ls_sel TO lt_selection.
              lt_selection-fieldname = ls_sel-field.
              APPEND lt_selection.
              IF ld_kennzahl_set = 'X'.                     "1692932
                SELECT SINGLE COUNT(*) FROM ska1            "1692932
                          INTO ld_xbilk_cnt                 "1692932
                          WHERE ktopl = ld_ktopl            "1692932
                            AND saknr = ls_sel-low(10)      "1692932
                AND xbilk = 'X'.                            "1692932
                IF sy-subrc = 0.                            "1692932
                  ld_xbilk_acc = 'X'.                       "1692932
                ENDIF.                                      "1692932
              ENDIF.                                        "1692932
              DELETE lt_sel.
            ENDIF.
          ENDIF.                                            "1107224
        ENDIF.
      ENDLOOP.
    ENDIF.

* Rewritten: Determine if a cumulated display is needed        "1363278
* determine kumsl for recherche
    CLEAR ld_kennzahl_set.                                  "1692932
    LOOP AT lt_sel INTO ls_sel
      WHERE field = 'KUMSL'.
      DELETE lt_sel.
    ENDLOOP.
    IF sy-subrc NE 0.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = '&KKENNZAHL'.
        IF   ls_sel-low = 'KUMSL'
          OR ( ls_sel-low = 'BILWERT'                       "1692932
                   AND ld_xbilk_acc = 'X' )                 "1692932
          OR ls_sel-low = 'KUMSOLL'
          OR ls_sel-low = 'KUMHABEN'.
          ld_kennzahl_set = 'X'.
        ENDIF.
      ENDLOOP.
    ELSE.
      ld_kennzahl_set = 'X'.
    ENDIF.
    IF ld_kennzahl_set = 'X'.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'POPER'.
        IF NOT ls_sel-high IS INITIAL.
          ld_poper = ls_sel-high.
        ELSE.
          ld_poper = ls_sel-low.
        ENDIF.
        DELETE lt_sel.
      ENDLOOP.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'RYEAR'.
        ld_ryear = ls_sel-low.
        DELETE lt_sel.
      ENDLOOP.
      ls_sel-field = 'SO_YRPER'.
      lt_selection-sign = 'I'.
      lt_selection-option = 'BT'.
      lt_selection-low = '1950001'.
      ld_yrper(4) = ld_ryear.
      ld_yrper+4(3) = ld_poper.
      lt_selection-high = ld_yrper.
      lt_selection-fieldname = ls_sel-field.
      APPEND lt_selection.
      gd_rri_so_set = 'X'.
      ls_sel-field = 'POPER'.
      lt_selection-sign = 'I'.
      lt_selection-option = 'BT'.
      lt_selection-low = '001'.
      lt_selection-high = ld_poper.
      lt_selection-fieldname = ls_sel-field.
      APPEND lt_selection.
      ls_sel-field = 'RYEAR'.
      lt_selection-sign = 'I'.
      lt_selection-option = 'BT'.
      lt_selection-low = '1950'.
      lt_selection-high = ld_ryear.
      lt_selection-fieldname = ls_sel-field.
      APPEND lt_selection.
    ENDIF.
    CLEAR ld_kennzahl_set.

* determine umsav recherche
    LOOP AT lt_sel INTO ls_sel
        WHERE field = 'UMSAV'.
      DELETE lt_sel.
    ENDLOOP.
    IF sy-subrc NE 0.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = '&KKENNZAHL'.
        IF   ls_sel-low = 'UMSAV'.
          ld_kennzahl_set = 'X'.
        ENDIF.
      ENDLOOP.
    ELSE.
      ld_kennzahl_set = 'X'.
    ENDIF.
    IF ld_kennzahl_set = 'X'.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'POPER'.
        DELETE lt_sel.
      ENDLOOP.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'RYEAR'.
        ld_ryear = ls_sel-low.
        DELETE lt_sel.
      ENDLOOP.
      gv_xumsav = 'X'.
      ls_sel-field = 'SO_YRPER'.
      lt_selection-sign = 'I'.
      lt_selection-option = 'BT'.
      lt_selection-low = '1950001'.
      ld_yrper(4) = ld_ryear - 1.
      ld_yrper+4(3) = '016'.
      lt_selection-high = ld_yrper.
      lt_selection-fieldname = ls_sel-field.
      APPEND lt_selection.
      gd_rri_so_set = 'X'.
      ls_sel-field = 'RYEAR'.
      lt_selection-sign = 'I'.
      lt_selection-option = 'BT'.
      lt_selection-low = '1950'.
      lt_selection-high = ld_ryear - 1.
      lt_selection-fieldname = ls_sel-field.
      APPEND lt_selection.
    ENDIF.
    CLEAR ld_kennzahl_set.
* Rewritten: Determine if a cumulated display is needed        "1363278

* Begin of Note 1093945
    LOOP AT lt_sel INTO ls_sel
      WHERE field = '&PARAMETER\MT-DATE'.
      EXIT.
    ENDLOOP.
    IF sy-subrc = 0.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = 'RPMAX'
           OR field = 'POPER'.
        IF ls_sel-low = '000'.
          ld_cum_display = 'X'.
        ENDIF.
      ENDLOOP.
      IF ld_cum_display = 'X'.
        LOOP AT lt_sel INTO ls_sel
          WHERE field = 'RPMAX'
             OR field = 'POPER'.
          IF NOT ls_sel-high IS INITIAL.
            IF ld_poper LE ls_sel-high.
              ld_poper = ls_sel-high.
            ENDIF.
          ELSE.
            IF ld_poper LE ls_sel-low.
              ld_poper = ls_sel-low.
            ENDIF.
          ENDIF.
          DELETE lt_sel.
        ENDLOOP.
        LOOP AT lt_sel INTO ls_sel
          WHERE field = 'RYEAR'.
          IF NOT ls_sel-high IS INITIAL.
            ld_ryear = ls_sel-high.
          ELSE.
            ld_ryear = ls_sel-low.
          ENDIF.
          DELETE lt_sel.
        ENDLOOP.
        ls_sel-field = 'SO_YRPER'.
        lt_selection-sign = 'I'.
        lt_selection-option = 'BT'.
        lt_selection-low = '1950001'.
        ld_yrper(4) = ld_ryear.
        ld_yrper+4(3) = ld_poper.
        lt_selection-high = ld_yrper.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
        gd_rri_so_set = 'X'.                                "1093945
        ls_sel-field = 'POPER'.
        lt_selection-sign = 'I'.
        lt_selection-option = 'BT'.
        lt_selection-low = '001'.
        lt_selection-high = ld_poper.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
        ls_sel-field = 'RYEAR'.
        lt_selection-sign = 'I'.
        lt_selection-option = 'BT'.
        lt_selection-low = '1950'.
        lt_selection-high = ld_ryear.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
      ENDIF.
    ENDIF.
* End of Note 1093945

* determine curtp recherche
    LOOP AT lt_sel INTO ls_sel
      WHERE field = 'CURTP'.
      ld_curtp = ls_sel-low.
      DELETE lt_sel.
    ENDLOOP.
    IF sy-subrc = 0.
      IF ld_curtp NE '00'.
        LOOP AT lt_sel INTO ls_sel
          WHERE field = 'WAERS'.
          DELETE lt_sel.
        ENDLOOP.
        ld_variant = lc_variant_s_lc.
      ELSE.
        ld_variant = lc_variant_s_fc.
      ENDIF.
      CLEAR ls_sel.
      ls_sel-field = 'PA_VARI'.
      ls_sel-sign    = 'I'.
      ls_sel-option  = 'EQ'.
      ls_sel-low     = ld_variant.
      APPEND ls_sel TO lt_sel.
    ENDIF.

    LOOP AT lt_sel INTO ls_sel.
* determine relevant ledger
      IF ls_sel-field = 'RLDNR'.
        CLEAR lt_selection.
        ld_rldnr = ls_sel-low.
        MOVE-CORRESPONDING ls_sel TO lt_selection.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
        DELETE lt_sel.
      ENDIF.
* determine D/C Indicator
      IF ls_sel-field = 'SHKZG'
      OR ls_sel-field = 'DRCRK'
      OR ls_sel-field = 'SO_SHKZG'.
        CLEAR lt_selection.
        ls_sel-field = 'SO_SHKZG'.
        MOVE-CORRESPONDING ls_sel TO lt_selection.
        lt_selection-fieldname = ls_sel-field.
        APPEND lt_selection.
        DELETE lt_sel.
      ENDIF.
      IF ls_sel-field = '&KKENNZAHL'.
        IF ls_sel-low = 'UMSOL'.
          CLEAR lt_selection.
          ls_sel-field = 'SO_SHKZG'.
          lt_selection-sign = 'I'.
          lt_selection-option = 'EQ'.
          lt_selection-low = 'S'.
          lt_selection-fieldname = ls_sel-field.
          APPEND lt_selection.
          DELETE lt_sel.
        ENDIF.
        IF ls_sel-low = 'UMHAB'.
          CLEAR lt_selection.
          ls_sel-field = 'SO_SHKZG'.
          lt_selection-sign = 'I'.
          lt_selection-option = 'EQ'.
          lt_selection-low = 'H'.
          lt_selection-fieldname = ls_sel-field.
          APPEND lt_selection.
          DELETE lt_sel.
        ENDIF.
      ENDIF.
    ENDLOOP.

*** Process SETS for Profit Center or Cost Element if given    "1417516
    LOOP AT lt_sel INTO ls_sel
      WHERE ( field = 'PRCTR' OR field = 'COST_ELEM' )
        AND type  = 'SET'.
      REFRESH lt_set_sel.
      CLEAR ls_set_sel.
      CLEAR setnr.
      setnr = ls_sel-low.
      CALL FUNCTION 'G_SET_GET_ALL_VALUES'
        EXPORTING
          setnr      = setnr
        TABLES
          set_values = lt_set_sel.
      IF sy-subrc = 0.
        DELETE lt_sel.
        LOOP AT lt_set_sel INTO ls_set_sel.
          ls_sel-sign = 'I'.
          ls_sel-option = 'BT'.
          ls_sel-low    = ls_set_sel-from.
          ls_sel-high   = ls_set_sel-to.
          ls_sel-hienm  = ls_set_sel-setnr.
          ls_sel-hclass = ls_set_sel-setclass.
          ls_sel-type   = ls_set_sel-setclass.
          IF ls_sel-low = ls_sel-high.
            CLEAR ls_sel-high.
            ls_sel-option = 'EQ'.
          ENDIF.
          APPEND ls_sel TO lt_sel.
        ENDLOOP.
      ENDIF.
    ENDLOOP.
*** Process SETS for Profit Center or Cost Element if given    "1417516
    IF ld_rldnr IS INITIAL.                       "begin "n1723146
      CLEAR ls_fields.
      READ TABLE lt_fields
        INTO ls_fields
        WITH KEY rfield = 'RLDNR'.
      IF sy-subrc <> 0.
        READ TABLE lt_fields
          INTO ls_fields
          WITH KEY rollname = 'RLDNR'.
        IF sy-subrc <> 0.
          READ TABLE lt_fields
            INTO ls_fields
            WITH KEY rollname = 'FAGL_RLDNR'.
        ENDIF.
      ENDIF.
      IF ls_fields IS NOT INITIAL.
        LOOP AT lt_sel
          INTO  ls_sel
          WHERE field = ls_fields-field.
          CLEAR lt_selection.
          ld_rldnr = ls_sel-low.
          MOVE-CORRESPONDING ls_sel TO lt_selection.
          lt_selection-fieldname = ls_sel-field.
          APPEND lt_selection.
          DELETE lt_sel.
        ENDLOOP.
      ENDIF.
    ENDIF.                                        "end "n1723146

* add fields to free selection
    IF NOT ld_rldnr IS INITIAL.
      PERFORM find_si_table
           USING    ld_rldnr
           CHANGING ld_si_table.
      gv_relevant_ledger = ld_rldnr.
      gv_si_table = ld_si_table.

* fields FlexGl
      CONCATENATE ld_si_table '_FS' INTO ld_tabname.

      CALL FUNCTION 'DDIF_NAMETAB_GET'
        EXPORTING
          tabname   = ld_tabname
        TABLES
          x031l_tab = lt_x031l_1
*         DFIES_TAB =
        EXCEPTIONS
          not_found = 1
          OTHERS    = 2.

      LOOP AT lt_x031l_1.
        LOOP AT lt_sel INTO ls_sel
          WHERE field = lt_x031l_1-fieldname.
          CLEAR lt_selection.
          MOVE-CORRESPONDING ls_sel TO lt_selection.
          lt_selection-fieldname = ls_sel-field.
          lt_selection-tablename = lt_x031l_1-tabname.
          APPEND lt_selection.
          DELETE lt_sel.
        ENDLOOP.
        IF sy-subrc <> 0.                         "begin "n1723146
          LOOP AT lt_fields
            INTO  ls_fields
            WHERE rollname = lt_x031l_1-rollname.
            LOOP AT lt_sel
              INTO  ls_sel
              WHERE field = ls_fields-field.
              CLEAR lt_selection.
              MOVE-CORRESPONDING ls_sel TO lt_selection.
              lt_selection-fieldname = ls_sel-field.
              lt_selection-tablename = lt_x031l_1-tabname.
              APPEND lt_selection.
              DELETE lt_sel.
            ENDLOOP.
          ENDLOOP.
        ENDIF.                                    "end "n1723146
      ENDLOOP.
    ELSE.
*     clear gv_relevant_ledger.
      x_erfs = 'X'.
    ENDIF.

* fields BSIS
    CALL FUNCTION 'DDIF_NAMETAB_GET'
      EXPORTING
        tabname   = 'BSIS_FS'
      TABLES
        x031l_tab = lt_x031l_2
*       DFIES_TAB =
      EXCEPTIONS
        not_found = 1
        OTHERS    = 2.

    CLEAR lt_selection.
    LOOP AT lt_x031l_2.
      LOOP AT lt_sel INTO ls_sel
        WHERE field = lt_x031l_2-fieldname.
        CLEAR lt_selection.
        MOVE-CORRESPONDING ls_sel TO lt_selection.
        lt_selection-fieldname = ls_sel-field.
        lt_selection-tablename = lt_x031l_2-tabname.
        APPEND lt_selection.
        DELETE lt_sel.
      ENDLOOP.
    ENDLOOP.

    CALL FUNCTION 'RSTI_REPORT_FIELDS_FIND'
      EXPORTING
        e_repid   = 'FAGL_ACCOUNT_ITEMS_GL'
        e_type    = 'R'
      TABLES
        it_fields = lt_fieldr.

* add rest of the fields
    CLEAR lt_selection.
    LOOP AT lt_sel INTO ls_sel.
      CLEAR lt_selection.
      MOVE-CORRESPONDING ls_sel TO lt_selection.
      lt_selection-fieldname = ls_sel-field.
      APPEND lt_selection.
    ENDLOOP.

    SORT lt_selection BY tablename fieldname.

* map rri selection to Report selections
    CLEAR lt_selection.
    LOOP AT lt_selection.
      AT NEW tablename.
        IF NOT lt_selection-tablename IS INITIAL.
          CLEAR ls_selopt.
          CLEAR ls_selopt_t.
          CLEAR ds_frange_tab_line.
          CLEAR ds_trange_tab_line.
        ENDIF.
      ENDAT.

      AT NEW fieldname.
        IF lt_selection-tablename IS INITIAL.
          LOOP AT lt_fieldr INTO ls_fieldr
            WHERE rfield = lt_selection-fieldname.
            EXIT.
          ENDLOOP.
          IF sy-subrc <> 0.                       "begin "n1723146
            READ TABLE lt_fields
              INTO ls_fields
              WITH KEY
                field = lt_selection-fieldname.
            IF  sy-subrc = 0
            AND ls_fields-field <> ls_fields-rfield.
              LOOP AT lt_fieldr INTO ls_fieldr
                WHERE rfield = ls_fields-rfield.
                EXIT.
              ENDLOOP.
            ENDIF.
          ENDIF.                                  "end "n1723146
          IF sy-subrc = 0.
            IF ls_fieldr-kind = 'S'.
              CONCATENATE ls_fieldr-rfield '[]'             "n1723146
                INTO ld_t_range_name.
              ASSIGN (ld_t_range_name) TO <wa2>.
            ENDIF.
          ELSE.
            CLEAR ls_fieldr.
            CLEAR ls_selopt.
            CLEAR ls_selopt_t.
            CLEAR ds_frange_tab_line.
          ENDIF.   "end xrp
        ELSE.
          CLEAR ls_fieldr.
          CLEAR ls_selopt.
          CLEAR ls_selopt_t.
          CLEAR ds_frange_tab_line.
        ENDIF.
      ENDAT.

      IF lt_selection-tablename IS INITIAL.
        IF ls_fieldr-kind = 'P'.
          ASSIGN (ls_fieldr-rfield) TO <wa1>.               "n1723146
          IF <wa1> IS ASSIGNED.                             "n1723146
            MOVE lt_selection-low TO <wa1>.
          ENDIF.                                            "n1723146
        ENDIF.
        IF ls_fieldr-kind = 'S'.
          ASSIGN (ls_fieldr-rfield) TO <wa1>.               "n1723146
          IF  <wa1> IS ASSIGNED                             "n1723146
          AND <wa2> IS ASSIGNED.                            "n1723146
            MOVE-CORRESPONDING lt_selection TO <wa1>.
            APPEND <wa1> TO <wa2>.
          ENDIF.                                            "n1723146
        ENDIF.
      ENDIF.
      IF lt_selection-tablename = 'BSIS_FS'
      OR ( lt_selection-tablename = ld_tabname
      AND NOT ld_tabname IS INITIAL ).
        MOVE-CORRESPONDING lt_selection TO ls_selopt.
        APPEND ls_selopt TO ls_selopt_t.
      ENDIF.

      AT END OF fieldname.
        IF NOT lt_selection-tablename IS INITIAL.
          ds_frange_tab_line-fieldname = lt_selection-fieldname.
          ds_frange_tab_line-selopt_t[] = ls_selopt_t[].
          APPEND ds_frange_tab_line TO ds_trange_tab_line-frange_t.
        ENDIF.
      ENDAT.

      AT END OF tablename.
        IF NOT lt_selection-tablename IS INITIAL.
          ds_trange_tab_line-tablename = lt_selection-tablename.
          APPEND ds_trange_tab_line TO fs_dyns-trange.
        ENDIF.
      ENDAT.
    ENDLOOP.

    IF gd_rri_so_set = 'X'.                                 "1093945
      EXPORT so_yrper TO MEMORY ID 'FAGLL03_SO_YRPER'.      "1093945
    ENDIF.                                                  "1093945

    CALL FUNCTION 'FREE_SELECTIONS_RANGE_2_EX'
      EXPORTING
        field_ranges = fs_dyns-trange
      IMPORTING
        expressions  = fs_dyns-texpr.

    CALL FUNCTION 'FREE_SELECTIONS_RANGE_2_WHERE'
      EXPORTING
        field_ranges  = fs_dyns-trange
      IMPORTING
        where_clauses = fs_dyns-clauses.

  ELSE.
    IF rri_subrc = 2.
      CALL FUNCTION 'RSTI_APPL_STACK_INITIALIZE'
        EXPORTING
          e_tool = a_rec-rtool
          e_onam = a_rec-ronam.
    ENDIF.
  ENDIF.
ENDFORM.                    " init_rri_data
*&---------------------------------------------------------------------*
*&      Form  get_free_selections
*&---------------------------------------------------------------------*
*       Transfer free selections
*       normally used for extrenal callers like item display module
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_free_selections CHANGING
                          p_fs_dyns TYPE rsds_type.
  p_fs_dyns = fs_dyns.
ENDFORM.                    "get_free_selections

*&---------------------------------------------------------------------*
*&      Form  check_acc_for_trm                                "1004374
*&---------------------------------------------------------------------*
*       Special check for the items only in non-leading Leader
*       with an 'open item' or 'line item' managed account     "1052688
*----------------------------------------------------------------------*
FORM check_trtm_account.
  DATA: ls_tablenames TYPE fagl_tabnames,
        ld_counter    TYPE i.

  IF NOT gv_relevant_ledger IS INITIAL.
    IF  gv_relevant_ledger NE gv_leading_ledger
    AND ( skb1-xopvw = 'X' OR skb1-xkres = 'X' ).           "1052688
      CALL FUNCTION 'FAGL_GET_TABLENAMES'
        EXPORTING
          i_ledger    = gv_relevant_ledger
        IMPORTING
          es_tabnames = ls_tablenames.

      SELECT COUNT( * ) FROM (ls_tablenames-tot_table) INTO ld_counter
                    UP TO 1 ROWS
                    WHERE racct  = skb1-saknr
                      AND rbukrs = skb1-bukrs
                      AND rldnr  = gv_relevant_ledger
      AND awtyp  = 'TR-TM'.
      IF ld_counter = 1.
        gv_special_account = 'X'.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    " check_trtm_account               "1004374

*&---------------------------------------------------------------------*
*&      Form  check_glyec_account
*&---------------------------------------------------------------------*
*       Special check for whether the selection should be switched
*       so the GLYEC postings are also selected
*----------------------------------------------------------------------*
FORM check_glyec_account.
  DATA: ls_tablenames TYPE fagl_tabnames,
        ld_counter    TYPE i.

  IF NOT gv_relevant_ledger IS INITIAL.
*   Check the selection screen field, which is only visible with the
*   related switch active (FAGL_FIN_GL_CP_RS)
    IF NOT x_glyec IS INITIAL.
      CALL FUNCTION 'FAGL_GET_TABLENAMES'
        EXPORTING
          i_ledger    = gv_relevant_ledger
        IMPORTING
          es_tabnames = ls_tablenames.

      SELECT COUNT( * ) FROM (ls_tablenames-tot_table) INTO ld_counter
                    UP TO 1 ROWS
                    WHERE racct  = skb1-saknr
                      AND rbukrs = skb1-bukrs
                      AND rldnr  = gv_relevant_ledger
      AND awtyp = 'GLYEC'.
      IF ld_counter = 1.
        gv_special_account = 'X'.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    " check_glyec_account

INCLUDE fagl_account_items_deco.
*&---------------------------------------------------------------------*
*&      Form  CHECK_SELECTIONS
*&---------------------------------------------------------------------*
*       Check if the number of selections is not large. (note 1578577)
*----------------------------------------------------------------------*
*      -->P_GT_SELECTION_PART  text
*----------------------------------------------------------------------*
FORM check_selections  USING    p_gt_selection_part.

* data declaration
  DATA: lt_selection_check TYPE gusl_t_selection,
        ls_selection_check TYPE gusl_s_selection,
        ld_num             TYPE i.
  CONSTANTS:  ld_nummax TYPE i VALUE 500.

  lt_selection_check[] = p_gt_selection_part.

  LOOP AT lt_selection_check INTO ls_selection_check.
    DESCRIBE TABLE ls_selection_check-t_range LINES ld_num.
    IF ld_num > ld_nummax.
      MESSAGE e123.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " CHECK_SELECTIONS
*&---------------------------------------------------------------------*
*&      Form  F_WRITE_FILE_TO_APP_SERVER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->IT_POS  text
*      -->P_APPL  text
*----------------------------------------------------------------------*
FORM f_write_file_to_app_server  TABLES   lt_pos TYPE faglposx_t
                                 USING    iv_filepath TYPE any.
  DATA lt_fldnames TYPE dfies_tab.
  DATA lw_fldnames TYPE dfies.
  FIELD-SYMBOLS <lfs_val> TYPE any.

  FIELD-SYMBOLS : <lfs_faglposx> TYPE faglposx.

  DATA:lv_value(100) TYPE c,
       lv_output     TYPE string.

  DATA:lv_record(5000) TYPE c.
  DATA:lv_length TYPE i.

  CALL FUNCTION 'DDIF_FIELDINFO_GET'
    EXPORTING
      tabname        = 'FAGLPOSX'
    TABLES
      dfies_tab      = lt_fldnames
    EXCEPTIONS
      not_found      = 1
      internal_error = 2
      OTHERS         = 3.
  IF sy-subrc = 0.
**==================Changes commemented by yatindra/Sushil as per discussion on 30.11.2018===============**
**    PERFORM sort_remove_fields TABLES lt_fldnames
**                    USING pa_vari 'FAGLPOSX'.
**==================Changes commemented by yatindra/Sushil as per discussion on 30.11.2018===============**
  ENDIF.

  OPEN DATASET iv_filepath FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc = 0.
    CONCATENATE 'File' iv_filepath 'successfully generated' INTO lv_output
                SEPARATED BY space.
    WRITE lv_output.
    MESSAGE lv_output TYPE 'S'.
*Write Header Texts at the begining of the file
    LOOP AT lt_fldnames INTO lw_fldnames.

      IF lw_fldnames-scrtext_s IS NOT INITIAL.
        lv_value = lw_fldnames-scrtext_s.  "Short Text from DataElement
      ELSEIF lw_fldnames-scrtext_m IS NOT INITIAL.
        lv_value = lw_fldnames-scrtext_m.  "Medium Text from DataElement
      ELSEIF lw_fldnames-reptext IS NOT INITIAL.
        lv_value = lw_fldnames-reptext.    "Heading Text from DataElement
      ELSEIF lw_fldnames-scrtext_l IS NOT INITIAL.
        lv_value = lw_fldnames-scrtext_l.  "Long Text from DataElement
      ELSEIF lw_fldnames-fieldname IS NOT INITIAL.
        lv_value = lw_fldnames-fieldname.
      ENDIF.
      CONDENSE lv_value.
      CONCATENATE  lv_record
                   lv_value
                  INTO lv_record
                  SEPARATED BY cl_abap_char_utilities=>horizontal_tab.

      AT LAST.
        lv_length = strlen( lv_record ).
        TRANSFER lv_record TO iv_filepath LENGTH lv_length.
      ENDAT.
      CLEAR lv_value.
    ENDLOOP.
    CLEAR : lv_record, lv_length.
*Write Data into the File
    LOOP AT lt_pos ASSIGNING <lfs_faglposx>.
      LOOP AT lt_fldnames INTO lw_fldnames.
        ASSIGN COMPONENT lw_fldnames-fieldname OF STRUCTURE <lfs_faglposx> TO <lfs_val>.

        CASE lw_fldnames-domname.
          WHEN 'PS_PSPNR'.
            CALL FUNCTION 'CONVERSION_EXIT_KONPD_OUTPUT'
              EXPORTING
                input  = <lfs_val>
              IMPORTING
                output = lv_value.
          WHEN OTHERS.
            WRITE <lfs_val> TO lv_value.
        ENDCASE.
        CONDENSE lv_value.

        IF lw_fldnames-datatype = 'CURR'.
          CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
            CHANGING
              value = lv_value.
        ENDIF.

        CONCATENATE  lv_record
                     lv_value
                    INTO lv_record
                    SEPARATED BY cl_abap_char_utilities=>horizontal_tab.
      ENDLOOP.
      lv_length = strlen( lv_record ).
      TRANSFER lv_record TO iv_filepath LENGTH lv_length.
      CLEAR : lv_record, lv_length.
    ENDLOOP.
    CLOSE DATASET iv_filepath.
  ELSE.
    CONCATENATE 'Error while opening file' iv_filepath INTO lv_output.
    WRITE lv_output.
    MESSAGE lv_output TYPE 'S'.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  F_UPDATE_CUSTOM_TAB
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_IT_POS_TMP  text
*----------------------------------------------------------------------*
FORM f_update_custom_tab.
  DATA lv_runid TYPE zde_runid.
  DATA lv_lines TYPE string.
  DATA lv_msg TYPE char100.

  SELECT SINGLE runid INTO lv_runid FROM zfi_fagll03
  WHERE runid EQ p_runid.
  IF sy-subrc EQ 0.
    DELETE FROM zfi_fagll03 WHERE runid = p_runid.
    IF sy-subrc = 0.
      MODIFY zfi_fagll03 FROM TABLE it_pos_tmp.
      IF sy-subrc = 0.
        DESCRIBE TABLE it_pos_tmp LINES lv_lines.
        CONCATENATE lv_lines
                    'Records successfully updated in table ZFI_FAGLL03'
                    INTO lv_msg SEPARATED BY space.
        MESSAGE lv_msg TYPE 'S'.
      ELSE.

        MESSAGE 'Records are not updated in table ZFI_FAGLL03' TYPE 'S'.
      ENDIF.
    ENDIF.
  ELSE.
    MODIFY zfi_fagll03 FROM TABLE it_pos_tmp." ACCEPTING DUPLICATE KEYS.
    IF sy-subrc = 0.
      DESCRIBE TABLE it_pos_tmp LINES lv_lines.
      CONCATENATE lv_lines
                  'Records successfully updated in table ZFI_FAGLL03'
                  INTO lv_msg SEPARATED BY space.
      MESSAGE lv_msg TYPE 'S'.
    ELSE.

      MESSAGE 'Records are not updated in table ZFI_FAGLL03' TYPE 'S'.
    ENDIF.
  ENDIF.

ENDFORM.
**==================Changes commemented by yatindra/Sushil as per discussion on 30.11.2018===============**
****&---------------------------------------------------------------------*
****&      Form  F_UPDATE_CUSTOM_TAB
****&---------------------------------------------------------------------*
****       text
****----------------------------------------------------------------------*
****      -->LT_DFIES  text
****----------------------------------------------------------------------*
***FORM sort_remove_fields  TABLES   lt_dfies TYPE dfies_tab
***                         USING    lv_layo  TYPE disvariant-variant
***                                  lv_struc TYPE dd02l-tabname.
***  DATA: lt_fieldcat TYPE slis_t_fieldcat_alv,
***        ls_fieldcat TYPE slis_fieldcat_alv,
***        lt_fcat     TYPE lvc_t_fcat,
***        ls_fcat     TYPE lvc_s_fcat,
***        lt_dfies_t  TYPE dfies_tab,
***        ls_dfies    TYPE dfies,
***        ls_variant  TYPE disvariant,
***        lv_repid    TYPE sy-repid.
***  IF NOT lv_layo IS INITIAL.
***    lv_repid = sy-repid.
***    CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
***      EXPORTING
***        i_program_name         = lv_repid
***        i_structure_name       = lv_struc
***        i_client_never_display = 'X'
***      CHANGING
***        ct_fieldcat            = lt_fieldcat[]
***      EXCEPTIONS
***        inconsistent_interface = 1
***        program_error          = 2
***        OTHERS                 = 3.
***
***    ls_variant-report = 'FAGL_ACCOUNT_ITEMS_GL'.
***    ls_variant-variant = lv_layo.
***
***    LOOP AT lt_fieldcat INTO ls_fieldcat.
***      MOVE-CORRESPONDING ls_fieldcat TO ls_fcat.
***      APPEND ls_fcat TO lt_fcat. CLEAR ls_fcat.
***    ENDLOOP.
***    FREE: lt_fieldcat.
***
***    CALL FUNCTION 'LVC_VARIANT_SELECT'
***      EXPORTING
***        i_dialog            = ' '
***        i_user_specific     = 'X'
***        i_default           = 'X'
***        it_default_fieldcat = lt_fcat
***      IMPORTING
***        et_fieldcat         = lt_fcat
***      CHANGING
***        cs_variant          = ls_variant
***      EXCEPTIONS
***        wrong_input         = 1
***        fc_not_complete     = 2
***        not_found           = 3
***        program_error       = 4
***        data_missing        = 5
***        OTHERS              = 6.
***    DELETE lt_fcat WHERE no_out = 'X'.
***    IF NOT lt_fcat[] IS INITIAL.
***      SORT: lt_fcat BY col_pos,
***            lt_dfies BY fieldname.
***      LOOP AT lt_fcat INTO ls_fcat.
***        READ TABLE lt_dfies INTO ls_dfies WITH KEY fieldname = ls_fcat-fieldname
***                                  BINARY SEARCH.
***        IF sy-subrc = 0.
***          APPEND ls_dfies TO lt_dfies_t.
***        ENDIF.
***      ENDLOOP.
***      FREE: lt_dfies. lt_dfies[] = lt_dfies_t[]. FREE: lt_dfies_t.
***    ENDIF.
***  ENDIF.
***ENDFORM.
**==================Changes commemented by yatindra/Sushil as per discussion on 30.11.2018===============**
*&---------------------------------------------------------------------*
*&      Form  F_UPDATE_BI_TAB
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM f_update_bi_tab .
  DATA lv_runid TYPE zde_runid.
  DATA lv_lines TYPE string.
  DATA lv_msg TYPE char100.

  SELECT SINGLE runid INTO lv_runid FROM zfi_fagll03_bi
  WHERE runid EQ p_runid.
  IF sy-subrc EQ 0.
    DELETE FROM zfi_fagll03_bi WHERE runid = p_runid.
    IF sy-subrc = 0.
      MODIFY zfi_fagll03_bi FROM TABLE it_pos_tmp.
      IF sy-subrc = 0.
        DESCRIBE TABLE it_pos_tmp LINES lv_lines.
        CONCATENATE lv_lines TEXT-023 INTO lv_msg SEPARATED BY space.
        MESSAGE lv_msg TYPE 'S'.
      ELSE.
        MESSAGE TEXT-021 TYPE 'S'.
      ENDIF.
    ENDIF.
  ELSE.
    MODIFY zfi_fagll03_bi FROM TABLE it_pos_tmp." ACCEPTING DUPLICATE KEYS.
    IF sy-subrc = 0.
      DESCRIBE TABLE it_pos_tmp LINES lv_lines.
      CONCATENATE lv_lines TEXT-023 INTO lv_msg SEPARATED BY space.
      MESSAGE lv_msg TYPE 'S'.
    ELSE.
      MESSAGE TEXT-022 TYPE 'S'.
    ENDIF.
  ENDIF.
ENDFORM.
